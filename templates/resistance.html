<!DOCTYPE html>
<html lang="$$LANG$$">
<head>
  <title>$$resistance-title$$</title>
  <meta name="description" content="$$resistance-desc$$">
  <link rel="alternate" hreflang="en" href="$$ROOT_HREF$$/en/resistance.html">
  <link rel="alternate" hreflang="de" href="$$ROOT_HREF$$/de/resistance.html">
  <link rel="alternate" hreflang="fr" href="$$ROOT_HREF$$/fr/resistance.html">
  <link rel="alternate" hreflang="es" href="$$ROOT_HREF$$/es/resistance.html">
  <link rel="alternate" hreflang="it" href="$$ROOT_HREF$$/it/resistance.html">
  <link rel="alternate" hreflang="pt" href="$$ROOT_HREF$$/pt/resistance.html">
  <link rel="alternate" hreflang="x-default" href="$$ROOT_HREF$$/en/resistance.html">
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-RegularItalic.woff2" as="font" type="font/woff2">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-Regular.woff2" as="font" type="font/woff2">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-Semibold.woff2" as="font" type="font/woff2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="/static/css/leaflet.css" rel="stylesheet" type="text/css"/>
  <script src="/static/js/leaflet.js" type="application/javascript"></script>
  <script src="/static/js/qrcode.min.js" type="application/javascript"></script>
  <link href="/static/css/maplibre-gl.css" rel="stylesheet" type="text/css"/>
  <script src="/static/js/maplibre-gl.js" type="application/javascript"></script>
  <script src="/static/js/leaflet-maplibre-gl.js" type="application/javascript"></script>
  <script src="/static/js/geotz.js" type="application/javascript"></script>

  <style>
    :root {
      --background-color: #f5f5f5;
      --text-color: #333;
      --panel-bg: rgba(255, 255, 255);
      --panel-text: #333;
      --atmospheric-color: #ccc;
      --search-bg: white;
      --search-text: #333;
      --search-placeholder: #999;
      --search-results-bg: white;
      --search-results-hover: #f0f0f0;
      --link-color: #8b0000;
      --focus-col: rgb(61, 99, 170);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #121212;
        --text-color: #f5f5f5;
        --panel-bg: rgba(33, 33, 33);
        --panel-text: #f5f5f5;
        --atmospheric-color: #3a228a;
        --search-bg: #333;
        --search-text: #f5f5f5;
        --search-placeholder: #777;
        --search-results-bg: #333;
        --search-results-hover: #444;
        --link-color: #ff6b6b;
      }
    }
    
    * {
        margin: 0px;
        padding: 0px;
    }

    html {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: var(--background-color);
      font-family: Arial, sans-serif;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      height: 100%;
    }
    
    #mapContainer {
        position: absolute;
        height: 100%;
        width: 100%;
        z-index: 1;
    }
    
    .search-container {
      display: flex;
      justify-content: space-between;
      flex-direction: column;
      z-index: 1;
      flex-grow: 1;
    }

    #priestInfo {
        display: flex;
        flex-direction: column;
    }

    .search-input {
        font-family: 'UnifrakturMaguntia';
        font-weight: bold;
        padding: 10px 5px;
        font-style: italic;
        border: none;
        background: var(--search-bg);
        color: var(--search-text);
        font-size: 1.2rem;
        outline: none;
        border: 3px solid var(--search-bg);
        pointer-events: all;
        margin-top: 10px;
    }
    
    @media screen and (max-width: 450px) {
        .search-input, .sidebar-links, .search-container .links, .info-panel {
          margin: 0px 10px;
        }
        .info-panel {
          margin-bottom: 10px;
        }
        .search-input {
          margin-top: 5px;
          margin-bottom: 5px;
          padding: 5px;
        }
        .calendar-grid {
          gap: 2px;
          margin-bottom: 10px;
        }
        .calendar-day {
          border: none;
        }
        .calendar-day {
          padding: 5px;
        }
        .calendar-day-header {
          padding: 2px;
        }
        .calendar-title {
          hyphens: auto;
          word-break: break-all;
        }
        .calendar-popup {
          border-radius: 0px;
          overflow-y: scroll;
        }
        .calendar-day.has-events::after {
          bottom: 1px;
        }
        .calendar-bottom {
          padding: 0px 10px;
        }
        .calendar-top {
          padding: 20px 10px;
        }
    }
    .search-input:focus {
        border: 3px solid var(--focus-col);
    }

    .search-input::placeholder {
      color: var(--search-placeholder);
    }

    .location-btn {
        padding: 10px;
        border: 3px solid var(--search-bg);
        background: var(--search-bg);
        color: var(--search-text);
        font-size: 1.2rem;
        cursor: pointer;
        margin-left: -3px;
        margin-top: 10px;
    }
    .location-btn:hover {
      background-color: var(--search-results-hover);
    }
    .location-btn:focus {
        border: 3px solid var(--focus-col);
        outline: none;
    }
    
    .search-results {
        font-family: 'UnifrakturMaguntia';
        font-weight: bold;
        font-style: italic;
        overflow-y: scroll;
        background: var(--search-results-bg);
        border-radius: 0 0 5px 5px;
        z-index: 11;
        pointer-events: all;
        max-height: 200px;
        flex-direction: column;
        overflow-y: scroll;
    }
    
    .search-result-item {
      padding: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 3px solid transparent;
      font-size: 1.2rem;
    }
    
    .search-result-item:focus {
        border: 3px solid var(--focus-col);
        background-color: var(--search-results-hover);
    }
    
    .search-result-item:hover {
      background-color: var(--search-results-hover);
    }

    .info-panel {
        margin-bottom: 10px;
        box-shadow: 2.5px 2.5px 5px black;
        pointer-events: all;
        position: relative;
        background: white;
        padding: 20px;
        max-height: 70vh;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        flex-direction: column;
        flex-grow: 0;
        background: var(--panel-bg);
        color: var(--panel-text);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        font-family: 'Times';
        font-style: italic;
        font-size: 1.2rem;
    }
    
    .info-panel h2 {
        margin-top: 0;
        font-size: 2rem;
        font-weight: bold;
    }
    
    .info-row {
        margin-bottom: 4px;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
    }
    
    /* Add these styles to your existing CSS */
    .notes-section, .mass-times-section {
      padding-top: 8px;
    }

    .notes-section strong, .mass-times-section strong {
      display: inline;
      padding-right: 5px;
    }

    .notes-section p, .mass-times-section p {
      display: inline;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .mass-times-section {
      color: #8b0000;
      font-weight: 500;
    }

    @media (prefers-color-scheme: dark) {
      .notes-section, .mass-times-section {
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .mass-times-section {
        color: #ff6b6b;
      }
    }

    /* Make title more prominent */
    #priestName {
      font-family: 'UnifrakturMaguntia', serif;
      font-size: 2.5rem;
    }

    .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        background: #cc0000;
        font-size: 2rem;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }
    .info-link {
      background: #004970;
      color: white;
      font-weight: bold;
      text-decoration: underline;
    }
    .info-link.maps {
        background: #700000;
        color: white;
        padding: 10px;
        font-weight: bold;
        font-style: normal;
        font-family: sans-serif;
        margin-top: 1rem;
        text-decoration: none;
        display: block;
        text-align: center;
    }
    
    .info-link.maps:hover {
      text-decoration: underline;
    }

  .parishes-section h3 {
    margin-top: 0;
    font-size: 1.3rem;
  }

  .parishes-list {
    list-style-type: none;
    padding-left: 0;
    margin-top: 5px;
    max-height: 150px;
    overflow-y: scroll;
  }

  @media (prefers-color-scheme: dark) {
    .parishes-section {
      border-top: 1px solid rgba(255,255,255,0.1);
    }
  }

  .priest-link {
      color: var(--link-color);
      text-decoration: underline;
      cursor: pointer;
      margin-top: 5px;
      display: inline-block;
    }
    
    .priest-link:hover {
      text-decoration: none;
    }
    
    .parish-item {
      cursor: pointer;
      transition: background-color 0.2s;
      padding: 4px;
      margin-bottom: 2px;
    }
    
    .parish-item strong {
      text-decoration: underline;
    }

    .parish-item:hover {
      background-color: rgba(128, 128, 128, 0.1);
      border-radius: 3px;
    }

    .links {
      display: flex;
      flex-direction: row;
      z-index: 1000;
      margin-top: 10px;
    }

    .outbound-link, .outbound-link:visited, .outbound-link:focus, .outbound-link:hover {
      color: white;
      font-size: 1rem;
      background-color: black;
      margin-right: 10px;
      padding: 5px;
      text-decoration: none;
      pointer-events: all;
    }

    @media (max-width: 800px) {
      .title {
        display: none;
      }
      
      .links {
        width: 100%;
        display: flex;
        flex-grow: 1;
      }
      .links > div {
        flex-direction: row;
        display: flex;
        flex-grow: 0;
      }
      .links > div > a {
        margin-top: 5px;
        flex-grow: 1;
        display: flex;
      }

      .info-panel {
        max-height: 60vh;
        font-size: 0.9rem;
      }
      #priestName {
        font-size: 1.4rem;
      }
      .search-input {
        font-size: 1.2rem;
      }
      .search-results, .search-result-item {
        font-size: 1.2rem;
      }
      .outbound-link, .outbound-link:visited, .outbound-link:focus, .outbound-link:hover {
        font-size: 1rem;
      }
      #priestInfo {
        font-size: 1rem;
      }
    }

    /* Import the same fonts as dubia.cc */
    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 400;
      font-style: normal;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-Regular.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }

    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 400;
      font-style: italic;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-RegularItalic.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }

    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 600;
      font-style: normal;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-Semibold.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }

    @font-face {
      font-family: 'Kanzlei Initialen';
      src: url('/static/font/kanzlei/Kanzlei-Initialen-D.ttf') format('truetype');
      font-display: swap;
      unicode-range: U+0044;
    }

    :root {
      --GW-serif-font-stack: "Source Serif Pro", "Apple Garamond", "Baskerville", "Libre Baskerville", "Droid Serif", "Times New Roman", "Times", serif;
      --GW-sans-serif-font-stack: "Lucida Sans Unicode", "Helvetica", "Trebuchet MS", sans-serif;
      --GW-monospaced-font-stack: "IBM Plex Mono", "Liberation Mono", "Consolas", "Courier", monospace;
    }

    /* Compact header styles */
    #header {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      justify-content: space-between;
      max-width: 450px;
      z-index: 1000;
      pointer-events: none;
    }

    @media screen and (min-width: 450px) {
        #header {
          min-width: 450px;
        }
    }

    .title {
      font-family: 'UnifrakturMaguntia', serif;
      font-size: 2.5rem;
      color: var(--background-color);
      text-align: center;
      background: var(--text-color);
      mix-blend-mode: difference;
      width: 100%;
      text-align: center;
      font-family: 'UnifrakturMaguntia', serif;
      z-index: 1000;
      padding: 10px 0px;
      margin-bottom: 10px;
    }

    #sidebar {
      display: flex;
      justify-content: center;
      flex-direction: column;
      margin-top: 10px;
    }

    #sidebar a {
      display: block;
      border: 1px dotted currentColor;
      text-align: center;
      margin: 0 2px;
      color: var(--text-color);
      text-decoration: none;
      font-family: var(--GW-serif-font-stack);
    }

    #sidebar a.logo {
      display: flex;
      align-items: center;
      margin: 1px 0;
      background-color: var(--background-color);
    }

    #sidebar .sidebar-links {
      flex: 1 1 100%;
      display: flex;
      flex-flow: row wrap;
      pointer-events: initial;
    }

    #sidebar .sidebar-links > a {
        pointer-events: initial;
    }

    #sidebar .sidebar-links > * {
      font-variant-caps: small-caps;
      background: var(--background-color);
      align-content: center;
      justify-content: center;
      flex: 1;
      padding: 5px;
      pointer-events: initial;
      cursor: pointer;
    }

    /* Make the header more compact on mobile */
    @media all and (max-width: 649px) {
      .title {
        font-size: 1.8rem;
      }
      
      #sidebar .sidebar-links a {
        padding: 3px 5px;
        font-size: 0.9rem;
      }
    }

    /* Map-specific styles */
    .leaflet-popup-content {
      font-family: 'Source Serif Pro', serif;
      font-size: 1rem;
    }
    
    .priest-marker {
      background-color: #003399;  /* Blue for priests */
      border-radius: 50%;
      border: 2px solid white;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .parish-marker {
      background-color: #cc0000;  /* Red for parishes */
      border-radius: 50%;
      border: 2px solid white;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    /* For the pulsing effect */
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(204, 0, 0, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(204, 0, 0, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(204, 0, 0, 0);
      }
    }

    /* For dark mode maps */
    .dark-map .leaflet-tile {
      filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }
    
    .dark-map .leaflet-container {
      background: #303030;
    }
    
    @font-face {
      font-family: 'UnifrakturMaguntia';
      font-style: normal;
      font-weight: 400;
      src: url('/static/font/unifraktur/UnifrakturMaguntia-Regular.ttf') format('ttf');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      font-display: swap;
    }


      .calendar-export-buttons {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
        justify-content: center;
      }

      .calendar-export-buttons .action-btn {
        background: #700000;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: bold;
        flex: 1;
        min-width: 120px;
        transition: background-color 0.2s;
      }

      .calendar-export-buttons .action-btn:hover {
        background: #900000;
      }

      .calendar-bottom {
        display: flex;
        flex: 1;
        flex-direction: column;
        justify-content: flex-start;
        overflow-y: scroll;
        padding-bottom: 20px;
      }

    .calendar-btn {
      background: #437700;
      color: white;
      padding: 10px;
      font-weight: bold;
      font-style: normal;
      font-family: sans-serif;
      margin-top: 0.5rem;
      text-decoration: none;
      display: block;
      text-align: center;
      cursor: pointer;
    }

    .calendar-btn:hover {
      background: #5a9900;
    }

    .calendar-popup {
      position: absolute;
      flex-grow: 1;
      justify-content: center;
      background: var(--panel-bg);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow-y: auto;
      flex-direction: column;
      display: none;
      min-height: 100%;
      padding: 0px 20px;
      justify-content: flex-start;
      max-width: 410px;
      border-radius: 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .calendar-top {
      display: flex;
      flex: 0;
      flex-direction: column;
      padding: 20px 0px;
    }

    .calendar-bottom {
      display: flex;
      flex: 1;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: scroll;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 5px;
    }

    .calendar-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .calendar-close {
      background: #cc0000;
      color: white;
      width: 2.5rem;
      font-weight: bold;
      border: none;
      font-size: 2rem;
      cursor: pointer;
    }

    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .calendar-nav button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
    }

    .calendar-month-year {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 15px;
    }

    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      padding: 5px 0;
    }

    .calendar-day {
      text-align: center;
      padding: 10px 5px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      position: relative;
      cursor: pointer;
    }

    .calendar-day.has-events {
      position: relative;
      z-index: 1000;
      pointer-events: all !important;
    }

    .calendar-day:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .calendar-day.has-events::after {
      content: "";
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #1e88e5;
    }

    .calendar-day.other-month {
      color: rgba(128, 128, 128, 0.5);
    }

    .calendar-event {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      background-color: rgba(0, 0, 0, 0.05);
    }

    .calendar-event.cancelled {
      text-decoration: line-through;
      color: gray;
    }

    .calendar-event-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .calendar-event-time {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .calendar-event-location {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .calendar-event-priest {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .calendar-event-notes {
      font-style: italic;
      font-size: 0.9rem;
    }

    .calendar-event-cancelled {
      color: #cc0000;
      font-weight: bold;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .donate-link {
      background: #cc7700;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 0.9rem;
      display: inline-block;
      margin-top: 5px;
    }

    .donate-link:hover {
      background: #ff9900;
    }

    .show-more-btn {
      background: #004970;
      color: white;
      padding: 10px;
      font-weight: bold;
      font-style: normal;
      font-family: sans-serif;
      margin-top: 0.5rem;
      text-decoration: none;
      display: block;
      text-align: center;
      cursor: pointer;
    }

    .show-more-btn:hover {
      background: #006699;
    }

    /* Updated styling for the UI improvements */

/* Action buttons container */
.actions-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 16px;
  width: 100%;
}

/* Action button styles */
.action-btn {
  background: #700000;
  color: white;
  padding: 10px;
  font-weight: bold;
  font-style: normal;
  font-family: sans-serif;
  text-decoration: none;
  display: inline-block;
  text-align: center;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  flex-grow: 1;
  min-width: calc(50% - 8px);
  font-size: 0.9rem;
}

.action-btn:hover {
  background: #900000;
}

/* Donate button specific styling */
.donate-btn {
  background: #cc7700;
}

.donate-btn:hover {
  background: #ff9900;
}

/* Improve info panel */
.info-panel {
  max-width: 450px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  overflow: hidden;
}

/* Fix search results display */
.search-results {
  width: 100%;
  max-height: 250px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.search-result-item {
  padding: 12px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.search-result-item:hover, .search-result-item:focus {
  background-color: rgba(112, 0, 0, 0.1);
  outline: none;
}

/* Parishes section formatting */
.parishes-section {
  padding-top: 8px;
}

.parishes-list {
  max-height: 180px;
  overflow-y: auto;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 4px;
}

.parish-item:hover {
  background-color: rgba(112, 0, 0, 0.1);
}

/* Consistent font size */
#priestName {
  font-family: 'Source Serif Pro', serif;
  font-size: 1.8rem;
  font-weight: bold;
}

/* Improve close button */
.close-btn {
  font-size: 1.5rem;
  width: 36px;
  height: 36px;
  background: #700000;
  color: white;
  border-radius: 50%;
  top: 12px;
  right: 12px;
}

@media (max-width: 800px) {
  .info-panel {
    max-height: 70vh;
  }
  
  .calendar-popup {
    max-width: none;
  }

  .action-btn {
    font-size: 0.85rem;
    padding: 8px;
  }
  
  #priestName {
    font-size: 1.5rem;
  }
}

/* Fix outbound links display based on search visibility */
.search-container:has(.search-results[style*="display: flex"]) .links {
  display: none;
}

/* Priest and parish markers hover effect */
.parish-marker, .priest-marker {
  transition: transform 0.2s ease;
}

.parish-marker:hover, .priest-marker:hover {
  transform: scale(1.2);
}

/* Make the calendar grid more attractive */
.calendar-grid {
  border-radius: 4px;
  overflow: hidden;
  background: rgba(0, 0, 0, 0.03);
}

.calendar-day-header {
  background: #700000;
  color: white;
  padding: 8px;
}

.calendar-day {
  transition: all 0.2s ease;
}

.calendar-day:hover {
  background: rgba(112, 0, 0, 0.1);
}

.calendar-day.has-events {
  font-weight: bold;
  color: #700000;
}

/* Improved action buttons container */
.actions-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 16px;
  width: 100%;
}

/* Action button styles */
.action-btn {
  background: #700000;
  color: white;
  padding: 10px;
  font-weight: bold;
  font-style: normal;
  font-family: sans-serif;
  text-decoration: none;
  display: inline-block;
  text-align: center;
  cursor: pointer;
  border: none;
  border-radius: 4px;
  font-size: 0.9rem;
}

.action-btn:hover {
  background: #900000;
}

/* Donate button specific styling */
.donate-btn {
  background: #cc7700;
}

.donate-btn:hover {
  background: #ff9900;
}

/* Improved search results */
.search-results {
  max-height: 250px;
  width: 100%;
  border: 1px solid rgba(0, 0, 0, 0.1);
  overflow-y: auto;
  background: var(--search-results-bg);
  border-radius: 0 0 5px 5px;
  z-index: 11;
  pointer-events: all;
  flex-direction: column;
}

.search-result-item {
  padding: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  font-size: 1rem;
}

.search-result-item small {
  color: #666;
  font-size: 0.85rem;
}

.search-result-item:focus {
  border: 3px solid var(--focus-col);
  background-color: var(--search-results-hover);
  outline: none;
}

.search-result-item:hover {
  background-color: var(--search-results-hover);
}

/* Connected result styles */
.search-result-item.connected {
  border-left: 3px solid #00cc00;
  padding-left: 9px;
}

/* Make sure priest name displays correctly */
#priestName {
  font-size: 1.8rem;
  font-weight: bold;
  line-height: 1.2;
}

/* Improve mobile display */
@media (max-width: 800px) {
  .actions-container {
    grid-template-columns: 1fr;
  }
  
  #priestName {
    font-size: 1.5rem;
  }
}
  </style>
</head>
<body>

  <header id="header">
    <nav id="sidebar">
      <h1 class="title">$$resistance-title$$</h1>
      <div class="sidebar-links">
        <a href="/$$LANG$$">$$special-homepage-desc$$</a>
        <a href="/$$LANG$$/$$special-topics-path$$">$$special-articles-title$$</a>
        <a href="/$$LANG$$/$$special-resources-path$$">$$special-resources-title$$</a>
      </div>
    </nav>

    <div class="search-container">
      <div style="display: flex; flex-direction: column;">
        <div style="display: flex; flex-direction: row; align-items: stretch;">
          <input type="text" class="search-input" placeholder="$$search-placeholder$$" id="searchInput" style="flex-grow: 1; margin-right: 0px;">
          <button id="zoomToLocationBtn" class="location-btn" title="Zoom to my location">&#8982;</button>
        </div>
        <div class="links">
          <a class="outbound-link" href="mailto:info@dubia.cc">$$report-error$$</a>
          <a class="outbound-link" href="mailto:info@ducia.cc">$$request-mass$$</a>
        </div>
        <div class="search-results" id="searchResults">
        </div>
      </div>

      <div class="info-panel" id="infoPanel">
          <button class="close-btn" id="closeBtn">×</button>
          <h2 id="priestName"></h2>
          <div id="priestInfo"></div>
        </div>
    </div>
  </header>
  
  <div id="mapContainer"></div>

  <script>

// Configuration
window.CONFIG = {
  // Default center of the map (will be overridden by geolocation if available)
  defaultLat: 48.8566,
  defaultLng: 2.3522,
  defaultZoom: 4,
  
  // Styling - Fixed colors: parishes red, priests blue
  priestMarkerColor: '#003399',  // Blue for priests
  parishMarkerColor: '#cc0000',  // Red for parishes
  lineColor: '#ccc',
  lineWeight: 2,
  lineOpacity: 0.7,
  
  // Marker sizes - standardized
  priestMarkerSize: 8,    // Smaller blue dots for priests
  parishMarkerSize: 10,   // Consistent red dots for parishes
  
  // Google Sheet ID
  sheetId: "16wO1gTdilEcdqsWfJ0mZn-hgYD2MRJ1SCKSAHzcDj18",
  
  // Current language
  currentLanguage: "$$LANG$$",
  
  // Min/max zoom for map controls
  minZoom: 2,
  maxZoom: 18,
};


// Data storage
window.locations = [];
window.religious = [];
window.events = [];
window.fundingData = [];

// Maps for quick lookup
window.locationMap = new Map();
window.religiousMap = new Map();
window.fundingMap = new Map();

// Map and layers
let map;
let priestMarkers = L.layerGroup();
let parishMarkers = L.layerGroup();
let connectionLines = L.layerGroup();
let userLocationMarker = null;

// Default data (fallback)
const defaultLocationsData = `"LocationID carmelites-hf-ireland","LocationType Convent","Name Carmelites of the Holy Face of Jesus","ReligiousIdMulti mother-irene, sister-anne-marie","GoogleMaps https://maps.app.goo.gl/WaokWwYAmujka5Sr7","Location 51.79025633971586, -9.112158704807591","Website https://carmelitesholyface.com/","ContactEmail ","ContactPhone ","Notes ","","","","","","","","","","","","","","",""
"hjm-seminary","Seminary","Hearts of Jesus and Mary Seminary","fr-chazal","https://maps.app.goo.gl/o8xmm2b5eQgNXDpy6","10.342421706935285, 123.83294807185935","https://www.facebook.com/mariancorpsofst.piusx","mariancorpsinformation@gmail.com","639991680637","","","","","","","","","","","","","","","",""
"discalced-carm-ph","Mission","Our Lady of Mt. Carmel Oratory","","https://maps.app.goo.gl/tXxyMGo6smjHdLW1A","14.185634883816563, 121.23247682974647","https://discalcedcarmelites.org.ph/","","","https://www.facebook.com/ScapularConfraternityPH/","","","","","","","","","","","","","","",""
"mosteiro-santa-cruz","Convent","Mosteiro da Santa Cruz","bp-aquino","https://maps.app.goo.gl/fctDJNpysKvZGV7r9","-22.188609036471846, -42.54923387378506","https://www.mosteirodasantacruz.org/","mostsantacruz@gmail.com","552225401136","","","","","","","","","","","","","","","",""
"nd-de-bellaigue","Convent","Monastery of Notre-Dame de Bellaigue","fr-placide","https://maps.app.goo.gl/aTsGWQcpfW6sUds99","46.159681204461975, 2.7036650318380326","","","33473523326","","","","","","","","","","","","","","","",""
"sajm-seminary-morannes","Seminary","Séminaire Saint Louis Marie Grignion de Montfort","","https://maps.app.goo.gl/VEEQd6oNFp81vAa57","47.74520085682513, -0.41836116956105057","https://apotresdejesusetdemarie.fr/","sajm.secretariat@gmail.com","330983597578","","","","","","","","","","","","","","","",""
"dominicans-avrille","Seminary","Couvent de la Haye-aux-Bonshommes","bp-faure","https://maps.app.goo.gl/W9JSLZMaT2mRxRuN7","47.48959520825813, -0.5991638769394454","https://www.dominicainsavrille.fr/","saintdominique@gmail.com","330241692006","Dominicans of Avrillé","","","","","","","","","","","","","","",""
"fbmv-monastery-br","Convent","Familia Beatae Mariae Virginis","fr-jahir","https://maps.app.goo.gl/QnUzGvGnKJqhCS7t5","-12.647034043093072, -38.454641870627555","fbmv.org","contato@fbmv.org","5507136072073","","","","","","","","","","","","","","","",""
"escravas-de-maria","Convent","Escravas de Maria Rainha da Paz","","https://maps.app.goo.gl/2A6QdLkDAtdPqGjL7","-20.49268829846052, -54.588381673599734","https://escravasdemaria.blogspot.com/","escravasdemaria@hotmail.com","55679999841335","","","","","","","","","","","","","","","",""
"couvent-st-francois","Convent","Couvent Saint-François","fr-antoine","https://maps.app.goo.gl/MvWE3PUgDHEmEM387","46.14674140135561, 4.674146280722483","","","","","","","","","","","","","","","","","","",""
"strasbourg-fr","Home","Resistance Strasbourg","","https://maps.app.goo.gl/yDVvvHeF4oXiGiPf7","48.56838595177122, 7.756926120015022","","marieantoinette.ball@yahoo.fr","620232730","","","","","","","","","","","","","","","",""
"sisters-of-cenacle-it","Convent","Discepole Del Cenacolo","","https://maps.app.goo.gl/KQmP2WbXb3euGsEb7","41.686852501833265, 12.76151038779575","https://doncurzionitoglia.wordpress.com/","","","","","","","","","","","","","","","","","",""
"insituto-sen-do-rosario","Convent","Instituto Nossa Senhora do Rosário","","https://maps.app.goo.gl/x3TEJvMg4wWeytGm9","-16.18156528170096, -49.025071755269636","https://archive.ph/wip/0J7iG","","","","","","","","","","","","","","","","","",""
"two-hearts-ny","Parish","Two Hearts Chapel","fr-voigt, fr-ortiz","https://maps.app.goo.gl/mXU9QbHxmbTEhaCd7","45.44632838772738, -94.19997944646171","https://www.olhcutica.com/contact-us/","info@olhcutica.com","","","","","","","","","","","","","","","","",""
"korea-1","Home","K2 Building 870 Tongil-ro","fr-chazal","https://maps.app.goo.gl/kQjuF4DcLfTeL2277","37.62066477428733, 126.92046529600468","http://mcspx.kr/","","","4th Floor","","","","","","","","","","","","","","",""
"brazil-1","Parish","Capela Ns. Senhora Auxiliadora","bp-aquino","https://maps.app.goo.gl/wBW5vW7Yek9aMjGs8","-25.486584295509132, -54.51657041329986","https://linktr.ee/fronteiracatolica","","","","","","","","","","","","","","","","","",""
"france-1","Parish","Resistance Lyon","bp-morgan","https://maps.app.goo.gl/GZxKd7uwh4BTWz2X8","45.75765253947298, 4.833849821208268","https://archive.is/wip/AT1ci","frpwm1@hotmail.com","","","","","","","","","","","","","","","","",""
"vesoul-fr","Parish","Resistance Vesoul","pr005","https://maps.app.goo.gl/KzsbiRKeWSA8ye1S7","47.6302961028553, 6.1518852013996606","https://archive.is/wip/0P4F0","","","Messes: dimanche (sundays)","","","","","","","","","","","","","","",""
"chantemerle-fr","Parish","Chapelle funéraire de Chantemerle","fr-renoult","https://maps.app.goo.gl/zRSjMHUpYHBwc5rCA","46.67380685692015, -0.6222973967898845","https://archive.is/wip/F85IR","apostolat.saintlouis63@gmail.com","330621973605","Près Les Moutiers-sous-Chantemerle","","","","","","","","","","","","","","",""
"st-dominics-texas","Parish","St. Dominic's Chapel","fr-brocard, fr-voigt","https://maps.app.goo.gl/qrok5TjTm4X3jtsB8","29.561801447715514, -98.08086831544996","https://latinmasstexas.wordpress.com/","matthew@cathinfo.com","","Mass times are available by E-Mail only (privacy)","","","","","","","","","","","","","","",""
"france-1","Parish","Notre-Dame Gardienne de la Foi","fr-merode","https://maps.app.goo.gl/KyqYcgM63NkZqNfi9","43.11601384000813, -0.07281460031554028","https://notredamegardiennedelafoi.fr/poueyferre-agenda-des-messes/","","330967088788","","","","","","","","","","","","","","","",""
"jeus-le-bois-fr","Parish","Prieuré Notre-Dame du Christ-Roi","fr-pivert","https://maps.app.goo.gl/RMRd9NZu7g3fQNKi8","46.6872639919537, 1.768072490512093","https://abbe-pivert.com/ministere-dominical/","","","","","","","","","","","","","","","","","",""
"germany-1","Parish","Kloster Reichenstein","fr-lang","https://maps.app.goo.gl/CSmSZxZzkLPpTcNC9","50.53938053457885, 6.200905050750951","https://archive.is/wip/t7ci0","pater.lang@gmx.de","","Monastery itself is anti-Resistance, but they host Fr. Lang ","","","","","","","","","","","","","","",""
"bootzheim","Mission","Resistance Bootzheim","fr-pivert","https://maps.app.goo.gl/NnQowpQDU4L1sHe57","48.18820799140211, 7.572019137184236","https://archive.is/wip/fMTKy","contact@abbe-pivert.com","","","","","","","","","","","","","","","","",""
"france-7","Mission","Prieuré du Coeur Immaculé","pr019","https://maps.app.goo.gl/6SjTNvedJvXDhFnt5","50.93784402582978, 2.541926369489603","https://archive.is/VAi3J","","33620334199","","","","","","","","","","","","","","","",""
"oratory-sfheart-mary-us","Parish","Oratory of the Sorrowful Heart of Mary","fr-hewko, fr-ruiz","https://maps.app.goo.gl/dgFqaduxkLxLhDRa6","43.85315057363545, -71.90903296681068","https://www.stmaryskssspxmc.com","","13153917575","","","","","","","","","","","","","","","",""
"anaku-ng","Parish","Maria Virgo Fidelis Tridentine Priory Anaku","fr-chigbata","https://maps.app.goo.gl/NH8izi9kb5uw22kq7","6.482843616569607, 6.93305980830839","","chigbatamike@gmail.com","","","","","","","","","","","","","","","","",""
"savoie-fr","Home","Fidelité Savoie","fr-pivert","https://maps.app.goo.gl/WtbojK5LwMkWrqNp8","45.49273186046552, 6.472042803672657","","","","","","","","","","","","","","","","","","",""
"edmeston-ny","Home","Resistance Edmeston","fr-hewko","https://maps.app.goo.gl/zLPDd1DAezmtvV216","42.73645140067997, -75.2097574184586","https://archive.is/9zoX3","","12129918319","Contact: Mr. Perry","","","","","","","","","","","","","","",""
"syracuse-ny","Home","Resistance Syracuse","fr-hewko","https://maps.app.goo.gl/r3MHYL8jSSu9krjW6","43.045065280586364, -76.16410541381305","https://archive.is/e5q5S","","13153917575","","","","","","","","","","","","","","","",""
"fort-worth-tx","Home","Resistance Fort Worth","fr-hewko","https://maps.app.goo.gl/zA8iviGvTfKjnUYu6","32.88861447502964, -97.44677793764893","https://archive.is/XE5pn","","","","","","","","","","","","","","","","","",""
"houston-tx","Home","Resistance Houston","fr-hewko","https://maps.app.goo.gl/ZpK1ZRfK7qzeDJM66","29.895551268371424, -95.52577334948946","https://archive.is/XE5pn","agmfgalera@yahoo.com","12817867743","","","","","","","","","","","","","","","",""
"chicago-il","Home","Resistance Chicago","fr-hewko","https://maps.app.goo.gl/S6V2HcFyrHrro5s37","41.86888406669567, -87.64606043361077","https://archive.is/wip/J4INg","","16302571995","","","","","","","","","","","","","","","",""
"bruehwiler-st-gallen-ch","Home","Oratorium Heiliger Bruder Klaus Hüter des Vaterlandes","fr-bruhwiler","https://maps.app.goo.gl/W9vP4EwzmJkX4QYh9","47.40894072384693, 9.331886481300096","https://abbe-pivert.com/wp-content/uploads/2019/05/Oratorium-St.-Gallen-GO-Nr.-1-2019.pdf","","41766997584","","","","","","","","","","","","","","","",""
"chennai-st-anthony","Parish","St. Anthony’s Shrine","","https://maps.app.goo.gl/bhfT9UZEmyBx6giHA","13.049088527376865, 80.2535663848687","https://www.facebook.com/indiatlm","","919442265158","","","","","","","","","","","","","","","",""
"kandigai-mcspx","Parish","SSPX - Marian Corps Fraire","","https://maps.app.goo.gl/p6nVJ5BRDHVzdvZG9","12.635268838290955, 79.69335041962752","","","","","","","","","","","","","","","","","","",""
"zendejas-ny","Parish","Bishop Zendejas Seminary","bp-zendejas","https://maps.app.goo.gl/x12vemZXdKCvDXb37","41.2499877080973, -73.52725929669987","","","","","","","","","","","","","","","","","","",""
"olp-louisville","Parish","Our Lady of the Pillar","fr-bitzer, fr-oconnor","https://maps.app.goo.gl/a582GueWVnxNak8B6","38.19488914004571, -85.76819954230683","https://olpchapel.org/","","","","","","","","","","","","","","","","","",""
"vendee-1","Home","Resistance Vendee","fr-bruno","","","","apostolat.saintlouis63@gmail.com","330621973605","https://archive.is/F85IR","","","","","","","","","","","","","","",""
"st-athanasius-usa","Parish","Saint Athanasius Traditional Church","fr-ringrose, fr-da-damio, fr-ortiz","https://maps.app.goo.gl/FRbhQYw44SJ2y4hj8","38.94979434012304, -77.26276890537048","","","17037594555","","","","","","","","","","","","","","","",""
"donauwoerth","Home","Resistance Donauwörth","fr-failer","https://maps.app.goo.gl/p76ZVtAxMMdppMnr8","48.717321761144945, 10.773400829313672","","","4917645888512","Fr. Franz Failer (retired, but still active)","","","","","","","","","","","","","","",""
"cologne-de","Home","Resistance Köln-Refrath","fr-failer","https://maps.app.goo.gl/npPXHBH1hiCRUomr8","50.959164926369766, 7.116342413001446","","","","","","","","","","","","","","","","","","",""
"thal-drulingen-fr","Parish","Paroisse St. Jean-Baptiste","fr-picot","https://maps.app.goo.gl/k4dZNvqEwVpbzTCF9","48.9096022335556, 7.1448285153542805","","","","","","","","","","","","","","","","","","",""
"aigen-1","Parish","Resistance Österreich","fr-fuchs","https://maps.app.goo.gl/UV32KC1tvGPVzmLt9","48.64700146067714, 13.972704230677788","","pater.martin.fuchs@gmail.com","","","","","","","","","","","","","","","","",""
"aldergrove-canada","Home","Coghlan Community Hall","fr-girouard","","49.12586082924718, -122.51550652713061","","","","","","","","","","","","","","","","","","",""
"stella-maris-houston","Parish","Miraculous Medal Church","fr-garcia, bp-zendejas","https://maps.app.goo.gl/zqhKwAYjySdiZsL57","29.371624376970676, -95.02020323208488","","matthew@cathinfo.com","18309146890","","","","","","","","","","","","","","","",""
"paris-fr-1","Home","Resistance Paris","fr-pivert","https://maps.app.goo.gl/JL5CTTeL6J2vw1qg8","48.85360044073054, 2.3849931552216477","","contact@abbe-pivert.com","330254010598","Quelque fois: Saleneuve Paris 17e","","","","","","","","","","","","","","",""
"paris-fr-2","Home","Resistance Paris Alternative","fr-pivert","https://maps.app.goo.gl/gprmG9X7B3A6Lqf99","48.88531350210944, 2.3142709043894842","","contact@abbe-pivert.com","330254010598","Quelque fois: 11 Rue de Jules Vallés","","","","","","","","","","","","","","",""
"rouen-fr","Home","Resistance Rouen","fr-pivert","https://maps.app.goo.gl/8sFVWh1bfakuzpjU7","49.47346818731815, 1.1323827103479962","","pivert.marie-laure@orange.fr","","","","","","","","","","","","","","","","",""
"thanville-fr","Home","Resistance Thanvillé","fr-marcel-croix, fr-picot","https://maps.app.goo.gl/grn12qBG86Fvy7GTA","48.32291625720192, 7.3476771972499","","event@chateau-de-thanville.com","330613045076","","","","","","","","","","","","","","","",""
"mulhouse-fr","Mission","Resistance Mulhouse","fr-pivert","https://maps.app.goo.gl/5LmtmP8E1He2Hmy88","47.747416290770694, 7.321063016629004","","contact@abbe-pivert.com","330254010598","vendredi soir et 1er samedi du mois","","","","","","","","","","","","","","",""
"jura-fr","Mission","Resistance Jura","fr-pivert","https://maps.app.goo.gl/9ySCDQ9cJL2eKQuF6","46.670200563881366, 5.551838671328609","","contact@abbe-pivert.com","330254010598","près de Lons le Saunier","","","","","","","","","","","","","","",""
"lowicz-pl","Home","Resistance Łowicz","bp-stobnicki","https://maps.app.goo.gl/tYbn2s7iaJTAwBXM6","52.105702314462626, 19.94598957901794","","katolickiruchoporu@gmail.com","48605094162","Main location of +Stobnicki","","","","","","","","","","","","","","",""
"gorki-pl","Home","Resistance Gorki","bp-stobnicki","https://maps.app.goo.gl/vxpgHkk6gVV7sGLD7","52.78704940604042, 15.501326111707295","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"raszyn-pl","Home","Resistance Raszyn","bp-stobnicki","https://maps.app.goo.gl/SYHshS9HhqnryAb68","52.15933220725341, 20.917944784300122","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"lodz-pl","Home","Resistance Łódź","bp-stobnicki","https://maps.app.goo.gl/nQ3P9oXB77ApHFeB6","51.74487529699597, 19.561832552917277","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"plock-pl","Home","Resistance Płock","bp-stobnicki","https://maps.app.goo.gl/hdbHPT5shnFWoc5X8","52.510156652278766, 19.771332148578924","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"makow-mazowiecki-pl","Home","Resistance Maków Mazowiecki","bp-stobnicki","https://maps.app.goo.gl/N5PEeJYt8gxZnzku7","52.87111308024299, 21.113716473533877","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"ostrow-mazowiecka-pl","Home","Resistance Ostrów Mazowiecka","bp-stobnicki","https://maps.app.goo.gl/AMVmEPCxHfLDu4dQ9","52.80033646337503, 21.894948693273527","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"pultusk-pl","Home","Resistance Pułtusk","bp-stobnicki","https://maps.app.goo.gl/Qjh8vNz7VgZV8aaK9","52.696062643379456, 21.087029111314994","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"swidnik-pl","Home","Resistance Świdnik","bp-stobnicki","https://maps.app.goo.gl/wsgnZkycy9tZPq5E6","51.2141266735731, 22.691715275747008","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"ropczyce-pl","Home","Resistance Ropczyce","bp-stobnicki","https://maps.app.goo.gl/8DQVwLMdb2UMxxSy8","50.05151557941465, 21.604370947259564","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"sanok-pl","Home","Resistance Sanok","bp-stobnicki","https://maps.app.goo.gl/V6iESWqgdYFdft3X9","49.55219687159274, 22.208532986870907","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"krosno-pl","Home","Resistance Krosno","bp-stobnicki","https://maps.app.goo.gl/XyWg3uLppF6iHu777","49.68164460647064, 21.765792330649077","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"mielec-pl","Home","Resistance Mielec","bp-stobnicki","https://maps.app.goo.gl/hYyM9wnw2GjEWbfg9","50.288076915365366, 21.44297482930958","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"debica-pl","Home","Resistance Dębica","bp-stobnicki","https://maps.app.goo.gl/75m4LgC5NgCAQ7Me6","50.05042375998396, 21.412326039210082","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"tuchow-pl","Home","Resistance Tuchów","bp-stobnicki","https://maps.app.goo.gl/AuoMtt5TkaqjDxrW7","49.893082539988676, 21.053872754476828","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"gruszow-wielki","Home","Resistance Gruszów Wielki","bp-stobnicki","https://maps.app.goo.gl/2A52YrAgp14c3fyu5","50.18994160533622, 21.031447226894528","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"myslenice-pl","Home","Resistance Myślenice","bp-stobnicki","https://maps.app.goo.gl/ASFpDGUTifERvN4i7","49.83127888047517, 19.94249311292188","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"jaroszowiec-pl","Home","Resistance Jaroszowiec","bp-stobnicki","https://maps.app.goo.gl/hgWYGDhB3kf3DibH9","50.33582074563503, 19.601664072496792","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"pyrzowice-pl","Home","Resistance Pyrzowice","bp-stobnicki","https://maps.app.goo.gl/PyAYGYmposQpQWJ26","50.4662681436254, 19.072817239967698","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"kluczbork-pl","Home","Resistance Kluczbork","bp-stobnicki","https://maps.app.goo.gl/enomZLAuCRy3UWwdA","50.970676517143794, 18.215749028321387","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"wroclaw-pl","Home","Resistance Wrocław","bp-stobnicki","https://maps.app.goo.gl/ZPEpn3VptivTHvQz6","51.10028529291778, 17.028281129841442","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"stargard-szczecinski-pl","Home","Resistance Szczeciński / Stargard","bp-stobnicki","https://maps.app.goo.gl/Sax2tDmPfZARNS2u7","53.339255744873654, 15.029854258542532","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"bobolice-pl","Home","Resistance Bobolice","bp-stobnicki","https://maps.app.goo.gl/d4CN6EWzf5URZTKd7","53.95240731667564, 16.58732193382324","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"bytow-pl","Home","Resistance Bytów","bp-stobnicki","https://maps.app.goo.gl/XjJwjh3jXhpVxcaN6","54.16869927927328, 17.4912600633429","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"koscierzyna-pl","Home","Resistance Kościerzyna","bp-stobnicki","https://maps.app.goo.gl/gZi6bFFirBi7BttJA","54.12027564494991, 17.981457692413933","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"gdansk-pl","Home","Resistance Gdańsk","bp-stobnicki","https://maps.app.goo.gl/2uNZSsZACvAYQzaK7","54.303072141207316, 18.630279242049635","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"sztum-pl","Home","Resistance Sztum","bp-stobnicki","https://maps.app.goo.gl/vDRhCTUxCbqBVBg19","53.91973891562961, 19.029549989216058","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"bydgoszcz-pl","Home","Resistance Bydgoszcz","bp-stobnicki","https://maps.app.goo.gl/87xkHRdYzmBnti4d8","53.12238031426279, 18.01023636356862","","katolickiruchoporu@gmail.com","48605094162","","","","","","","","","","","","","","","",""
"prague-cz","Parish","Kaple Neposkvrněného Srdce Panny Marie","fr-rousseau, fr-picot","https://maps.app.goo.gl/1ERJkvTZKvZwRmAv5","50.075354768353456, 14.43592498438727","https://www.neposkvrnenesrdce.cz/","neposkvrnene@pm.me","","","","","","","","","","","","","","","","",""
"yvignac-la-tours-fr","Convent","Domaine Saint Joseph","fr-renoult","https://maps.app.goo.gl/NHDCRwJ24ubrohVm8","48.322654457894465, -2.179972378499632","https://archive.is/wip/U2IYm","","","","","","","","","","","","","","","","","",""
"reenascreena-ir","Parish","Resistance Reenascreena","bp-ballini","https://maps.app.goo.gl/CGwYviT4PMvg7kad8","51.61662943455257, -9.059309688077146","https://archive.is/dzcfy","","","","","","","","","","","","","","","","","",""
"kampala-ug","Home","Marian Workers Kampala","fr-ondo","https://maps.app.goo.gl/xNt2Qynyfdi24iZXA","0.30788573727853336, 32.58118488510375","","","","","","","","","","","","","","","","","","",""
"masaka-ug","Home","Resistance Masaka","fr-ondo","https://maps.app.goo.gl/1hxQwiCiNB2nknXUA","-0.3372056299904156, 31.74361445927555","","","","","","","","","","","","","","","","","","",""
"kabale-ug","Home","Marian Workers Kabale","fr-ondo","https://maps.app.goo.gl/FRbL4Krs7qSA82Nv6","-1.252255385034319, 29.988274777209835","","","","","","","","","","","","","","","","","","",""
"kisoro-ug","Home","Marian Workers Kisoro","fr-ondo","https://maps.app.goo.gl/srruxDgFayUdvJVX6","-1.284268436768448, 29.690874222934365","","","","","","","","","","","","","","","","","","",""
"libreville-ng","Home","Resistance Libreville","fr-ondo","https://maps.app.goo.gl/Jb12sjJuu69iov8x5","0.40159396337997233, 9.442546357058562","","","","","","","","","","","","","","","","","","",""
"queretaro-mx","Home","Resistance Queretaro","fr-ruiz","https://maps.app.goo.gl/ZUENXEGNXb5zZtY97","20.55672380424723, -100.37075672688543","https://archive.is/wip/f7A5T","cinefamiliarmexicano@gmail.com","525533679642","","","","","","","","","","","","","","","",""
"burlington-us","Home","Burlington Conference Center","fr-ortiz","https://maps.app.goo.gl/2MGumQtDv7oGvNom9","44.46969849224077, -73.17880588280379","","traditio@bell.net","","","","","","","","","","","","","","","","",""
"asaba-ng","Parish","Resistance Asaba","fr-chigbata","https://maps.app.goo.gl/cmYfhJEbRySEyD9V9","6.205853909353634, 6.695875672565205","https://archive.is/MXdxf","","","","","","","","","","","","","","","","","",""
"onitsha-ng","Parish","St. Gabriel","fr-chigbata","https://maps.app.goo.gl/MRnQNUAYSm4RC8AXA","6.133054826709088, 6.768682645090764","https://archive.is/MXdxf","","","","","","","","","","","","","","","","","",""
"imo-ng","Parish","St. Pius X Catholic Fidelity","fr-onuorah","https://maps.app.goo.gl/WrhoyHAXN4iqG1Mb6","5.7819291159454576, 7.027508987919038","https://archive.is/MXdxf","","","","","","","","","","","","","","","","","",""
"peine-de","Home","Resistance Peine","fr-marcel-croix","https://maps.app.goo.gl/an7KXz3Efh9wjAMK8","52.31933973855269, 10.225899645282599","","","","","","","","","","","","","","","","","","",""
"uckermark-de","Home","Resistance Uckermark","fr-marcel-croix","https://maps.app.goo.gl/PbLkD5FBM9LiuEd77","53.10460228546069, 13.641123807387402","","info@dubia.cc","","","","","","","","","","","","","","","","",""
"heidelberg-de","Home","Resistance Heidelberg","fr-picot","https://maps.app.goo.gl/8WkviUJu6kayf8x9A","49.3954216637457, 8.665758724491145","","info@dubia.cc","","","","","","","","","","","","","","","","",""
"st-marys-us","Home","Resistance St. Marys","","https://maps.app.goo.gl/8EkGaBimupF91N5s5","39.19341287627015, -96.07079335410376","https://archive.is/zmlQD","","","","","","","","","","","","","","","","","",""
"sacedon-es","Home","Compañía de Santa Filomena","fr-ribas","https://maps.app.goo.gl/jxiUnTcYs7uCCeA27","40.48161971655209, -2.7320727142047474","https://www.padreramiroribas.com/contacto","","","","","","","","","","","","","","","","","",""
"mosteiro-senhora-fe","Convent","Mosteiro de Nossa Senhora da Fé e Rosário","fr-jahir","https://maps.app.goo.gl/ozrE26C7YJqYZnyr5","-12.647098675961278, -38.45468206628142","https://www.fbmv.org/","mosteironsf@gmail.com","557136072073","","","","","","","","","","","","","","","",""
"texiera-br","Home","Apostolado Nossa Senhora do Rosário","","https://maps.app.goo.gl/NYQXU8g5joQHwvY98","-17.540169972780955, -39.742050650519474","","breno_meirelle@hotmail.com","","Tratar com Sr. Breno","","","","","","","","","","","","","","",""
"bom-jesu-da-lapa-br","Home","Missão do Senhor Bom Jesus da Lapa","","https://maps.app.goo.gl/ALoHx5itVubWuP1n8","-13.263283653711788, -43.406835741651385","","alans538can@gmail.com","","Tratar com Sr. Alan","","","","","","","","","","","","","","",""
"vitoria-br","Home","Capela Nossa Senhora das Alegrias","","https://maps.app.goo.gl/YkF6hvyQ7G8qEUGf9","-20.2855537754842, -40.30416398930609","","carloshenriquedelazari@hotmail.com","552733455601","Tratar com Sr. Henrique","","","","","","","","","","","","","","",""
"belo-horizonte-br","Home","Capela Nossa Senhora das Graças","","https://maps.app.goo.gl/WTh2B2uo6ikdz9XBA","-19.9489109594848, -44.044056361591345","","","5531989353785","","","","","","","","","","","","","","","",""
"iapu-br","Home","Capela do Apostolado da Oração","","https://maps.app.goo.gl/WiUEq2WTxqu66GxA7","-19.437619800348813, -42.217631052638104","","mateus.ocosta.spx@gmail.com","5533988738416","Tratar com Sr. Mateus","","","","","","","","","","","","","","",""
"aracuai-br","Parish","Capela São Miguel Arcanjo","","https://maps.app.goo.gl/rhRpFNe8EiiqJx547","-16.84328187253199, -42.073652642475345","https://capelasmiguel.blogspot.com/","capelasanctemichael@gmail.com","5533999464545","Tratar com Sr. Raphael - Ir. Obl. Domingos Maria, O.S.B.","","","","","","","","","","","","","","",""
"joao-monlevade-br","Home","Capela Nossa Senhora de Fátima","","https://maps.app.goo.gl/HkL4KfECfZ9MXetx8","-19.82668482448176, -43.17545732735792","","","5531992582498","Tratar com Frei Sidney","","","","","","","","","","","","","","",""
"cabedelo-br","Home","Missão Nossa Senhora Auxiliadora","","https://maps.app.goo.gl/U5ptvyQ2fbXJJzaV7","-7.0405472761706624, -34.842977097210856","","rhuanhonorio@outlook.com","5583996746887","Tratar com Rhuan","","","","","","","","","","","","","","",""
"foz-do-iguacu-br","Parish","Capela Nossa Senhora Auxiliadora","","https://maps.app.goo.gl/TYyGsanU81xGa2hCA","-25.486592518903247, -54.51656719351719","http://missatridentina.foz.br/","","5545991332857","","","","","","","","","","","","","","","",""
"toledo-br","Home","Resistance Toledo","","https://maps.app.goo.gl/UdHg7gVyHPLT3smt7","-24.722771065247596, -53.740821250959556","https://chat.whatsapp.com/Hl5c4PMA5Iv0Wn5Bt7URZu","","","Contact on WhatsApp (""Website"")","","","","","","","","","","","","","","",""
"marechal-rondon-br","Home","Resistance Marechal Cândido Rondon","","https://maps.app.goo.gl/8feeddHLYprrb1Ys5","-24.556163450100314, -54.059060636377254","","","5545998104172","Tratar com Sr. Alcides","","","","","","","","","","","","","","",""
"cascavel-br","Home","Resistance Cascavel","","https://maps.app.goo.gl/Yis6iYD96qXbeo2r6","-24.954645246346143, -53.47960477615041","","","5545984024454","Tratar com Sr. Márcio","","","","","","","","","","","","","","",""
"curtiba-br","Home","Grupo Santo Antônio","","https://maps.app.goo.gl/icMbKMbFazs6a5NUA","-25.425282515638717, -49.266720380937535","https://chat.whatsapp.com/JqWAtne3EpwBf3ORYseZCq","","","Contact on WhatsApp (""Website"")","","","","","","","","","","","","","","",""
"londrina-br","Home","Missão São Pio V","","https://maps.app.goo.gl/bfXkphTzWE87BGcJ9","-23.31988609906379, -51.166337785833754","","missatridentinaemlondrina@gmail.com","5543996753680","Tratar com Sr. Victor Macedo","","","","","","","","","","","","","","",""
"floriano-br","Home","Apostolado São José","","https://maps.app.goo.gl/sYQuYKYb9wYee4gQ6","-6.781877936747591, -43.02373232848479","","lucasaraujosilva6116@gmail.com","5589994432566","Tratar com Lucas Araújo - alternative: +5589994686829 (Jessika Araújo), +5589933005465 (Teresinha Ribeiro)","","","","","","","","","","","","","","",""
"teresina-br","Home","Apostolado Nossa Senhora do Desterro","","https://maps.app.goo.gl/mGhczsXKRdEqA1Hj6","-5.0961737068861614, -42.802279400176836","https://chat.whatsapp.com/KnAymRlNwpx4dQ71afpGKj","elida.lopes78@gmail.com","","Tratar com senhora Élida Lopes / insta: apostolado_nsra_do_desterro","","","","","","","","","","","","","","",""
"rio-grande-do-sul-br","Home","Missão do Rio Grande do Sul","","https://maps.app.goo.gl/gqQcxbsdGoL1qnCq9","-30.03699859336108, -51.208987041513055","https://chat.whatsapp.com/CuMOsTBZyUP9jxQ3f4iMSO","","","","","","","","","","","","","","","","","",""
"porto-velho-br","Home","Missão São Benedito","","https://maps.app.goo.gl/KMLeLK7vQdS1wiug7","-8.756326453097676, -63.86948720121775","","saobeneditomissao@gmail.com","5569993313611","Tratar com Sr. Marcos","","","","","","","","","","","","","","",""
"florianopolis-br","Home","Capela Nossa Senhora do Desterro","","https://maps.app.goo.gl/nFX1ypWdqJ23XL1b8","-27.597142905079682, -48.547549246988396","https://chat.whatsapp.com/EBUGiv8nV9yBQWF9FsHSvx","","","","","","","","","","","","","","","","","",""
"presidente-franco-py","Parish","Capilla San Roque González de Santa Cruz","","https://maps.app.goo.gl/dmppUnDB46cSjLbu6","-25.55521869313379, -54.62280718974859","https://fronteiracatolica.blogspot.com/","","5545999218536","","","","","","","","","","","","","","","",""
"asuncion-py","Home","Resistance Asunción","","https://maps.app.goo.gl/zbmvfcSUYPCDfT2GA","-25.27275284305875, -57.62264877671335","","","595981389596","Hablar con la señora Miriam","","","","","","","","","","","","","","",""
"green-bay-wisconsin","Home","Resistance Green Bay","fr-hewko","https://maps.app.goo.gl/aFzciYThDcaTFpAC8","44.67338307944719, -88.24272756788059","https://archive.is/Uk5Dt","lstachura71@gmail.com","19206800077","Contact: Lisa","","","","","","","","","","","","","","",""
"st-paul-minnesota","Home","Resistance St. Paul","fr-hewko","https://maps.app.goo.gl/K9xsGi7NFUAbsztQ7","44.953382582321055, -93.09026362575692","https://archive.is/wip/TR7io","olgs.twincities@outlook.com","","Contact coordinator for further details","","","","","","","","","","","","","","",""
"bay-tree-ca","Home","Resistance Bay Tree","fr-hewko","https://maps.app.goo.gl/2Yac7CBpP2uuQutV7","55.82482094887174, -119.90531370379325","https://archive.is/wip/3mMJa","","17803533101","Contact: Jim","","","","","","","","","","","","","","",""
"calgary-ca","Home","Resistance Calgary","fr-hewko","https://maps.app.goo.gl/mHTiqj2GGYbqQ2Du8","51.04306144231892, -114.07122842063092","https://archive.is/wip/9j1IY","","14034155939","Contact: Mr. and Mrs. Nord","","","","","","","","","","","","","","",""
"athol-id","Home","Resistance Athol (Idaho)","fr-hewko","https://maps.app.goo.gl/kzVcgFQUKvaiVuuk9","47.90975394547177, -116.73691724850042","https://archive.is/wip/Z4yqm","","12535092564","","","","","","","","","","","","","","","",""
"pocatello-id","Home","Resistance Pocatello","fr-hewko","https://maps.app.goo.gl/MWVLJ2gGcogzXYqb8","42.887109241928655, -112.43062836023775","https://archive.is/wip/0WYak","","12084067144","","","","","","","","","","","","","","","",""
"sacramento-ca","Home","Resistance Sacramento","fr-hewko","https://maps.app.goo.gl/ebkoMdhRGFHmA36s5","38.60802286591459, -121.28541585023765","https://archive.is/wip/DQaEl","","13153917575","","","","","","","","","","","","","","","",""
"los-angeles-ca","Home","Resistance Los Angeles","fr-hewko","https://maps.app.goo.gl/NSBY6wvYDFerPjeV9","34.053360289816844, -118.33325235235361","https://archive.is/wip/sDQ7Y","","19493316436","Contact coordinator for further details","","","","","","","","","","","","","","",""
"san-diego-ca","Home","Resistance San Diego","fr-hewko","https://maps.app.goo.gl/5HAqhGMyoY6Pg8Xx7","32.75977348490878, -117.0968538089909","https://archive.is/wip/VQnro","1glonuss@cox.net","16192816494","Mass coordinator: Gloria Nussey","","","","","","","","","","","","","","",""
"tucson-az","Home","Resistance Tucson","fr-hewko","https://maps.app.goo.gl/rqwKMGd33zxYNxvXA","32.23172253796985, -110.98309104852929","https://archive.is/rR9Ix","","14806199665","Contact: Garcia Family","","","","","","","","","","","","","","",""
"phoenix-az","Home","Resistance Phoenix","fr-hewko","https://maps.app.goo.gl/NBRfCHEdTxFYnGFs6","33.46168856470562, -112.10572511454238","https://archive.is/wip/pCAqq","","14806199665","Contact: Garcia Family","","","","","","","","","","","","","","",""
"new-orleans-lo","Home","Resistance New Orleans","fr-hewko","https://maps.app.goo.gl/y2MQBgjjtynucA5d6","29.605236748563676, -90.73715933992345","https://archive.is/wip/tbMku","","15043383058","Contact: Ray Kelly","","","","","","","","","","","","","","",""
"st-marys-us-alt","Home","SSPX-MC St. Marys","fr-hewko","https://maps.app.goo.gl/vA3LLDzAgUsbTsdP8","39.19722664591712, -96.0833188269843","https://archive.is/wip/40ykI","prwhite65@protonmail.com","","Contact coordinator for further details","","","","","","","","","","","","","","",""
"philadelphia-ps","Home","Resistance Philadelphia","fr-hewko","https://maps.app.goo.gl/CTvgY6XnHidHoqz48","39.86552269626829, -75.3005015924896","https://archive.is/3mrbj","rosamystica3329@gmail.com","","Contact coordinator for further details","","","","","","","","","","","","","","",""
"tannersville-ps","Home","Resistance Tannersville","fr-hewko","https://maps.app.goo.gl/czoGsDTWNddBzHvD8","41.05415936600605, -75.33539404864212","https://archive.is/wip/hEYgF","holyfamilymissionnj@gmail.com","","Contact coordinator for further details","","","","","","","","","","","","","","",""
"raleigh-nc","Home","Resistance Raleigh","fr-hewko","https://maps.app.goo.gl/8ghppveDTh8oFXDHA","36.099184567845676, -79.23262522302792","","","15103614394","Contact: Margarita","","","","","","","","","","","","","","",""
"nashville-tn","Home","Resistance Nashville","fr-hewko","https://maps.app.goo.gl/3GSx8Z1na6NdkKGS7","36.240392446486275, -86.63640524509358","https://archive.is/wip/T5cpB","","15103684994","","","","","","","","","","","","","","","",""
"harrisburg-nc","Home","Resistance Harrisburg","fr-hewko","https://maps.app.goo.gl/kegpj6smWgM97X7fA","35.338432722591236, -80.64062168317739","https://archive.is/wip/6iptz","","19808332379","Contact: Nino","","","","","","","","","","","","","","",""
"north-bay-ca","Home","Resistance North Bay","fr-hewko","https://maps.app.goo.gl/B4yKgm3JBjUjT3Pm6","46.26721035485231, -79.43440114355263","https://archive.is/wip/AxANG","","13153917575","","","","","","","","","","","","","","","",""
"st-catharines-ca","Home","Resistance St. Catharines","fr-hewko","https://maps.app.goo.gl/9mRB8ApRbNApzVDv9","43.13975838503792, -79.23286971690484","https://archive.is/wip/SpjM6","","19056823444","","","","","","","","","","","","","","","",""
"erie-pa","Home","Resistance Erie","fr-hewko","https://maps.app.goo.gl/8YvJicNmp8bM44FV7","42.120424738106415, -80.10371142881712","https://archive.is/wip/uZNcL","","18147465879","","","","","","","","","","","","","","","",""
"lampasas-tx","Home","Resistance Lampasas","bp-trinh","https://maps.app.goo.gl/eGJANRvX5myaFK5w8","31.063278086746383, -98.18222362151981","https://archive.is/mSrPQ","","","Contact Fr. Ringrose","","","","","","","","","","","","","","",""
"viterbo-it","Seminary","Collegium Traditionis","bp-vigano","https://maps.app.goo.gl/N1hL7fYMV2X9Xq4w9","42.410991325573036, 12.14205832036938","https://archive.is/wip/TA3JS","info@exsurgedomine.it","","Eremo Sant'Antonio alla Palanzana - runs Abp. Viganòs seminary","","","","","","","","","","","","","","",""`;

const defaultReligiousData = `"ReligiousID bp-zendejas","Type Bishop","Name Gerardo Zendejas","BornYear ","AssociatesWith Resistance","UsualLocationID ","Beliefs NonSede","Country USA","Website https://thebluepaper.org/","OrdainedInRite OldRite","OrdainedBy Lefevbre","ConsecratedInRite OldRite","ConsecratedBy Williamson","BishopLine Lefebvre","ContactEmail ","ContactPhone ","Notes Consecrated bishop on May 11, 2017","","","","","","","","","","","",""
"bp-faure","Bishop","Jean-Michel Faure","1941","Resistance","dominicans-avrille","NonSede","France","https://dominicansavrille.us/","OldRite","Lefevbre","OldRite","Williamson","Lefebvre","","","Consecrated bishop on March 19, 2015","","","","","","","","","","","",""
"bp-aquino","Bishop","Tomas de Aquino","1954","Resistance","","NonSede","Brazil","https://www.mosteirodasantacruz.org/","OldRite","Lefevbre","OldRite","Williamson","Lefebvre","","","Consecrated bishop in 2015 in Brazil","","","","","","","","","","","",""
"bp-stobnicki","Bishop","Michał Stobnicki","1987","Resistance","lowicz-pl","NonSede","Poland","https://archive.is/V8x4h","OldRite","Williamson","OldRite","Williamson","Lefebvre","michalstobnicki@gmail.com","","Consecrated bishop on August 15, 2022","","","","","","","","","","","",""
"bp-morgan","Bishop","Paul Morgan","1963","Resistance","","NonSede","UK","https://archive.is/iKBL5","","","","Williamson","Lefebvre","","","","","","","","","","","","","","",""
"bp-ballini","Bishop","Giacomo Ballini","","Resistance","","NonSede","Ireland","https://archive.is/YiiNJ","OldRite","","OldRite","Williamson","Lefebvre","","","","","","","","","","","","","","",""
"bp-vigano","Bishop","Carlo Maria Viganò","","Resistance","viterbo-it","Benevacantism","Italy","https://exsurgedomine.it/","","","","","","info@exsurgedomine.org","","In contact with +Williamson","","","","","","","","","","","",""
"fr-ondo","Priest","Pierre Célestin Ndong Ondo Ondzaghe","1974","Resistance","libreville-ng","NonSede","Gabon","https://archive.is/wip/MXdxf","OldRite","Fellay?","","","Lefebvre","pndongondo@gmail.com","","","","","","","","","","","","","",""
"fr-chigbata","Priest","Michael Chigbata","","Resistance","anaku-ng","NonSede","Nigeria","","ReordainedOldRite","de Aquino","","","Lefebvre","chigbatamike@gmail.com","2348039538460","Conditionally reordained","","","","","","","","","","","",""
"fr-onourah","Priest","Jean Bosco Ohadugba","","Resistance","anaku-ng","NonSede","Kenia","","ReordainedOldRite","de Aquino","","","Lefebvre","","","Conditionally reordained","","","","","","","","","","","",""
"mother-irene","Mother","Irene Gibson","","Resistance","carmelites-hf-ireland","NonSede","Ireland","https://carmelitesholyface.com/","","","","","","","","","","","","","","","","","","","",""
"sr-anne-marie","Sister","Anne-Marie","","Resistance","carmelites-hf-ireland","NonSede","Ireland","https://carmelitesholyface.com/","","","","","","","","","","","","","","","","","","","",""
"fr-hewko","Priest","David Hewko","","SSPX-MC","oratory-sfheart-mary-us","NonSede","USA","https://thecatacombs.org/","OldRite","Williamson","","","Lefebvre","","","Runs seminary in NY area","","","","","","","","","","","",""
"fr-chazal","Priest","François Chazal","","SAJM","hjm-seminary","NonSede","Phillipines","https://www.facebook.com/mariancorpsofst.piusx","OldRite","de Mallerais?","","","Lefebvre","fr.francoischazal@gmail.com","","","","","","","","","","","","","",""
"fr-lang","Priest","Peter Lang","","SSPX","","NonSede","Germany","https://archive.is/wip/aEagQ","OldRite","Fellay?","","","Lefebvre","","","Still formally in SSPX","","","","","","","","","","","",""
"fr-rousseau","Priest","Dominque Rousseau","1955","Resistance","","NonSede","France","https://archive.is/XVRQQ#selection-2629.0-2670.0","OldRite","Fellay?","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-brocard","Priest","Jean-Baptiste Brocard","","Resistance","st-dominics-texas","NonSede","USA","https://archive.is/t019H","OldRite","Fellay?","","","Lefebvre","","","Resistance Texas / CathInfo.com","","","","","","","","","","","",""
"fr-de-merode","Priest","Roland de Mérode","","Resistance","","NonSede","France","https://notredamegardiennedelafoi.fr/author/admin9234/","OldRite","Fellay?","","","Lefebvre","","330967088788","","","","","","","","","","","","",""
"fr-pivert","Priest","François Pivert","","Resistance","jeus-le-bois-fr","NonSede","France","https://abbe-pivert.com/","OldRite","Fellay?","","","Lefebvre","abbe.pivert@gmail.com","33254010598","La Fidélité Catholique","","","","","","","","","","","",""
"fr-picot","Priest","Rémi Picot","","SAJM","thal-drulingen-fr","NonSede","France","","OldRite","Williamson","","","Lefebvre","maruancoros.picot@gmail.com","33669027039","Fr. Picot serves Alsace & region: ","","","","","","","","","","","",""
"fr-carton","Priest","Francis Carton","","Resistance","","NonSede","France","https://archive.is/wip/VAi3J","OldRite","Fellay?","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-bruhwiler","Priest","Alois Brühwiler","","Resistance","bruehwiler-st-gallen-ch","NonSede","Switzerland","https://archive.is/wip/kawk6","OldRite","Fellay?","","","Lefebvre","","41766997584","","","","","","","","","","","","",""
"fr-pinaud","Priest","Nicolas Pinaud","","Resistance","dominicans-avrille","NonSede","France","https://www.seldelaterre.fr/auteurs/abb%C3%A9-nicolas-pinaud-fsspx","OldRite","Fellay?","","","Lefebvre","","","Signer of Open Letter to Bp. Fellay from 37 priests of France District; heavily condemned with interdiction of using powers of order and jurisdiction; appeal postponed indefinitely; resides in central France; responsible for USML in Central and Southeast France","","","","","","","","","","","",""
"fr-rajkumar","Priest","Valan Rakjumar","","Resistance","kandigai-mcspx","NonSede","India","","","","","","","","","","","","","","","","","","","","",""
"fr-reddy","Priest","Arogya Suneel Kumar Reddy","","Resistance","kandigai-mcspx","NonSede","India","","","","","","","","","","","","","","","","","","","","",""
"fr-bufe","Priest","Craig Bufe","","Resistance","","","Ireland","","","","","","","craig.bufe@btinternet.com","","","","","","","","","","","","","",""
"fr-raffali","Priest","Maurice Raffali","","Resistance","","","France","","","","","","","","","","","","","","","","","","","","",""
"fr-ruiz","Priest","Hugo Ruiz Vallejo","","SSPX-MC","queretaro-mx","NonSede","USA","https://sspxmc.com/fr-hugo-ruiz-vallejo/","OldRite","Lefevbre","","","Lefebvre","hugoruiz12.22@gmail.com","525533679642","Works with Fr. Hewko, but in Mexico","","","","","","","","","","","",""
"fr-antoine","Priest","Antoine de Fleurance","","Resistance","couvent-st-francois","","","https://archive.is/wip/xzH0d","","","","","","","","Prior of the Capucins of Morgon, France","","","","","","","","","","","",""
"fr-rioult","Priest","Olivier Rioult","1971","Resistance","","","","https://stmarcelinitiative.org/tag/fr-olivier-rioult/","","","","","","ab.olivierrioult@yahoo.fr","33658093565","","","","","","","","","","","","",""
"fr-placide","Priest","Placide OSB","","Resistance","nd-de-bellaigue","NonSede","France","","","","","","","","","","","","","","","","","","","","",""
"fr-voigt","Priest","Richard Voigt","","Resistance","two-hearts-ny","NonSede","USA","https://www.olhcutica.com/","ReordainedOldRite","Williamson","","","Lefebvre","","","https://archive.is/xbeph","","","","","","","","","","","",""
"fr-beltran","Priest","Armando Beltran","","Resistance","","","Colombia","","ReordainedOldRite","Williamson","","","","","","Diocesan priest who joined the Resistance in March 2016","","","","","","","","","","","",""
"fr-bitzer","Priest","Gavin Bitzer","","Resistance","olp-louisville","","USA","https://olpchapel.org/about/","","","","","","","15023633157","","","","","","","","","","","","",""
"fr-oconnor","Priest","John O'Connor","","Resistance","olp-louisville","","USA","","","","","","","","15023633157","","","","","","","","","","","","",""
"fr-jahir","Priest","Jahir Britto de Souza","","Resistance","fbmv-monastery-br","NonSede","Brazil","https://fbmv.org/","NewRite","","","","","","","https://archive.is/ZtdXM","","","","","","","","","","","",""
"fr-bruno","Priest","Bruno OSB","","Resistance","vendee-1","NonSede","France","","","","","","","pere.bruno.fr@gmail.com","","Former monk of Le Barroux; left in 2002; resides in Vendée (since 2014?)","","","","","","","","","","","",""
"fr-ceriani","Priest","Juan Carlos Ceriani","","Independent","","","Argentine","https://www.facebook.com/cristiandad.radio/","","","","","","admin@radiocristiandad.com.ar","","Resigned in 2009; ministers in Argentine: NOTE - heavy Williamson Critic, unsure if collaboration w. Resistance wanted","","","","","","","","","","","",""
"fr-da-damio","Priest","Da Damio","","Independent","st-athanasius-usa","","USA","https://archive.is/uyms3","","","","","","","","Helps Fr. Ringrose in Vienna, USA","","","","","","","","","","","",""
"fr-ringrose","Priest","Ronald J. Ringrose","","Independent","st-athanasius-usa","Sedeprivationist","USA","https://archive.is/wip/Iwo0X","","","","","","","","Signer of Vienna Declaration; Serves parish of several hundred faithful in Vienna near Washington DC","","","","","","","","","","","",""
"fr-dardis","Priest","Brendan Dardis OSB","","SSPX","olp-louisville","","USA","","","","","","","","","Catholic Candle warning? Still SSPX? See Fr. Bitzer","","","","","","","","","","","",""
"fr-failer","Priest","Franz Failer","","Independent","donauwoerth","","Germany","","","","","","","chairae1@aol.com","4366488981085","Donauwörth bei Ulm","","","","","","","","","","","",""
"fr-aubonne","Priest","Fidele-Marie d'Aubonne","","Resistance","couvent-st-francois","","France","","OldRite","de Gallereta","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-de-bordeaux","Priest","Pio de Bordeaux","","Resistance","couvent-st-francois","","France","","","","","","","","","","","","","","","","","","","","",""
"fr-de-carvalho","Priest","Angelo Mello de Carvalho","","Resistance","","NonSede","Brazil","https://archive.is/wip/w2N5i","ReordainedOldRite","Faure","","","","","","","","","","","","","","","","","",""
"fr-burgos-joseph","Priest","Diego de Burgos Joseph","","Resistance","couvent-st-francois","NonSede","France","","ReordainedOldRite","de Gallereta","","","Lefebvre","","","Capuchin from Morgon; ministers in France","","","","","","","","","","","",""
"fr-marie-dagneau","Priest","Hubert de Sainte-Marie d'Agneau","","Resistance","","","France","","","","","","","","","","","","","","","","","","","","",""
"fr-del-pilar","Priest","Dominic Maria del Pilar","","Resistance","","","USA","","","","","","","","","Dominican; serves parish in Florida with group of Dominican tertiaries","","","","","","","","","","","",""
"fr-fuchs","Priest","Martin Fuchs","","Resistance","aigen-1","","Austria","https://archive.is/Rmuok","","","","","","pater.martin.fuchs@gmail.com","","","","","","","","","","","","","",""
"fr-marie-laurent","Priest","Marie-Laurent OP","","Resistance","prague-1","","Czech Republic","","","","","","","","","","","","","","","","","","","","",""
"fr-francois-marie","Priest","François-Marie","","Resistance","couvent-st-francois","","France","","","","","","","","","","","","","","","","","","","","",""
"fr-garcia","Priest","Adrian Garcia Jaime","","Resistance","stella-maris-houston","","","","","","","","","","","","","","","","","","","","","","",""
"fr-girouard","Priest","Patrick Girouard","","Independent","aldergrove-canada","","","","","","","","","","","Founded Resistance in Aldergrove, Canada; excluded from FSSPX in November 2013","","","","","","","","","","","",""
"fr-grosso","Priest","Gabriel Mario Grosso","","Independent","","","Argentine","","","","","","","admin@radiocristiandad.com.ar","","Same as Ceriani: heavy Williamson critic in 2015, unsure if collaboration wanted","","","","","","","","","","","",""
"fr-king","Priest","Brendan King","","Resistance","southport","NonSede","UK","https://archive.is/wip/LfqS7","","","","","","","","Serves Southport, Manchester, Liverpool, Tunstall, https://archive.is/Gi5qU","","","","","","","","","","","",""
"fr-koller","Priest","Michel Koller","","Resistance","sajm-seminary-morannes","","France","https://archive.is/AIPhb","","","","","","","","","","","","","","","","","","","",""
"fr-trincado","Priest","René Miguel Trincado Cvjetkovic","","Resistance","st-dominics-texas","","Mexico","https://nonpossumus-vcr.blogspot.com/","","","","","","npossumus@gmail.com","","Serves in Texas / Mexico, runs non-possumus blog","","","","","","","","","","","",""
"fr-jean","Priest","Jean de Morgon","","Resistance","couvent-st-francois","","France","https://archive.is/1r1Po","","","","","","","","Capucin friar","","","","","","","","","","","",""
"fr-conceicao","Priest","Fernando Lopes Conceiçao","","Resistance","insituto-sen-do-rosario","","Brazil","","","","","","","","","School director at the Instituto Nossa Senhora do Rosário - Interlândia, Anápolis - GO, Brazil","","","","","","","","","","","",""
"fr-macdonald","Priest","Edward MacDonald","","Resistance","st-dominics-texas","","USA","","","","","","","","","","","","","","","","","","","","",""
"fr-guiao","Priest","Elias Guiao","","Resistance","hjm-seminary","NonSede","Phillipines","","","","","","","eliasguiao7@gmail.com","","Fr. Elias lives with Fr. Chazal, in Iloilo and Negros","","","","","","","","","","","",""
"fr-marcel-croix","Priest","Marcel de la Croix","","Resistance","thanville-fr","NonSede","France","","OldRite","","","","","fr.marceldelacroix@gmail.com","330787233240","Very based on NFP, helps with dubia.cc","","","","","","","","","","","",""
"fr-renoult","Priest","Paul Renoult","","Resistance","dominicans-avrille","NonSede","France","https://archive.is/wip/apC3R","OldRite","de Aquino","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-zelaya","Priest","André Zelaya de León","","Resistance","","NonSede","Brazil","https://archive.is/jay4G","OldRite","Faure","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-pierre-marie","Priest","Pierre Marie O.P.","","Resistance","dominicans-avrille","NonSede","","","OldRite","","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-vargas","Priest","Arturo Vargas Meza","","SSPX-MC","","","Mexico","https://archive.is/f7A5T","OldRite","Lefevbre","","","Lefebvre","","","Likely works with Fr. Ruiz, location unknown","","","","","","","","","","","",""
"fr-masi","Priest","Marcelo Gabert Masi","","Resistance","","","Brazil","https://archive.is/oInwo","","","","","","","","Location unknown, blog deleted, https://archive.is/wip/hXnrg","","","","","","","","","","","",""
"fr-ortiz","Priest","Juan Carlos Ortiz","","Resistance","","NonSede","Colombia","","","","","","","","","","","","","","","","","","","","",""
"fr-onuorah","Priest","Joseph Onuorah","","Resistance","imo-ng","","Nigeria","https://archive.is/MXdxf","","","","","","","","","","","","","","","","","","","",""
"fr-devasahayam","Priest","Valan D. Rajkumar Devasahayam","","Resistance","kandigai-mcspx","","India","","OldRite","Fellay?","","","Lefebvre","","","Ordained June 29, 2004 by the SSPX","","","","","","","","","","","",""
"fr-ribas","Priest","Ramiro Martin Ribas","","Resistance","","Sedisvacantism","Spain","https://www.padreramiroribas.com/","ReordainedOldRite","Williamson","","","Lefebvre","","","","","","","","","","","","","","",""
"fr-rousseau","Priest","Dominique Rousseau","","Resistance","dominicans-avrille","","France","","OldRite","Fellay?","","","Lefebvre","sajm.secretariat@gmail.com","","left SSPX in 2019 after Huonder affair, ministers in France with Bp. Faure","","","","","","","","","","","",""
"fr-calixto","Priest","Fabio Calixto","","Resistance","","NonSede","Brazil","https://www.youtube.com/@fabiocalixto9635","OldRite","de Mallerais?","","","Lefebvre","secretaria@mosteirodasantacruz.org.br","","Ex-SSPX priest, joined Resistance in 2024, works with TradTalk YT channel","","","","","","","","","","","",""
"fr-tarcisio","Priest","Tarcísio","","Resistance","mosteiro-santa-cruz","NonSede","Brazil","","OldRite","","","","","secretaria@mosteirodasantacruz.org.br","","Serves mission chapels in Brazil","","","","","","","","","","","",""
"fr-luiz","Priest","Luiz Carlos de Souza","","Resistance","mosteiro-santa-cruz","NonSede","Brazil","","","","","","","secretaria@mosteirodasantacruz.org.br","","","","","","","","","","","","","",""
"bp-trinh","Bishop","Anton Tai Trinh","","Independent","lampasas-tx","NonSede","USA","https://archive.is/mSrPQ","OldRite","Slupski","OldRite","Slupski","Thuc","","","Vietnamese priest, persecuted under communism, left SSPX in 2011, worked with Fr. Ringrose, ministers in Texas. Contact Fr. Ringrose.","","","","","","","","","","","",""
"fr-ligan","Priest","June Mark Ligan","","SAJM","hjm-seminary","NonSede","Phillipines","https://archive.is/wip/Ca0JK","","","","","","","","","","","","","","","","","","","",""
"fr-john","Priest","John","","SAJM","hjm-seminary","","","https://archive.is/wip/V73Ky","","","","","","","","","","","","","","","","","","","",""
"fr-nass","Priest","Deivid Nass","","Resistance","mosteiro-santa-cruz","","","","","","","","","","","","","","","","","","","","","","",""`;

// Update default events data without IDs
const defaultEventsData = `"EventType","LocationID?","PriestID","DateStart","TimeStart?","DateEnd?","TimeEnd?","Repeats","OrganizerEMail","OrganizerPhone","GoogleMaps?","","","","","","","","","","","","","","","",""
"Mass","chantemerle-fr","fr-renoult","08.06.2025","10:30:00","","","","","","","","","","","","","","","","","","","","","",""
"Mass","dominicans-avrille","fr-renoult","19.06.2025","10:00:00","","","","","","","","","","","","","","","","","","","","","",""
"Mass","bourges-fr","fr-renoult","22.06.2025","10:30:00","","","","","","","","","","","","","","","","","","","","","",""
"Mass","yvignac-la-tours-fr","fr-renoult","29.06.2025","","","","","","","","","","","","","","","","","","","","","","",""
"Mass","thal-drulingen-fr","fr-renoult","03.08.2025","10:00:00","","","","","","","","","","","","","","","","","","","","","",""`;

// Remove cancelled events from default funding data
const defaultFundingData = `"CampaignID","ReligiousOrLocationOrEventID","FundingType","FundingGoal","FundingCurrency","CurrentAmount","DonationLinksMulti","Notes","","","","","","","","","","","","","","","","","","","",""
"discalced-carm-ongoing","","BuildParish","5177","USD","","paypal.me/StJosephCarmel","","","","","","","","","","","","","","","","","","","","",""
"fr-hewko-ongoing","fr-hewko","FundAPriest","","","","paypal.me/frhewko","","","","","","","","","","","","","","","","","","","","",""
"chapelle-pontmain","","BuildParish","","","","","https://archive.is/wip/HJCQh","","","","","","","","","","","","","","","","","","","",""
"fr-ruiz-ongoing","fr-ruiz","FundAPriest","","","","paypal.me/hugoruizv","","","","","","","","","","","","","","","","","","","","",""
"fr-ruiz-chapel","fr-ruiz","BuildParish","187500","USD","","","https://archive.is/wip/vixVd","","","","","","","","","","","","","","","","","","","",""
"","","","","","","paypal.me/tradcathsermons","","","","","","","","","","","","","","","","","","","","",""
"","","","","","","https://www.vakinha.com.br/vaquinha/ampliacao-do-seminario-imaculado-coracao-de-maria?utm_source=site&utm_medium=product-thanks-page","","","","","","","","","","","","","","","","","","","","",""
"","","","","","","https://www.paypal.com/paypalme/tradcathsermons","","","","","","","","","","","","","","","","","","","","",""`;

// Initialize map when DOM is loaded
document.addEventListener('DOMContentLoaded', init);

// Initialize function
async function init() {
  // Create map
  map = L.map('mapContainer', {
    minZoom: CONFIG.minZoom,
    maxZoom: CONFIG.maxZoom,
    zoomControl: true,
  }).setView([CONFIG.defaultLat, CONFIG.defaultLng], CONFIG.defaultZoom);
  
  // Add OpenFreeMap
  L.maplibreGL({
    style: 'https://tiles.openfreemap.org/styles/liberty',
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 16
  }).addTo(map);

  // Add layer groups to map
  connectionLines.addTo(map);
  parishMarkers.addTo(map);
  priestMarkers.addTo(map);
  
  // Set up event listeners
  setupEventListeners();
  
  // Load data (first from fallback, then from Google Sheets)
  await loadData();
}

// Set up event listeners
function setupEventListeners() {
  // Search input
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  
  searchInput.addEventListener('input', handleSearch);
  
  searchInput.addEventListener('focus', () => {
    if (searchResults.children.length > 0) {
      searchResults.style.display = 'flex';
    }
  });
  
  // Close button
  document.getElementById('closeBtn').addEventListener('click', () => {
    document.getElementById('infoPanel').style.display = 'none';
    closeCalendarPopup();
    resetAllMarkers();
  });
  
  // Close search results when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.style.display = 'none';
    }
  });
  
  // Handle light/dark mode
  const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (prefersDarkMode) {
    map.getContainer().classList.add('dark-map');
  }
  
  document.getElementById('zoomToLocationBtn').addEventListener('click', getUserLocation);

  // Listen for theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (e.matches) {
      map.getContainer().classList.add('dark-map');
    } else {
      map.getContainer().classList.remove('dark-map');
    }
  });
}

// Load data from fallback and Google Sheets
async function loadData() {
  await parseLocationsData(defaultLocationsData);
  parseReligiousData(defaultReligiousData);
  parseEventsData(defaultEventsData);
  parseFundingData(defaultFundingData);
  handleUrlHash();
  await fetchSheetData();
}

// Parse URL hash when page loads and focus on entity
function handleUrlHash() {
  const hash = window.location.hash;
  if (!hash || hash === '#') return;
  
  let entityId = hash.substring(1);
  let openCalendar = false;
  
  // Check if we need to open calendar
  if (entityId.endsWith(':cal')) {
    openCalendar = true;
    entityId = entityId.replace(':cal', '');
  }
  
  // Wait for data to be loaded before focusing
  const checkDataAndFocus = setInterval(() => {
    if (window.locations.length > 0 && window.religious.length > 0) {
      clearInterval(checkDataAndFocus);
      
      // Look for entity in locations first
      const location = window.locationMap.get(entityId);
      if (location) {
        showLocationInfo(location);
        if (openCalendar) {
          showLocationCalendar(location);
        }
        return;
      }
      
      // Then check religious people
      const person = window.religiousMap.get(entityId);
      if (person) {
        showPriestInfo(person);
        if (openCalendar) {
          showPriestCalendar(person);
        }
        return;
      }
      
      console.warn(`Entity with ID "${entityId}" not found.`);
    }
  }, 500);
}

// Update URL hash when an entity is selected
function updateUrlHash(entityId, isCalendar = false) {
  const newHash = isCalendar ? `#${entityId}:cal` : `#${entityId}`;
  
  // Use history.replaceState to update URL without page reload
  if (history.replaceState) {
    history.replaceState(null, null, newHash);
  } else {
    // Fallback for older browsers
    window.location.hash = newHash;
  }
}

// Copy current URL to clipboard
function copyCurrentUrlToClipboard() {
  try {
    navigator.clipboard.writeText(window.location.href).then(() => {
      // Show a temporary success message
      const message = document.createElement('div');
      message.textContent = '✓ Link copied!';
      message.style.position = 'fixed';
      message.style.top = '20px';
      message.style.left = '50%';
      message.style.transform = 'translateX(-50%)';
      message.style.backgroundColor = '#4CAF50';
      message.style.color = 'white';
      message.style.padding = '10px 20px';
      message.style.borderRadius = '4px';
      message.style.zIndex = '10000';
      document.body.appendChild(message);
      
      // Remove the message after 2 seconds
      setTimeout(() => {
        message.style.opacity = '0';
        message.style.transition = 'opacity 0.5s';
        setTimeout(() => document.body.removeChild(message), 500);
      }, 2000);
    });
  } catch (err) {
    console.error('Failed to copy URL: ', err);
    alert('Could not copy the link. Please copy it manually from the address bar.');
  }
}

// Generate PDF for calendar
function generateCalendarPDF(entityId, isLocation = true) {
  const entity = isLocation ? window.locationMap.get(entityId) : window.religiousMap.get(entityId);
  if (!entity) {
    console.error(`Entity with ID "${entityId}" not found.`);
    return;
  }
  
  const grid = document.getElementById('calendarGrid');
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  
  if (grid && grid.dataset.month && grid.dataset.year) {
    currentMonth = parseInt(grid.dataset.month, 10);
    currentYear = parseInt(grid.dataset.year, 10);
  }
  
  const currentMonthEvents = getEventsForMonth(currentMonth, currentYear, entityId, isLocation);
  const nextMonthEvents = getEventsForMonth((currentMonth + 1) % 12, 
                                           currentMonth === 11 ? currentYear + 1 : currentYear, 
                                           entityId, isLocation);
  
  const now = new Date();
  const allEvents = [...currentMonthEvents, ...nextMonthEvents].filter(event => 
    event.StartDate && event.StartDate > now
  );
  
  allEvents.sort((a, b) => a.StartDate - b.StartDate);
  
  const monthNames = [
    '$month-january$', '$month-february$', '$month-march$', '$month-april$', 
    '$month-may$', '$month-june$', '$month-july$', '$month-august$', 
    '$month-september$', '$month-october$', '$month-november$', '$month-december$'
  ];
  
  let contactInfo = '';
  
  const priestsList = [];
  if (isLocation) {
    if (entity.ReligiousIdArray && entity.ReligiousIdArray.length > 0) {
      entity.ReligiousIdArray.forEach(religiousId => {
        const priest = window.religiousMap.get(religiousId);
        if (priest) {
          priestsList.push({
            name: `${priest.Type || 'Fr.'} ${priest.Name}`,
            phone: priest.ContactPhone || '',
            email: priest.ContactEmail || ''
          });
        }
      });
    }
  } else {
    priestsList.push({
      name: `${entity.Type || 'Fr.'} ${entity.Name}`,
      phone: entity.ContactPhone || '',
      email: entity.ContactEmail || ''
    });
  }
  
  if (priestsList.length > 0) {
    contactInfo = priestsList.map(priest => {
      let info = priest.name;
      if (priest.phone) info += ` - ${priest.phone}`;
      if (priest.email) info += ` - ${priest.email}`;
      return info;
    }).join('<br>');
  }
  
  let mapUrl = '';
  if (isLocation) {
    if (entity.GoogleMaps) {
      mapUrl = entity.GoogleMaps;
    } else if (entity.Latitude && entity.Longitude) {
      mapUrl = `https://www.google.com/maps?q=${entity.Latitude},${entity.Longitude}`;
    }
  } else {
    const priestLocations = window.locations.filter(location => 
      location.ReligiousIdArray && location.ReligiousIdArray.includes(entity.ReligiousID)
    );
    
    if (priestLocations.length > 0) {
      const location = priestLocations[0];
      if (location.GoogleMaps) {
        mapUrl = location.GoogleMaps;
      } else if (location.Latitude && location.Longitude) {
        mapUrl = `https://www.google.com/maps?q=${location.Latitude},${location.Longitude}`;
      }
    }
  }
  
  const eventsPerPage = 8;
  const totalPages = Math.min(4, Math.ceil(allEvents.length / eventsPerPage));
  
  const entityUrl = `https://dubia.cc/${CONFIG.currentLanguage}/resistance#${entityId}`;
  
  const htmlParts = [];
  
  htmlParts.push(`<html>`);
  htmlParts.push(`<head>`);
  htmlParts.push(`  <title>${entity.Name} - ${monthNames[currentMonth]} ${currentYear}</title>`);
  htmlParts.push(`  <style>`);
  htmlParts.push(`    @media print {`);
  htmlParts.push(`      @page { size: A4; margin: 1cm; }`);
  htmlParts.push(`      body { font-family: Arial, sans-serif; margin: 0; padding: 0; }`);
  htmlParts.push(`      .page-break { page-break-after: always; }`);
  htmlParts.push(`      .parish-header { text-align: center; background-color: #000000; color: white; padding: 15px 0; margin-bottom: 20px; font-size: 18pt; font-weight: bold; }`);
  htmlParts.push(`      .event-columns { display: flex; flex-direction: row; justify-content: space-between; margin-bottom: 20px; }`);
  htmlParts.push(`      .event-column { width: 48%; }`);
  htmlParts.push(`      .event { margin-bottom: 15px; padding: 8px; border-left: 3px solid #700000; background-color: #f9f9f9; }`);
  htmlParts.push(`      .event-title { font-weight: bold; font-size: 12pt; margin-bottom: 5px; }`);
  htmlParts.push(`      .event-date { font-size: 10pt; margin-bottom: 5px; }`);
  htmlParts.push(`      .event-priest { font-style: italic; font-size: 10pt; }`);
  htmlParts.push(`      .notes-section { border-top: 1px solid #ddd; padding-top: 15px; margin-top: 20px; margin-bottom: 20px; }`);
  htmlParts.push(`      .notes-section h3 { margin-top: 0; margin-bottom: 10px; }`);
  htmlParts.push(`      .notes-lines { height: 150px; background-image: linear-gradient(#ddd 1px, transparent 1px); background-size: 100% 25px; }`);
  htmlParts.push(`      .footer { display: flex; border-top: 1px solid #ddd; padding-top: 15px; font-size: 10pt; }`);
  htmlParts.push(`      .qr-code { margin-right: 20px; }`);
  htmlParts.push(`      .footer-info { flex-grow: 1; }`);
  htmlParts.push(`      .link-text { margin-top: 5px; font-size: 9pt; }`);
  htmlParts.push(`    }`);
  htmlParts.push(`  </style>`);
  htmlParts.push(`</head>`);
  htmlParts.push(`<body>`);
  
  for (let page = 0; page < totalPages; page++) {
    const startIdx = page * eventsPerPage;
    const pageEvents = allEvents.slice(startIdx, startIdx + eventsPerPage);
    
    const midpoint = Math.ceil(pageEvents.length / 2);
    const leftColumnEvents = pageEvents.slice(0, midpoint);
    const rightColumnEvents = pageEvents.slice(midpoint);
    
    htmlParts.push(`<div class="page">`);
    htmlParts.push(`  <div class="parish-header">${entity.Name}</div>`);
    htmlParts.push(`  <div class="event-columns">`);
    htmlParts.push(`    <div class="event-column">`);
    
    leftColumnEvents.forEach(event => {
      const dateStr = event.StartDate ? formatDate(event.StartDate, { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      }) : '';
      
      const timeStr = event.StartDate ? formatTime(event.StartDate, event.Timezone) : '';
      
      let priestInfo = '';
      if (event.PriestID) {
        const priest = window.religiousMap.get(event.PriestID);
        if (priest) {
          priestInfo = `<div class="event-priest">${priest.Type || 'Fr.'} ${priest.Name}</div>`;
        }
      }
      
      htmlParts.push(`      <div class="event">`);
      htmlParts.push(`        <div class="event-title">${event.EventType || 'Event'}</div>`);
      htmlParts.push(`        <div class="event-date">${dateStr} - ${timeStr}</div>`);
      if (priestInfo) {
        htmlParts.push(`        ${priestInfo}`);
      }
      htmlParts.push(`      </div>`);
    });
    
    htmlParts.push(`    </div><div class="event-column">`);
    
    rightColumnEvents.forEach(event => {
      const dateStr = event.StartDate ? formatDate(event.StartDate, { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      }) : '';
      
      const timeStr = event.StartDate ? formatTime(event.StartDate, event.Timezone) : '';
      
      let priestInfo = '';
      if (event.PriestID) {
        const priest = window.religiousMap.get(event.PriestID);
        if (priest) {
          priestInfo = `<div class="event-priest">${priest.Type || 'Fr.'} ${priest.Name}</div>`;
        }
      }
      
      htmlParts.push(`      <div class="event">`);
      htmlParts.push(`        <div class="event-title">${event.EventType || 'Event'}</div>`);
      htmlParts.push(`        <div class="event-date">${dateStr} - ${timeStr}</div>`);
      if (priestInfo) {
        htmlParts.push(`        ${priestInfo}`);
      }
      htmlParts.push(`      </div>`);
    });
    
    htmlParts.push(`    </div></div>`);
    htmlParts.push(`  <div class="notes-section"><h3>$notes-title$</h3><div class="notes-lines"></div></div>`);
    htmlParts.push(`  <div class="footer">`);
    htmlParts.push(`    <div class="qr-code"><div class="qr-container" id="qrcode-${page}"></div><div class="link-text">${entityUrl}</div></div>`);
    htmlParts.push(`    <div class="footer-info">`);
    if (contactInfo) {
      htmlParts.push(`      <div>${contactInfo}</div>`);
    }
    if (mapUrl) {
      htmlParts.push(`      <div><a href="${mapUrl}" target="_blank">$view-on-maps$</a></div>`);
    }
    htmlParts.push(`      <div>dubia.cc/${CONFIG.currentLanguage}/resistance</div></div></div>`);
    
    if (page < totalPages - 1) {
      htmlParts.push('  <div class="page-break"></div>');
    }
    
    htmlParts.push('</div>');
  }
  
  htmlParts.push('</body></html>');
  
  const pdfHtml = htmlParts.join('\n');
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(pdfHtml);
  printWindow.document.close();
  
  printWindow.onload = function() {
    for (let page = 0; page < totalPages; page++) {
      const qrContainer = printWindow.document.getElementById(`qrcode-${page}`);
      if (qrContainer) {
        new QRCode(qrContainer, {
          text: `https://${entityUrl}`,
          width: 100,
          height: 100,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.M
        });
      }
    }
    
    setTimeout(() => {
      printWindow.print();
    }, 500);
  };
}

// Format date
function formatDate(date, options = {}) {
  const defaultOptions = {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  };
  
  return date.toLocaleDateString(CONFIG.currentLanguage || 'en', { ...defaultOptions, ...options });
}

// Format time
function formatTime(date, timezone) {
  if (!date) return '';
  
  try {
    return date.toLocaleTimeString(CONFIG.currentLanguage || 'en', {
      timeZone: timezone || 'UTC',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
  } catch (e) {
    return date.toLocaleTimeString(CONFIG.currentLanguage || 'en', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
  }
}

// Function to generate and download iCal file
function generateICalFile(entityId, isLocation = true) {
  const entity = isLocation ? window.locationMap.get(entityId) : window.religiousMap.get(entityId);
  if (!entity) {
    console.error(`Entity with ID "${entityId}" not found.`);
    return;
  }
  
  const grid = document.getElementById('calendarGrid');
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  
  if (grid && grid.dataset.month && grid.dataset.year) {
    currentMonth = parseInt(grid.dataset.month, 10);
    currentYear = parseInt(grid.dataset.year, 10);
  }
  
  const monthEvents = getEventsForMonth(currentMonth, currentYear, entityId, isLocation);
  
  if (monthEvents.length === 0) {
    alert('No events to export for this month.');
    return;
  }
  
  let iCalContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//DubiaCC//Resistance Calendar//EN',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    `X-WR-CALNAME:${entity.Name || 'Calendar'}`
  ];
  
  monthEvents.forEach((event, index) => {
    if (!event.StartDate) return;
    
    const startDate = formatDateForICal(event.StartDate);
    const endDate = event.EndDate ? formatDateForICal(event.EndDate) : startDate;
    
    const eventUid = `event-${index}-${startDate}@dubia.cc`;
    
    iCalContent.push('BEGIN:VEVENT');
    iCalContent.push(`UID:${eventUid}`);
    iCalContent.push(`DTSTAMP:${formatDateForICal(new Date())}`);
    iCalContent.push(`DTSTART:${startDate}`);
    iCalContent.push(`DTEND:${endDate}`);
    
    const summary = event.EventType || 'Event';
    iCalContent.push(`SUMMARY:${summary}`);
    
    if (isLocation) {
      const location = window.locationMap.get(event.LocationID);
      if (location) {
        iCalContent.push(`LOCATION:${location.Name}`);
        
        if (location.Latitude && location.Longitude) {
          iCalContent.push(`GEO:${location.Latitude};${location.Longitude}`);
        }
      }
    } else if (event.LocationID) {
      const location = window.locationMap.get(event.LocationID);
      if (location) {
        iCalContent.push(`LOCATION:${location.Name}`);
        
        if (location.Latitude && location.Longitude) {
          iCalContent.push(`GEO:${location.Latitude};${location.Longitude}`);
        }
      }
    }
    
    let description = '';
    if (event.Notes) {
      description += event.Notes;
    }
    
    if (event.PriestID) {
      const priest = window.religiousMap.get(event.PriestID);
      if (priest) {
        if (description) description += '\n\n';
        description += `Celebrant: ${priest.Type || 'Fr.'} ${priest.Name || ''}`;
      }
    }
    
    if (description) {
      description = description.replace(/\n/g, '\\n');
      description = description.replace(/,/g, '\\,');
      description = description.replace(/;/g, '\\;');
      iCalContent.push(`DESCRIPTION:${description}`);
    }
    
    if (event.PriestID) {
      const priest = window.religiousMap.get(event.PriestID);
      if (priest && priest.ContactEmail) {
        const email = priest.ContactEmail.replace('mailto:', '').trim();
        if (email) {
          iCalContent.push(`ORGANIZER;CN=${priest.Name}:mailto:${email}`);
        }
      }
    }
    
    iCalContent.push('STATUS:CONFIRMED');
    
    if (event.Repeats) {
      const rrule = generateRRule(event.Repeats);
      if (rrule) {
        iCalContent.push(rrule);
      }
    }
    
    iCalContent.push('END:VEVENT');
  });
  
  iCalContent.push('END:VCALENDAR');
  
  const iCalData = iCalContent.join('\r\n');
  downloadFile(iCalData, `${entity.Name || 'calendar'}.ics`, 'text/calendar');
}

// Format date for iCal
function formatDateForICal(date) {
  return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
}

// Generate RRULE from repeat pattern
function generateRRule(repeatPattern) {
  let freq = '';
  
  switch (repeatPattern.toLowerCase()) {
    case 'daily':
      freq = 'FREQ=DAILY';
      break;
    case 'weekly':
      freq = 'FREQ=WEEKLY';
      break;
    case 'every2weeks':
      freq = 'FREQ=WEEKLY;INTERVAL=2';
      break;
    case 'monthly':
    case 'everymonth':
      freq = 'FREQ=MONTHLY';
      break;
    case 'every2months':
      freq = 'FREQ=MONTHLY;INTERVAL=2';
      break;
    case 'yearly':
    case 'everyyear':
      freq = 'FREQ=YEARLY';
      break;
    default:
      return null;
  }
  
  return `RRULE:${freq}`;
}

// Download a file
function downloadFile(content, filename, contentType) {
  const blob = new Blob([content], { type: contentType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Run validation checks on data
function validateData() {
  const warnings = [];
  
  window.religious.forEach(person => {
    if (person.UsualLocationID && !window.locationMap.has(person.UsualLocationID)) {
      warnings.push(`Warning: Religious person "${person.Name}" has invalid UsualLocationID "${person.UsualLocationID}"`);
    }
  });
  
  window.religious.forEach(person => {
    if (person.Type?.toLowerCase() === 'priest' || person.Type?.toLowerCase() === 'bishop') {
      const hasParish = window.locations.some(location => 
        location.ReligiousIdArray && location.ReligiousIdArray.includes(person.ReligiousID)
      );
      
      if (!hasParish) {
        warnings.push(`Warning: ${person.Type} "${person.Name}" has no associated parish`);
      }
    }
  });
  
  window.events.forEach(event => {
    if (event.LocationID && !window.locationMap.has(event.LocationID)) {
      warnings.push(`Warning: Event has invalid LocationID "${event.LocationID}"`);
    }
  });
  
  window.events.forEach(event => {
    if (event.PriestID && !window.religiousMap.has(event.PriestID)) {
      warnings.push(`Warning: Event has invalid PriestID "${event.PriestID}"`);
    }
  });
  
  window.locations.forEach(location => {
    if (isNaN(location.Latitude) || isNaN(location.Longitude)) {
      warnings.push(`Warning: Location "${location.Name}" has invalid coordinates`);
    }
  });
  
  window.locations.forEach(location => {
    if (!location.ContactEmail && !location.ContactPhone && 
        !location.Website && !location.GoogleMaps) {
      warnings.push(`Warning: Location "${location.Name}" has no contact information`);
    }
  });
  
  window.locations.forEach(location => {
    if (location.ReligiousIdArray && location.ReligiousIdArray.length > 0) {
      location.ReligiousIdArray.forEach(id => {
        if (!window.religiousMap.has(id)) {
          warnings.push(`Warning: Location "${location.Name}" references non-existent religious ID "${id}"`);
        }
      });
    }
  });
  
  if (warnings.length > 0) {
    console.warn('Data validation warnings:');
    warnings.forEach(warning => console.warn(warning));
  } else {
    console.log('Data validation completed with no warnings.');
  }
  
  return warnings;
}

async function getTimezoneForLocation(lat, lng) {
  try {
    // geoTz returns an array, we usually want the first one
    const timezones = await GeoTZ.find(lat, lng);
    if (timezones && timezones.length > 0) {
      return timezones[0]; // e.g., "Europe/Berlin", "America/New_York"
    } else {
      console.warn(`Could not find timezone for ${lat}, ${lng}. Falling back to UTC.`);
      return 'UTC'; // Fallback
    }
  } catch (error) {
    console.error(`Error finding timezone for ${lat}, ${lng}:`, error);
    return 'UTC'; // Fallback on error
  }
}

// Function taken from https://github.com/freshp86/achilles-csv-parser 
// and minified to the essentials
// 
// Copyright 2020 Achilles CSV Parser Project Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
function parseCsv(csvData, transformer = null) {
  const rows = [];
  const headers = [];
  
  let isHeaderRow = false;
  let columnIndex = 0;
  let currentRow = {};
  let fieldStartIndex = -1;
  let currentIndex = 0;
  let inQuotes = false;
  let hasEscapedQuote = false;
  
  function processField() {
    const quoteAdjustment = csvData[currentIndex - 1] === '"' ? 1 : 0;
    let fieldValue = csvData.substring(fieldStartIndex + 1 + quoteAdjustment, currentIndex - quoteAdjustment);
    
    if (hasEscapedQuote) {
      fieldValue = fieldValue.replace(/""/g, '"');
    }
    
    if (isHeaderRow) {
      if (transformer) {
        const transformedValue = transformer(headers[columnIndex], fieldValue);
        if (transformedValue !== undefined) {
          currentRow[headers[columnIndex]] = transformedValue;
        }
      } else {
        currentRow[headers[columnIndex]] = fieldValue;
      }
      columnIndex++;
    } else {
      headers.push(fieldValue);
    }
    
    hasEscapedQuote = false;
    fieldStartIndex = currentIndex;
  }
  
  function finishRow() {
    processField();
    
    if (isHeaderRow) {
      rows.push(currentRow);
      currentRow = {};
      columnIndex = 0;
    } else {
      isHeaderRow = true;
    }
  }
  
  while (currentIndex < csvData.length) {
    const currentChar = csvData[currentIndex];
    
    if (inQuotes) {
      if (currentChar === '"') {
        if (csvData[currentIndex + 1] === '"') {
          currentIndex += 2;
          hasEscapedQuote = true;
        } else {
          inQuotes = false;
          currentIndex++;
          
          if (currentIndex === csvData.length) {
            finishRow();
          }
        }
      } else {
        currentIndex++;
      }
    } else {
      if (currentChar === ',') {
        processField();
      } else if (currentChar === '"') {
        inQuotes = true;
      } else if (currentChar === '\r') {
        finishRow();
        currentIndex++;
        fieldStartIndex = currentIndex;
      } else if (currentChar === '\n') {
        finishRow();
      } else if (currentIndex === csvData.length - 1) {
        currentIndex++;
        finishRow();
      }
      
      currentIndex++;
    }
  }
  
  return fixMangledJson(rows);
}

// Fix mangled JSON data where column headers are mixed with first row values in keys
function fixMangledJson(data) {
  if (!data || !data.length) return [];

  const extractHeaderAndFirstRowValue = (key) => {
    if (!key) return null;
    
    const parts = key.trim().split(' ');
    if (!parts.length) return null;
    
    const header = parts[0].replace(/\?$/, '');
    const firstRowValue = parts.slice(1).join(' ').trim();
    
    return { header, firstRowValue };
  };

  const processRow = (row) => {
    const normalizedRow = {};
    
    Object.keys(row).forEach(key => {
      const extracted = extractHeaderAndFirstRowValue(key);
      if (extracted && extracted.header) {
        normalizedRow[extracted.header] = row[key];
      }
    });
    
    return normalizedRow;
  };

  const headers = {};
  const firstRow = {};

  Object.keys(data[0]).forEach(key => {
    const extracted = extractHeaderAndFirstRowValue(key);
    if (extracted && extracted.header) {
      headers[extracted.header] = true;
      firstRow[extracted.header] = extracted.firstRowValue;
    }
  });

  const fixedData = [firstRow];
  data.forEach(row => {
    fixedData.push(processRow(row));
  });

  return fixedData;
};

// Parse locations CSV data
/**
 * Parse locations CSV data
 * @param {string} csvData Raw CSV string
 * @returns {Promise} Promise that resolves when parsing is complete
 */
 async function parseLocationsData(csvData) {
  const parsedData = parseCsv(csvData);
  
  // Process locations
  let newLocations = [];
  for (const location of parsedData) {
    // Fix location parsing (handling both comma and space separated coordinates)
    let lat = NaN, lng = NaN;
    if (location.Location) {
      // Use a robust regex for various separators and optional spaces
      const coordMatch = location.Location.match(/(-?\d+(?:\.\d+)?)\s*[,\s]\s*(-?\d+(?:\.\d+)?)/);
      if (coordMatch) {
        lat = parseFloat(coordMatch[1]);
        lng = parseFloat(coordMatch[2]);
      } else if (!isNaN(parseFloat(location.Location))) {
        // Maybe it's just Lat? Or Lon?
        console.warn(`Could only parse one coordinate for ${location.Name}: ${location.Location}`);
      }
    }
    
    // Fallback if Lat/Lon fields exist directly
    if (isNaN(lat) && location.Latitude) lat = parseFloat(location.Latitude);
    if (isNaN(lng) && location.Longitude) lng = parseFloat(location.Longitude);

    // Get timezone if coordinates are valid
    let timezone = 'UTC';
    
    if (!isNaN(lat) && !isNaN(lng)) { 
      timezone = await getTimezoneForLocation(lat, lng); 
    }

    // Create a new location object with all properties
    const newLocation = {
      ...location,
      Latitude: lat,
      Longitude: lng,
      ReligiousIdArray: location.ReligiousIdMulti ?
        location.ReligiousIdMulti.split(/[,\s]+/).filter(id => id.trim() !== "") : [],
      Timezone: timezone
    };

    newLocations.push(newLocation);
  }

  window.locations = newLocations.filter(loc => !isNaN(loc.Latitude) && !isNaN(loc.Longitude));
  
  // Update location map
  window.locationMap.clear();
  window.locations.forEach(location => {
    window.locationMap.set(location.LocationID, location);
  });
  
  // Update markers
  updateMapMarkers();
}

/**
 * Parse religious CSV data
 * @param {string} csvData Raw CSV string
 */
 function parseReligiousData(csvData) {
  const parsedData = parseCsv(csvData);
  
  // Process religious data
  window.religious = parsedData.map(person => {
    // Create a clean new object
    return { ...person };
  });
  
  // Update religious map
  window.religiousMap.clear();
  window.religious.forEach(person => {
    window.religiousMap.set(person.ReligiousID, person);
  });
  
  // Update markers
  updateMapMarkers();
}

/**
 * Parse events CSV data
 * @param {string} csvData Raw CSV string
 */
function parseEventsData(csvData) {
  const parsedData = parseCsv(csvData);
  window.events = parsedData.map(event => ({ ...event }));
  updateMapMarkers();
}

/**
 * Parse funding CSV data
 * @param {string} csvData Raw CSV string
 */
 function parseFundingData(csvData) {
  const parsedData = parseCsv(csvData);
  
  // Process funding data
  window.fundingData = parsedData;
  
  // Create lookup map for faster access
  window.fundingMap.clear();
  window.fundingData.forEach(funding => {
    window.fundingMap.set(funding.ReligiousOrLocationOrEventID, { ...funding });
  });
}

// Fetch data from Google Sheets
async function fetchSheetData() {
  const sheetId = CONFIG.sheetId;
  const sheets = ["locations", "religious", "events", "funding"]; // Removed "cancelled-events"
  
  for(const sheet of sheets) {
    const encodedSheetName = encodeURIComponent(sheet);
    const googleSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}&query=rows`;
    const proxyUrl = 'https://corsproxy.fermyon.app?url=';
    const corsProxyUrl = `${proxyUrl}${encodeURIComponent(googleSheetUrl)}`;
    
    try {
      const response = await fetch(corsProxyUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch ${sheet} data: ${response.status}`);
      }
      const csvText = await response.text();

      if (sheet === "locations") {
        await parseLocationsData(csvText);
      } else if (sheet === "religious") {
        parseReligiousData(csvText);
      } else if (sheet === "events") {
        parseEventsData(csvText);
      } else if (sheet === "funding") {
        parseFundingData(csvText);
      }
    } catch (e) {
      console.error(`Error loading ${sheet} data:`, e);
      console.log(`Using fallback data for ${sheet}`);
    }
  }

  handleUrlHash();
  validateData();
}

// Update map markers - completely rewritten approach
function updateMapMarkers() {
  // Clear existing markers and lines
  priestMarkers.clearLayers();
  parishMarkers.clearLayers();
  connectionLines.clearLayers();
  
  // Create all parish markers first (all red, same size)
  window.locations.forEach(location => {
    createParishMarker(location);
  });
  
  // Create connection patterns for each priest
  createConnectionPatternsForAllPriests();
}

function createParishMarker(location) {
  if (!location.Latitude || !location.Longitude || 
      isNaN(location.Latitude) || isNaN(location.Longitude)) {
    return;
  }
  
  // All parishes are red dots of the same size - let CSS handle styling
  const markerSize = CONFIG.parishMarkerSize;
  const icon = L.divIcon({
    className: 'parish-marker',
    html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
    iconSize: [markerSize, markerSize],
    iconAnchor: [markerSize/2, markerSize/2]
  });
  
  const marker = L.marker([location.Latitude, location.Longitude], { icon })
    .addTo(parishMarkers);
  
  // Store location data with marker
  marker.locationData = location;
  
  // Add click handler
  marker.on('click', function() {
    showLocationInfo(location);
  });
  
  return marker;
}

// Create connection patterns for all priests
function createConnectionPatternsForAllPriests() {
  window.religious.forEach(priest => {
    // Find all locations this priest serves
    const priestLocations = window.locations.filter(location => 
      location.ReligiousIdArray && location.ReligiousIdArray.includes(priest.ReligiousID)
    );
    
    if (priestLocations.length === 0) return;
    
    // Check if priest has a usual location ID
    const usualLocation = priest.UsualLocationID ? 
      window.locationMap.get(priest.UsualLocationID) : null;
    
    if (usualLocation && priestLocations.some(loc => loc.LocationID === priest.UsualLocationID)) {
      // Case 1: Priest has usual location - draw lines from usual location to all others
      createStarPatternFromUsualLocation(priest, usualLocation, priestLocations);
    } else if (priestLocations.length > 1) {
      // Case 2: No usual location, multiple locations - create center point with star pattern
      createCenterPointStarPattern(priest, priestLocations);
    } else {
      // Case 3: Single location - just create priest marker at that location
      const location = priestLocations[0];
      createPriestMarker(priest, location.Latitude, location.Longitude);
    }
  });
}

// Create star pattern from usual location
function createStarPatternFromUsualLocation(priest, usualLocation, allLocations) {
  // Only create priest marker at usual location if it's NOT already a parish location
  // or create it slightly offset to avoid overlap
  const isParishLocation = window.locations.some(loc => 
    loc.LocationID === usualLocation.LocationID
  );
  
  if (isParishLocation) {
    // Create priest marker slightly offset from parish marker
    const offsetLat = usualLocation.Latitude + 0.001; // Small offset
    const offsetLng = usualLocation.Longitude + 0.001;
    createPriestMarker(priest, offsetLat, offsetLng);
  } else {
    // Create priest marker at exact location if it's not a parish
    createPriestMarker(priest, usualLocation.Latitude, usualLocation.Longitude);
  }
  
  // Draw lines from usual location to all other locations
  allLocations.forEach(location => {
    if (location.LocationID !== usualLocation.LocationID) {
      const line = L.polyline([
        [usualLocation.Latitude, usualLocation.Longitude],
        [location.Latitude, location.Longitude]
      ], {
        color: CONFIG.lineColor,
        weight: CONFIG.lineWeight,
        opacity: CONFIG.lineOpacity
      }).addTo(connectionLines);
      
      // Store data with the line
      line.religiousId = priest.ReligiousID;
      line.fromLocation = usualLocation.LocationID;
      line.toLocation = location.LocationID;
    }
  });
}

// Create center point star pattern
function createCenterPointStarPattern(priest, locations) {
  // Calculate center point (average of all coordinates)
  let totalLat = 0;
  let totalLng = 0;
  let validCount = 0;
  
  locations.forEach(location => {
    if (!isNaN(location.Latitude) && !isNaN(location.Longitude)) {
      totalLat += location.Latitude;
      totalLng += location.Longitude;
      validCount++;
    }
  });
  
  if (validCount === 0) return;
  
  const centerLat = totalLat / validCount;
  const centerLng = totalLng / validCount;
  
  // Create priest marker at center point
  createPriestMarker(priest, centerLat, centerLng);
  
  // Draw lines from center to all locations
  locations.forEach(location => {
    if (!isNaN(location.Latitude) && !isNaN(location.Longitude)) {
      const line = L.polyline([
        [centerLat, centerLng],
        [location.Latitude, location.Longitude]
      ], {
        color: CONFIG.lineColor,
        weight: CONFIG.lineWeight,
        opacity: CONFIG.lineOpacity
      }).addTo(connectionLines);
      
      // Store data with the line
      line.religiousId = priest.ReligiousID;
      line.fromLocation = 'center';
      line.toLocation = location.LocationID;
    }
  });
}

// Updated priest marker creation - small blue dots
function createPriestMarker(priest, lat, lng) {
  const markerSize = CONFIG.priestMarkerSize;
  const icon = L.divIcon({
    className: 'priest-marker pulse',
    html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
    iconSize: [markerSize, markerSize],
    iconAnchor: [markerSize/2, markerSize/2]
  });
  
  const marker = L.marker([lat, lng], { icon })
    .addTo(priestMarkers);
  
  // Store priest data with marker
  marker.priestData = priest;
  
  // Add click handler
  marker.on('click', function() {
    showPriestInfo(priest);
  });
  
  return marker;
}

// Create connection lines between religious and their locations
function createConnectionLines(location) {
  if (!location.ReligiousIdArray || !location.Latitude || !location.Longitude) {
    return;
  }
  
  // For each religious person associated with this location
  location.ReligiousIdArray.forEach(religiousId => {
    const person = window.religiousMap.get(religiousId);
    if (!person) return;
    
    // Find all other locations for this religious person
    window.locations.forEach(otherLocation => {
      if (otherLocation.LocationID === location.LocationID) return; // Skip self
      
      if (otherLocation.ReligiousIdArray.includes(religiousId)) {
        // Create a line between locations
        const latlngs = [
          [location.Latitude, location.Longitude],
          [otherLocation.Latitude, otherLocation.Longitude]
        ];
        
        const line = L.polyline(latlngs, {
          color: CONFIG.lineColor,
          weight: CONFIG.lineWeight,
          opacity: CONFIG.lineOpacity
        }).addTo(connectionLines);
        
        // Store data with the line
        line.religiousId = religiousId;
        line.fromLocation = location.LocationID;
        line.toLocation = otherLocation.LocationID;
      }
    });
    
    // Create priest marker at this location
    createPriestMarker(person, location.Latitude, location.Longitude);
  });
}

function findParishAtCoordinates(lat, lng) {
  let foundParish = null;
  
  parishMarkers.eachLayer(marker => {
    if (marker.locationData && 
        marker.getLatLng().lat === lat && 
        marker.getLatLng().lng === lng) {
      foundParish = marker.locationData;
    }
  });
  
  return foundParish;
}

// Approximate location from country or region name
function approximateLocationFromName(locationName) {
  if (!locationName) return null;
  
  const locationMap = {
    'England': { lat: 51.5074, lng: -0.1278 },
    'UK': { lat: 51.5074, lng: -0.1278 },
    'USA': { lat: 39.8283, lng: -98.5795 },
    'France': { lat: 46.2276, lng: 2.2137 },
    'Germany': { lat: 51.1657, lng: 10.4515 },
    'Italy': { lat: 41.8719, lng: 12.5674 },
    'Spain': { lat: 40.4637, lng: -3.7492 },
    'Poland': { lat: 51.9194, lng: 19.1451 },
    'Ireland': { lat: 53.1424, lng: -7.6921 },
    'Brazil': { lat: -14.2350, lng: -51.9253 },
    'Argentina': { lat: -38.4161, lng: -63.6167 },
    'Mexico': { lat: 23.6345, lng: -102.5528 },
    'Canada': { lat: 56.1304, lng: -106.3468 },
    'Australia': { lat: -25.2744, lng: 133.7751 },
    'New Zealand': { lat: -40.9006, lng: 174.8860 },
    'Philippines': { lat: 12.8797, lng: 121.7740 },
    'Austria': { lat: 47.5162, lng: 14.5501 },
    'Switzerland': { lat: 46.8182, lng: 8.2275 },
    'Belgium': { lat: 50.5039, lng: 4.4699 },
    'Netherlands': { lat: 52.1326, lng: 5.2913 },
    'Portugal': { lat: 39.3999, lng: -8.2245 },
    'Europe': { lat: 48.8566, lng: 9.3522 }
  };
  
  // Check for direct match
  for (const [key, coords] of Object.entries(locationMap)) {
    if (locationName.includes(key)) {
      return coords;
    }
  }
  
  // Add small random offset to default location to prevent markers from stacking
  return { 
    lat: CONFIG.defaultLat + (Math.random() * 2 - 1), 
    lng: CONFIG.defaultLng + (Math.random() * 2 - 1) 
  };
}

function closeCalendarPopup() {
  const calendarPopup = document.getElementById('calendarPopup');
  if (calendarPopup) {
    calendarPopup.style.display = 'none';
    
    // Get the current hash and remove the :cal suffix if present
    const currentHash = window.location.hash;
    if (currentHash && currentHash.endsWith(':cal')) {
      const entityId = currentHash.substring(1).replace(':cal', '');
      updateUrlHash(entityId, false); // Update URL to entity ID without calendar
    }
  }
}

// Returns a standard JS Date (which is UTC-based) correctly representing that instant,
// AND the timezone string for formatting later.
function createZonedDateTime(dateStr, timeStr, timezone) {
  if (!dateStr || !timezone) {
      console.warn("Cannot create zoned date time without date string or timezone.");
      return null;
  }

  // 1. Parse date components (robustly)
  let day, month, year;
  const datePartsMatch = dateStr.match(/(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{4})/); // Handles DD.MM.YYYY, MM/DD/YYYY
  if (datePartsMatch) {
    // Try DD.MM.YYYY first (common European)
    if (dateStr.includes('.')) {
        day = parseInt(datePartsMatch[1], 10);
        month = parseInt(datePartsMatch[2], 10) - 1; // JS month index
        year = parseInt(datePartsMatch[3], 10);
    }
    // Try MM/DD/YYYY (common US)
    else if (dateStr.includes('/')) {
        month = parseInt(datePartsMatch[1], 10) - 1; // JS month index
        day = parseInt(datePartsMatch[2], 10);
        year = parseInt(datePartsMatch[3], 10);
    } else {
        // Default assumption or fallback (e.g. assume DD.MM if no separator info?) - Risky
        day = parseInt(datePartsMatch[1], 10);
        month = parseInt(datePartsMatch[2], 10) - 1;
        year = parseInt(datePartsMatch[3], 10);
    }
  } else {
      // Try YYYY-MM-DD
       const isoMatch = dateStr.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
       if (isoMatch) {
           year = parseInt(isoMatch[1], 10);
           month = parseInt(isoMatch[2], 10) - 1;
           day = parseInt(isoMatch[3], 10);
       } else {
            console.warn(`Could not parse date format: ${dateStr}`);
            return null; // Cannot proceed
       }
  }


  // Validate basic date components
  if (isNaN(day) || isNaN(month) || isNaN(year) || month < 0 || month > 11 || day < 1 || day > 31) {
      console.warn(`Invalid date components parsed from ${dateStr}: D=${day}, M=${month + 1}, Y=${year}`);
      return null;
  }

  // 2. Parse time components (or default to 00:00:00)
  let hour = 0, minute = 0, second = 0;
  if (timeStr) {
    const timeMatch = String(timeStr).match(/(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/);
    if (timeMatch) {
      hour = parseInt(timeMatch[1], 10);
      minute = parseInt(timeMatch[2], 10);
      second = timeMatch[3] ? parseInt(timeMatch[3], 10) : 0;

       // Validate time components
        if (isNaN(hour) || isNaN(minute) || isNaN(second) || hour < 0 || hour > 23 || minute < 0 || minute > 59 || second < 0 || second > 59) {
             console.warn(`Invalid time components parsed from ${timeStr}. Using 00:00:00.`);
             hour = 0; minute = 0; second = 0;
        }

    } else {
         console.warn(`Could not parse time format: ${timeStr}. Using 00:00:00.`);
    }
  }

  // 3. Construct an ISO-like string *without timezone suffix* representing the LOCAL time.
  // Pad month and day for ISO format compatibility (YYYY-MM-DDTHH:mm:ss)
   const localISO = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;

  // 4. Use Intl to correctly interpret this local time string *within the target timezone*
  // This is tricky. We need to find the UTC instant corresponding to this local time.
  // Strategy: Create a formatter for the target zone, format a known date (like Unix epoch)
  // in both target zone and UTC, calculate the offset *at that time*, then apply it.
  // Simpler strategy: Format the target local time to components in the *target* zone,
  // then use those components to construct a UTC date.

   try {
       // Create a formatter for the *target* timezone, requesting ALL components
       const formatter = new Intl.DateTimeFormat('en-CA', { // Use locale that gives YYYY-MM-DD
           timeZone: timezone,
           year: 'numeric', month: '2-digit', day: '2-digit',
           hour: '2-digit', minute: '2-digit', second: '2-digit',
           hour12: false // Use 24-hour clock for Date.UTC
       });

        // Construct a Date object TEMPORARILY assuming the components ARE UTC
        // This is just to get a Date object to pass to the formatter. The actual
        // time value might be wrong, but we only need it to calculate the correct offset.
       const tempUTCDateForOffsetCalc = new Date(Date.UTC(year, month, day, hour, minute, second));

       // Format this temporary date IN THE TARGET TIMEZONE to see what local time it corresponds to THERE.
       const parts = formatter.formatToParts(tempUTCDateForOffsetCalc);
       const zonedParts = {};
       parts.forEach(p => { if(p.type !== 'literal') zonedParts[p.type] = p.value; });

       // Now, construct the DEFINITIVE UTC timestamp using the components AS THEY APPEAR LOCALLY
       // in the target timezone. This essentially reverses the timezone offset correctly.
       // Note: `Intl` might give slightly different hour/day due to DST when formatting.
       // It's usually better to construct the local ISO string and find its offset.

       // --- More Reliable Method ---
       // Find the offset for the target timezone *at the approximate date*
       const roughDate = new Date(Date.UTC(year, month, day, 12)); // Midday avoids some DST edge cases
       const offsetMinutes = getOffsetMinutesAtDate(roughDate, timezone);

       // Construct the UTC time from components, THEN subtract the calculated offset
       // This gives the UTC instant that *corresponds* to the desired local time YYYY-MM-DD HH:MM:SS
       // in the target zone.
       const intendedUTCTime = Date.UTC(year, month, day, hour, minute, second);
       const actualInstantEpoch = intendedUTCTime - (offsetMinutes * 60 * 1000);

       const finalDate = new Date(actualInstantEpoch);

        // Sanity check: Format the result back using the target timezone
        // const checkFormatter = new Intl.DateTimeFormat('en-US', { timeZone: timezone, dateStyle: 'short', timeStyle: 'medium' });
        // console.log(`Created date for ${dateStr} ${timeStr || ''} [${timezone}]: ${finalDate.toISOString()}, checks as ${checkFormatter.format(finalDate)}`);

       return { date: finalDate, timezone: timezone }; // Return Date object and timezone string

   } catch (e) {
       console.error(`Error creating zoned date time for ${localISO} in ${timezone}:`, e);
       // Fallback: Try creating date assuming local components are UTC (likely wrong offset)
       try {
           const fallbackDate = new Date(Date.UTC(year, month, day, hour, minute, second));
           console.warn("Falling back to UTC interpretation.");
           return { date: fallbackDate, timezone: 'UTC'}; // Fallback timezone
       } catch (finalError) {
           console.error("Fallback date creation failed:", finalError);
           return null;
       }
   }
}

function getOffsetMinutesAtDate(date, timezone) {
  try {
      const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: timezone,
          timeZoneName: 'longOffset', // Request offset like GMT-05:00
      });
      const parts = formatter.formatToParts(date);
      const offsetPart = parts.find(p => p.type === 'timeZoneName');

      if (offsetPart) {
          const offsetMatch = offsetPart.value.match(/GMT([+-])(\d{1,2}):?(\d{2})?/);
          if (offsetMatch) {
              const sign = offsetMatch[1] === '+' ? 1 : -1;
              const hours = parseInt(offsetMatch[2], 10);
              const minutes = offsetMatch[3] ? parseInt(offsetMatch[3], 10) : 0;
              return sign * (hours * 60 + minutes);
          }
      }
      
      console.warn(`Could not parse offset from Intl: ${offsetPart?.value} for ${timezone}`);

  } catch (e) {
      console.error(`Error getting offset for ${timezone}:`, e);
  }
    // Fallback: estimate from current local offset (less accurate for past/future dates)
    console.warn(`Falling back to local offset estimation for ${timezone}`);
    return -(new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTimezoneOffset());
}

function formatZonedTime(date, timezone, options = {}) {
    if (!(date instanceof Date) || !timezone) return '';
    try {
        const defaultOptions = {
            timeZone: timezone,
            hour: 'numeric', // Use 'numeric' or '2-digit'
            minute: '2-digit',
             // Optionally show timezone name:
             // timeZoneName: 'short' // e.g., PST, CET, EST
        };
        return date.toLocaleTimeString(CONFIG.currentLanguage || 'en', { ...defaultOptions, ...options });
    } catch (e) {
        console.error(`Error formatting time for zone ${timezone}:`, e);
        // Fallback to UTC time display
        return date.toLocaleTimeString(CONFIG.currentLanguage || 'en', { timeZone: 'UTC', hour: 'numeric', minute: '2-digit', timeZoneName: 'short' }) + " (UTC Fallback)";
    }
}

// Refined Formatting Function (Example for Date)
function formatZonedDate(date, timezone, options = {}) {
     if (!(date instanceof Date) || !timezone) return '';
     try {
         const defaultOptions = {
             timeZone: timezone,
             year: 'numeric',
             month: 'long', // or 'short', 'numeric', '2-digit'
             day: 'numeric', // or '2-digit'
              // weekday: 'long' // optional
         };
         return date.toLocaleDateString(CONFIG.currentLanguage || 'en', { ...defaultOptions, ...options });
     } catch (e) {
         console.error(`Error formatting date for zone ${timezone}:`, e);
         return date.toLocaleDateString(CONFIG.currentLanguage || 'en', { timeZone: 'UTC' }) + " (UTC Fallback)";
     }
}

// Get events for current month
function getEventsForMonth(month, year, entityId, isLocation = true) {
    let targetTimezone = 'UTC';
    let associatedLocation = null;
    
    if (isLocation) {
        associatedLocation = window.locationMap.get(entityId);
    } else {
        const priestLocations = window.locations.filter(location =>
            location.ReligiousIdArray && location.ReligiousIdArray.includes(entityId)
        );
        if (priestLocations.length > 0) {
             associatedLocation = priestLocations[0];
        }
    }
    
    if (associatedLocation && associatedLocation.Timezone) {
        targetTimezone = associatedLocation.Timezone;
    }

    const potentiallyRelevantEvents = window.events.filter(event => {
        const entityMatches = isLocation ? (event.LocationID === entityId) : (event.PriestID === entityId);
        if (!entityMatches) return false;

        const eventLocationId = event.LocationID;
        const eventLocation = window.locationMap.get(eventLocationId);
        const eventTimezone = eventLocation?.Timezone || 'UTC';

        const startZdtResult = createZonedDateTime(event.DateStart, event.TimeStart, eventTimezone);
        if (!startZdtResult) return false;
        const eventStartDate = startZdtResult.date;

        const repeats = event.Repeats || '';

        const startOfMonthZdtResult = createZonedDateTime(`${year}-${month + 1}-01`, '00:00:00', targetTimezone);
        if (!startOfMonthZdtResult) return false;
        const startOfMonth = startOfMonthZdtResult.date;

        const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));
        const endOfMonthZdtResult = createZonedDateTime(
            `${lastDayOfMonth.getUTCFullYear()}-${String(lastDayOfMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfMonth.getUTCDate()).padStart(2, '0')}`,
            '23:59:59',
            targetTimezone
        );
        if (!endOfMonthZdtResult) return false;
        const endOfMonth = endOfMonthZdtResult.date;

        if (!repeats) {
            const endZdtResult = createZonedDateTime(event.DateEnd || event.DateStart, event.TimeEnd, eventTimezone);
            const actualEndDate = endZdtResult ? endZdtResult.date : null;

            if (actualEndDate) {
                return eventStartDate.getTime() <= endOfMonth.getTime() && actualEndDate.getTime() >= startOfMonth.getTime();
            } else {
                return eventStartDate.getTime() >= startOfMonth.getTime() && eventStartDate.getTime() <= endOfMonth.getTime();
            }
        } else {
            return eventStartDate.getTime() <= endOfMonth.getTime();
        }
    });

    const startOfMonthZdtResult = createZonedDateTime(`${year}-${month + 1}-01`, '00:00:00', targetTimezone);
    const startOfMonth = startOfMonthZdtResult ? startOfMonthZdtResult.date : new Date(Date.UTC(year, month, 1));

    const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));
    const endOfMonthZdtResult = createZonedDateTime(
       `${lastDayOfMonth.getUTCFullYear()}-${String(lastDayOfMonth.getUTCMonth() + 1).padStart(2, '0')}-${String(lastDayOfMonth.getUTCDate()).padStart(2, '0')}`,
       '23:59:59',
       targetTimezone
    );
    const endOfMonth = endOfMonthZdtResult ? endOfMonthZdtResult.date : new Date(Date.UTC(year, month + 1, 0, 23, 59, 59));

    let expandedEvents = [];

    potentiallyRelevantEvents.forEach(event => {
        const eventLocationId = event.LocationID;
        const eventLocation = window.locationMap.get(eventLocationId);
        const eventTimezone = eventLocation?.Timezone || 'UTC';

        const seriesStartZdtResult = createZonedDateTime(event.DateStart, event.TimeStart, eventTimezone);
        if (!seriesStartZdtResult) return;
        let seriesStartDate = seriesStartZdtResult.date;

        const seriesEndZdtResult = event.DateEnd ? createZonedDateTime(event.DateEnd, event.TimeEnd, eventTimezone) : null;
        let seriesEndDate = seriesEndZdtResult ? seriesEndZdtResult.date : null;

        let durationMs = 2 * 60 * 60 * 1000;
        if (seriesEndDate && event.TimeEnd) {
            durationMs = seriesEndDate.getTime() - seriesStartDate.getTime();
        } else if (!seriesEndDate && event.TimeStart) {
             const endOfDayZdtResult = createZonedDateTime(event.DateStart, '23:59:59', eventTimezone);
             if (endOfDayZdtResult) {
                  durationMs = endOfDayZdtResult.date.getTime() - seriesStartDate.getTime();
             }
        }
        if (durationMs <= 0) durationMs = 2 * 60 * 60 * 1000;

        const repeats = event.Repeats || '';
        let currentDate = new Date(seriesStartDate);

        const loopUntilDate = seriesEndDate ?
             new Date(Math.min(seriesEndDate.getTime(), endOfMonth.getTime()))
             : endOfMonth;

        while (currentDate.getTime() <= loopUntilDate.getTime()) {
             if (currentDate.getTime() >= startOfMonth.getTime() && currentDate.getTime() <= endOfMonth.getTime()) {
                  const instanceEndDate = new Date(currentDate.getTime() + durationMs);
                  const eventCopy = {
                      ...event,
                      StartDate: new Date(currentDate),
                      EndDate: instanceEndDate,
                      Timezone: eventTimezone,
                      OriginalDateStart: event.DateStart,
                      OriginalDateEnd: event.DateEnd
                  };
                  expandedEvents.push(eventCopy);
             }

            if (!repeats) break;

            const previousLoopDate = new Date(currentDate);
            switch (repeats.toLowerCase()) {
                case 'daily': currentDate.setUTCDate(currentDate.getUTCDate() + 1); break;
                case 'weekly': currentDate.setUTCDate(currentDate.getUTCDate() + 7); break;
                case 'every2weeks': currentDate.setUTCDate(currentDate.getUTCDate() + 14); break;
                case 'monthly':
                case 'everymonth':
                    currentDate.setUTCMonth(currentDate.getUTCMonth() + 1); break;
                case 'every2months':
                     currentDate.setUTCMonth(currentDate.getUTCMonth() + 2); break;
                case 'yearly':
                case 'everyyear':
                     currentDate.setUTCFullYear(currentDate.getUTCFullYear() + 1); break;
                 default:
                    console.warn(`Unknown repeat type: ${repeats}`);
                    currentDate = new Date(loopUntilDate.getTime() + 1);
                    break;
            }

             if (currentDate.getTime() <= previousLoopDate.getTime()) {
                 console.error(`Date didn't advance. Loop detected. Breaking.`);
                 break;
             }
             if (currentDate.getTime() > loopUntilDate.getTime() && repeats) {
                break;
            }
        }
    });

    return expandedEvents;
}

// Get upcoming events
function getUpcomingEvents(entityId, isLocation = true, limit = 3) {
  const now = new Date();
  let currentMonth = now.getMonth();
  let currentYear = now.getFullYear();
  
  const allEvents = [];
  const maxMonthsToSearch = 12; // Search up to 12 months ahead
  let monthsSearched = 0;
  
  // Search across multiple months until we find enough events or reach the limit
  while (allEvents.length < limit && monthsSearched < maxMonthsToSearch) {
    const monthEvents = getEventsForMonth(currentMonth, currentYear, entityId, isLocation);
    allEvents.push(...monthEvents);
    
    // Move to next month
    currentMonth++;
    monthsSearched++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
  }
  
  // Filter for future events
  const futureEvents = allEvents.filter(event => {
    return event.StartDate && event.StartDate > now;
  });
  
  // Sort by date and return limited number of events
  futureEvents.sort((a, b) => a.StartDate - b.StartDate);
  return futureEvents.slice(0, limit);
}

function getEventsForDay(entityId, year, month, day, isLocation = true) {
  // --- Determine Context Timezone (for header/day range) ---
  let contextTimezone = 'UTC';
  const entityLocation = isLocation ? window.locationMap.get(entityId) : window.locations.find(l => l.ReligiousIdArray?.includes(entityId));
  if (entityLocation?.Timezone) {
    contextTimezone = entityLocation.Timezone;
  }
  
  // --- Determine Date Range for the selected day in Context Timezone ---
  const targetDayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  const startOfDayZdt = createZonedDateTime(targetDayStr, '00:00:00', contextTimezone);
  const endOfDayZdt = createZonedDateTime(targetDayStr, '23:59:59', contextTimezone);

  if (!startOfDayZdt || !endOfDayZdt) {
    console.error('Error calculating date range for this day.');
    return [];
  }
  
  const targetDayStart = startOfDayZdt.date; // The UTC instant representing start of day
  const targetDayEnd = endOfDayZdt.date;     // The UTC instant representing end of day

  // Get all expanded events for the month
  const allMonthEvents = getEventsForMonth(month, year, entityId, isLocation);

  // Filter for events whose *start time* (UTC instant) falls within the calculated day range
  const dayEvents = allMonthEvents.filter(eventInstance => {
    if (!eventInstance?.StartDate) return false;
    const eventStartMs = eventInstance.StartDate.getTime();
    return eventStartMs >= targetDayStart.getTime() && eventStartMs <= targetDayEnd.getTime();
  });

  // Sort events by their start time (epoch comparison is fine)
  return dayEvents.sort((a, b) => a.StartDate.getTime() - b.StartDate.getTime());
}

// Function to get translated religious type
function getTranslatedReligiousType(type) {
  if (!type) return 'Fr.'; // Default fallback
  
  // Fallbacks for common types if translations aren't available
  const fallbacks = {
    'bishop': '$$title-bishop$$',
    'priest': '$$title-priest$$',
    'father': '$$title-priest$$',
    'sister': '$$title-sister$$',
    'mother': '$$title-mother$$',
    'brother': '$$title-brother$$'
  };
  
  return fallbacks[type.toLowerCase()] || type;
}

// Function to validate URLs
function isValidUrl(urlString) {
  if (!urlString) return false;
  urlString = urlString.trim();
  if (urlString === '') return false;
  
  // Basic URL validation
  try {
    new URL(urlString);
    return true;
  } catch (e) {
    return false;
  }
}


//----------------------------------------------------
// Function: showUpcomingEvents
// Purpose: Displays a list of the next few upcoming events.
// Uses:    getUpcomingEvents, formatZonedDate, formatZonedTime,
//          locationMap, religiousMap
//----------------------------------------------------
function showUpcomingEvents(entityId, isLocation = true) {
  const eventsEl = document.getElementById('calendarEvents');
  if (!eventsEl) {
    console.error("Calendar events display element not found!");
    return;
  }
  eventsEl.innerHTML = '';

  const upcomingHeading = document.createElement('h3');
  upcomingHeading.textContent = 'Upcoming Events';
  eventsEl.appendChild(upcomingHeading);

  const upcomingEvents = getUpcomingEvents(entityId, isLocation);

  if (upcomingEvents.length === 0) {
    const noEventsEl = document.createElement('p');
    noEventsEl.textContent = 'No upcoming events scheduled.';
    eventsEl.appendChild(noEventsEl);
  } else {
    const clickMessage = document.createElement('p');
    clickMessage.textContent = 'Click a date on the calendar to see events for that day.';
    clickMessage.style.fontStyle = 'italic';
    clickMessage.style.fontSize = '0.9em';
    clickMessage.style.color = 'grey';
    eventsEl.appendChild(clickMessage);

    upcomingEvents.forEach(event => {
      const eventEl = document.createElement('div');
      eventEl.className = 'calendar-event';

      const headerEl = document.createElement('div');
      headerEl.className = 'calendar-event-header';
      headerEl.style.fontWeight = 'bold';
      
      let headerText = '';
      
      if (event.StartDate) {
        headerText += formatZonedDate(event.StartDate, event.Timezone, { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
      }
      
      headerText += ` - ${event.EventType || 'Event'}`;
      
      if (event.StartDate) {
        headerText += ` - ${formatZonedTime(event.StartDate, event.Timezone, { timeZoneName: 'short' })}`;
      }
      
      headerEl.textContent = headerText;
      eventEl.appendChild(headerEl);

      if (isLocation && event.PriestID) {
        const priest = window.religiousMap.get(event.PriestID);
        if (priest) {
          const priestEl = document.createElement('div');
          priestEl.className = 'calendar-event-priest';
          const translatedType = getTranslatedReligiousType(priest.Type);
          priestEl.textContent = `${translatedType} ${priest.Name || ''}`;
          eventEl.appendChild(priestEl);
        }
      } else if (!isLocation && event.LocationID) {
        const location = window.locationMap.get(event.LocationID);
        if (location) {
          const locationEl = document.createElement('div');
          locationEl.className = 'calendar-event-location';
          locationEl.textContent = `@ ${location.Name || 'Unknown Location'}`;
          eventEl.appendChild(locationEl);
        }
      }

      eventEl.style.marginBottom = '10px';
      eventEl.style.paddingBottom = '5px';
      eventEl.style.borderBottom = '1px dashed #ccc';

      eventsEl.appendChild(eventEl);
    });
  }
}

function rerenderCalendarPopup(entityId, isLocation = true) {
  const popup = document.getElementById('calendarPopup');
  if (!popup) return;
  
  const entity = isLocation ? window.locationMap.get(entityId) : window.religiousMap.get(entityId);
  if (!entity) return;
  
  // Update title
  const entityName = isLocation ? entity.Name : `${getTranslatedReligiousType(entity.Type)} ${entity.Name}`;
  const titleElement = popup.querySelector('.calendar-title');
  if (titleElement) {
    titleElement.textContent = `${entityName} - $$calendar-title$$`;
  }
  
  // Get current view's month and year from the grid dataset
  const grid = document.getElementById('calendarGrid');
  let currentMonth = new Date().getMonth();
  let currentYear = new Date().getFullYear();
  
  if (grid && grid.dataset.month && grid.dataset.year) {
    currentMonth = parseInt(grid.dataset.month, 10);
    currentYear = parseInt(grid.dataset.year, 10);
  }
  
  // Regenerate calendar with the new entity and current view
  generateCalendar(entityId, currentMonth, currentYear, isLocation);
  
  // Show upcoming events
  showUpcomingEvents(entityId, isLocation);
}

// Generate HTML for buttons
function getHtmlForButtons(buttons) {
  const actionsContainer = document.createElement('div');
  actionsContainer.className = 'actions-container';
  actionsContainer.style.display = 'grid';
  actionsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
  actionsContainer.style.gap = '8px';
  
  const buttonElements = [];
  
  buttons.forEach(button => {
    if (!button.content) return;
    
    let element;
    
    switch (button.type) {
      case 'link':
        element = document.createElement('a');
        element.href = button.content;
        if (button.external) {
          element.target = "_blank";
        }
        break;
      case 'email':
        element = document.createElement('a');
        element.href = `mailto:${button.content}`;
        break;
      case 'phone':
        element = document.createElement('a');
        element.href = `tel:${button.content}`;
        break;
      case 'calendar':
      case 'info':
      default:
        element = document.createElement('button');
        element.addEventListener('click', button.onClick || (() => {}));
        break;
    }
    
    element.className = button.class || 'action-btn';
    if (button.donate) {
      element.className += ' donate-btn';
    }
    
    element.textContent = button.text;
    buttonElements.push(element);
  });
  
  // If there's an odd number of buttons, make the first one span the full width
  if (buttonElements.length % 2 !== 0 && buttonElements.length > 0) {
    buttonElements[0].style.gridColumn = "1 / span 2";
  }
  
  // Add all buttons to container
  buttonElements.forEach(btn => {
    actionsContainer.appendChild(btn);
  });
  
  return actionsContainer;
}

// Generate calendar HTML
function getHtmlForCalendar(month, year, entityId, isLocation = true) {
  const container = document.createElement('div');
  container.className = 'calendar-container';
  
  // Month names
  const monthNames = [
    '$$month-january$$', '$$month-february$$', '$$month-march$$', '$$month-april$$', 
    '$$month-may$$', '$$month-june$$', '$$month-july$$', '$$month-august$$', 
    '$$month-september$$', '$$month-october$$', '$$month-november$$', '$$month-december$$'
  ];
  
  // Day names
  const dayNames = ['$$day-sun$$', '$$day-mon$$', '$$day-tue$$', '$$day-wed$$', '$$day-thu$$', '$$day-fri$$', '$$day-sat$$'];
  
  // Add month/year header with copy link button
  const headerContainer = document.createElement('div');
  headerContainer.style.display = 'flex';
  headerContainer.style.alignItems = 'center';
  headerContainer.style.justifyContent = 'space-between';
  headerContainer.style.marginBottom = '10px';
  
  const header = document.createElement('div');
  header.className = 'calendar-month-year';
  header.textContent = `${monthNames[month]} ${year}`;
  
  const copyButton = document.createElement('button');
  copyButton.className = 'copy-link-btn';
  copyButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.5 5.5L9.5 8.5M9.5 5.5L6.5 8.5M4.5 3.5H11.5C12.0523 3.5 12.5 3.94772 12.5 4.5V11.5C12.5 12.0523 12.0523 12.5 11.5 12.5H4.5C3.94772 12.5 3.5 12.0523 3.5 11.5V4.5C3.5 3.94772 3.94772 3.5 4.5 3.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/></svg> Copy Link';
  copyButton.style.padding = '5px 10px';
  copyButton.style.background = '#eee';
  copyButton.style.border = 'none';
  copyButton.style.borderRadius = '4px';
  copyButton.style.cursor = 'pointer';
  copyButton.style.display = 'inline-flex';
  copyButton.style.alignItems = 'center';
  copyButton.style.gap = '5px';
  copyButton.style.fontSize = '0.9rem';
  
  copyButton.addEventListener('click', () => {
    // Update URL hash first to ensure we're copying the correct URL
    updateUrlHash(entityId, true);
    copyCurrentUrlToClipboard();
  });
  
  headerContainer.appendChild(header);
  headerContainer.appendChild(copyButton);
  container.appendChild(headerContainer);
  
  // Create grid
  const grid = document.createElement('div');
  grid.className = 'calendar-grid';
  grid.id = 'calendarGrid';
  grid.dataset.month = month;
  grid.dataset.year = year;
  
  // Add day headers
  dayNames.forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.className = 'calendar-day-header';
    dayHeader.textContent = day;
    grid.appendChild(dayHeader);
  });
  
  // Get first day of the month and total days
  const firstDay = new Date(year, month, 1);
  const startingDay = firstDay.getDay();
  const lastDay = new Date(year, month + 1, 0);
  const totalDays = lastDay.getDate();
  
  // Get events for this month
  const monthEvents = getEventsForMonth(month, year, entityId, isLocation);
  
  // Create map of dates with events
  const datesWithEvents = new Map();
  monthEvents.forEach(event => {
    if (event.StartDate) {
      const eventDay = event.StartDate.getDate();
      if (!datesWithEvents.has(eventDay)) {
        datesWithEvents.set(eventDay, []);
      }
      datesWithEvents.get(eventDay).push(event);
    }
  });
  
  // Add days from previous month
  const prevMonth = month === 0 ? 11 : month - 1;
  const prevYear = month === 0 ? year - 1 : year;
  const prevMonthLastDay = new Date(prevYear, prevMonth + 1, 0).getDate();
  
  for (let i = 0; i < startingDay; i++) {
    const day = prevMonthLastDay - startingDay + i + 1;
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day other-month';
    dayEl.textContent = day;
    grid.appendChild(dayEl);
  }
  
  // Add current month days
  for (let day = 1; day <= totalDays; day++) {
    let c = "";
    if (datesWithEvents.has(day)) {
      c = "has-events";
    }
    // NOTE: Don't change this
    let dayel_html = `<button class='calendar-day ${c}' onclick="showEventsForDay('${entityId}', ${year}, ${month}, ${day}, '${isLocation}')">${day}</button>`;
    grid.appendChild(createElementFromHTML(dayel_html));
  }
  
  // Add next month days
  const totalCells = Math.ceil((startingDay + totalDays) / 7) * 7;
  const nextMonthDays = totalCells - (startingDay + totalDays);
  
  for (let day = 1; day <= nextMonthDays; day++) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day other-month';
    dayEl.textContent = day;
    grid.appendChild(dayEl);
  }
  
  container.appendChild(grid);
  
  // Add export buttons below the grid - FIXED POSITIONING
  const exportButtonsContainer = document.createElement('div');
  exportButtonsContainer.className = 'calendar-export-buttons';
  exportButtonsContainer.style.cssText = `
    display: flex;
    gap: 10px;
    margin-top: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    justify-content: center;
  `;
  
  // Create PDF export button
  const pdfButton = document.createElement('button');
  pdfButton.className = 'action-btn';
  pdfButton.textContent = '📄 Export PDF';
  pdfButton.style.cssText = `
    background: #700000;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: bold;
    flex: 1;
    min-width: 120px;
  `;
  pdfButton.addEventListener('click', () => {
    generateCalendarPDF(entityId, isLocation);
  });
  
  // Create iCal export button
  const iCalButton = document.createElement('button');
  iCalButton.className = 'action-btn';
  iCalButton.textContent = '📅 Export iCal';
  iCalButton.style.cssText = `
    background: #004970;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: bold;
    flex: 1;
    min-width: 120px;
  `;
  iCalButton.addEventListener('click', () => {
    generateICalFile(entityId, isLocation);
  });
  
  // Add hover effects
  pdfButton.addEventListener('mouseenter', () => {
    pdfButton.style.background = '#900000';
  });
  pdfButton.addEventListener('mouseleave', () => {
    pdfButton.style.background = '#700000';
  });
  
  iCalButton.addEventListener('mouseenter', () => {
    iCalButton.style.background = '#006699';
  });
  iCalButton.addEventListener('mouseleave', () => {
    iCalButton.style.background = '#004970';
  });
  
  // Add buttons to container
  exportButtonsContainer.appendChild(pdfButton);
  exportButtonsContainer.appendChild(iCalButton);
  
  // Add the export buttons container to the main container
  container.appendChild(exportButtonsContainer);
  
  return container;
}

function createElementFromHTML(htmlString) {
  var div = document.createElement('div');
  div.innerHTML = htmlString.trim();
  return div.firstElementChild;
}

// Show location info function
function showLocationInfo(location) {

  const infoPanel = document.getElementById('infoPanel');
  const priestName = document.getElementById('priestName');
  const priestInfo = document.getElementById('priestInfo');
  
  // Reset all markers before showing this one
  resetAllMarkers();
  
  // Close calendar if open
  closeCalendarPopup();
  
  // Set location name
  priestName.textContent = location.Name;
  
  // Clear previous info
  priestInfo.innerHTML = '';
  
  // Associated religious
  if (location.ReligiousIdArray && location.ReligiousIdArray.length > 0) {
    const religiousParagraph = document.createElement('p');
    religiousParagraph.className = 'info-paragraph';
    religiousParagraph.textContent = "$$served-by$$: ";
    
    // Add links for each religious person
    location.ReligiousIdArray.forEach((id, index) => {
      const person = window.religiousMap.get(id);
      if (person) {
        // Use proper translated title
        const translatedType = getTranslatedReligiousType(person.Type);
        
        const priestLink = document.createElement('a');
        priestLink.className = 'priest-link';
        priestLink.textContent = `${translatedType} ${person.Name}`;
        priestLink.href = '#';
        priestLink.addEventListener('click', (e) => {
          e.preventDefault();
          showPriestInfo(person);
        });
        
        religiousParagraph.appendChild(priestLink);
        
        // Add comma if not the last person
        if (index < location.ReligiousIdArray.length - 1) {
          religiousParagraph.appendChild(document.createTextNode(', '));
        }
      }
    });
    
    priestInfo.appendChild(religiousParagraph);
  }

  // Create buttons with validated website
  const buttons = [
    // Google Maps link
    (location.GoogleMaps || (location.Latitude && location.Longitude)) ? 
      { 
        type: 'link', 
        text: "$$view-on-maps$$", 
        content: location.GoogleMaps || `https://www.google.com/maps?q=${location.Latitude},${location.Longitude}`, 
        external: true 
      } : null,
    
    // Website link - only add if URL is valid
    (location.Website && isValidUrl(location.Website)) ? 
      { type: 'link', text: "$$website$$", content: location.Website, external: true } : null,
    
    // Email
    (location.ContactEmail && location.ContactEmail.replace("mailto:", "").replace("'", "").trim().length > 0) ? 
      { type: 'email', text: "$$email$$", content: location.ContactEmail } : null,
    
    // Phone
    (location.ContactPhone && location.ContactPhone.replace("tel:", "").replace("'", "").trim().length > 0) ? 
      { type: 'phone', text: "$$phone$$", content: location.ContactPhone } : null,
    
    // Notes
    (location.Notes && location.Notes.trim().length > 0) ? 
      { 
        type: 'info', 
        text: "$$show-more-info$$", 
        content: "info", 
        onClick: () => { 
          alert(`${location.Name} (${location.LocationType})\n\n$$notes$$: ${location.Notes}`); 
        } 
      } : null,
    
    // Calendar button
    { 
      type: 'calendar', 
      text: "$$view-calendar$$", 
      content: "calendar", 
      onClick: () => { showLocationCalendar(location); } 
    }
  ].filter(Boolean); // Remove null entries
  
  // Add donate button if available
  const fundingInfo = getFundingInfo(location.LocationID);
  if (fundingInfo) {
    let donateText = '$$donate$$';
    if (fundingInfo.FundingGoal && fundingInfo.CurrentAmount) {
      const percentage = Math.round((fundingInfo.CurrentAmount / fundingInfo.FundingGoal) * 100);
      donateText += ` (${percentage}% $$funded$$)`;
    }
    
    buttons.push({
      type: 'link',
      text: donateText,
      content: fundingInfo.DonationLinks,
      external: true,
      donate: true
    });
  }
  
  // Add buttons to info panel
  priestInfo.appendChild(getHtmlForButtons(buttons));

  // Show the info panel
  infoPanel.style.display = 'flex';
  
  // Adjust zoom based on current zoom for smoother transition
  const currentZoom = map.getZoom();
  const targetZoom = Math.max(currentZoom, 12); // Don't zoom out if already zoomed in
  
  // Fly to location
  map.flyTo([location.Latitude, location.Longitude], targetZoom, {
    animate: true,
    duration: 0.5
  });
  
  // Highlight this location and connected locations
  highlightLocation(location);

  // Update URL
  updateUrlHash(location.LocationID, false);
}

function formatBioText(person) {
  // Get proper translated title
  const translatedType = getTranslatedReligiousType(person.Type);
  
  let bioText = `${translatedType} ${person.Name}\n\n`;
  const details = [];
  
  // Ordination info
  if (person['OrdainedInRite'] || person['OrdainedBy']) {
    let ordinationText = `${translatedType} ${person.Name} was ordained`;
    
    if (person['OrdainedInRite']) {
      ordinationText += ` in the ${person['OrdainedInRite']}`;
    }
    
    if (person['OrdainedBy']) {
      const ordainedByTranslation = getTranslatedReligiousType('Bishop');
      ordinationText += ` by ${ordainedByTranslation} ${person['OrdainedBy']}`;
    }
    
    details.push(ordinationText);
  }
  
  // Bishop line
  if (person['BishopLine']) {
    details.push(`Bishop line: ${person['BishopLine']}`);
  }
  
  // Born year
  if (person['BornYear']) {
    details.push(`Born in ${person['BornYear']}`);
  }
  
  // Associates With
  if (person['AssociatesWith']) {
    details.push(`Associates with: ${person['AssociatesWith']}`);
  }
  
  // Beliefs
  if (person['Beliefs']) {
    details.push(`Holds ${person['Beliefs']} beliefs`);
  }
  
  // Location
  if (person['Location/Area']) {
    details.push(`Operates in: ${person['Location/Area']}`);
  }
  
  // Join all details
  bioText += details.join('. ') + '.';
  
  // Notes
  if (person['Notes']) {
    bioText += `\n\nNotes: ${person['Notes']}`;
  }
  
  return bioText;
}

// Show priest info function
function showPriestInfo(priest) {
  const infoPanel = document.getElementById('infoPanel');
  const priestName = document.getElementById('priestName');
  const priestInfo = document.getElementById('priestInfo');
  
  // Reset all markers before showing this one
  resetAllMarkers();
  
  // Close calendar if open
  closeCalendarPopup();
  
  // Get proper translated title
  const translatedType = getTranslatedReligiousType(priest.Type);
  
  // Set priest name with proper title
  priestName.textContent = `${translatedType} ${priest.Name || ''}`;
  
  // Clear previous info
  priestInfo.innerHTML = '';
  
  // Add locations served section first
  const priestLocations = window.locations.filter(location => 
    location.ReligiousIdArray && location.ReligiousIdArray.includes(priest.ReligiousID)
  );
  
  if (priestLocations.length > 0) {
    const locationsSection = document.createElement('div');
    locationsSection.className = 'parishes-section';
    
    // Add section title
    const locationsTitle = document.createElement('h3');
    locationsTitle.textContent = "$$parishes-served$$";
    locationsSection.appendChild(locationsTitle);
    
    const locationsList = document.createElement('ul');
    locationsList.className = 'parishes-list';
    
    // Sort locations alphabetically
    priestLocations.sort((a, b) => a.Name.localeCompare(b.Name));
    
    priestLocations.forEach(location => {
      const locationItem = document.createElement('li');
      locationItem.className = 'parish-item';
      
      locationItem.innerHTML = `<strong>${location.Name}</strong>`;
      
      // Add click handler to highlight this location
      locationItem.style.cursor = 'pointer';
      locationItem.addEventListener('click', () => {
        showLocationInfo(location);
      });
      
      locationsList.appendChild(locationItem);
    });
    
    locationsSection.appendChild(locationsList);
    priestInfo.appendChild(locationsSection);
  }

  // Create action buttons
  const buttons = [
    // Website link - validate URL
    (priest.Website && isValidUrl(priest.Website)) ? 
      { type: 'link', text: "$$website$$", content: priest.Website, external: true } : null,
    
    // Email
    (priest.ContactEmail && ("" + priest.ContactEmail).replace("mailto:", "").replace("'", "").trim().length > 0) ? 
      { type: 'email', text: "$$email$$", content: priest.ContactEmail } : null,
    
    // Phone
    (priest.ContactPhone && ("" + priest.ContactPhone).replace("tel:", "").replace("'", "").trim().length > 0) ? 
      { type: 'phone', text: "$$phone$$", content: priest.ContactPhone } : null,
    
    // More info button
    {
      type: 'info', 
      text: "$$show-more-info$$", 
      content: "info", 
      onClick: () => { alert(formatBioText(priest)); } 
    },
    
    // Calendar button
    { 
      type: 'calendar', 
      text: "$$view-calendar$$", 
      content: "calendar", 
      onClick: () => { showPriestCalendar(priest); } 
    }
  ].filter(Boolean);
  
  // Add donate button if available
  const fundingInfo = getFundingInfo(priest.ReligiousID);
  if (fundingInfo) {
    let donateText = '$$donate$$';
    if (fundingInfo.FundingGoal && fundingInfo.CurrentAmount) {
      const percentage = Math.round((fundingInfo.CurrentAmount / fundingInfo.FundingGoal) * 100);
      donateText += ` (${percentage}% $$funded$$)`;
    }
    
    buttons.push({
      type: 'link',
      text: donateText,
      content: fundingInfo.DonationLinks,
      external: true,
      donate: true
    });
  }
  
  // Add buttons to info panel
  priestInfo.appendChild(getHtmlForButtons(buttons));

  // Show the info panel
  infoPanel.style.display = 'flex';
  
  // Find primary location for this priest and adjust zoom based on current zoom
  if (priestLocations.length > 0) {
    let primaryLocation = priestLocations[0];
    // Get current zoom level for smoother transition
    const currentZoom = map.getZoom();
    const targetZoom = Math.max(currentZoom, 8); // Don't zoom out if already zoomed in
    
    map.flyTo([primaryLocation.Latitude, primaryLocation.Longitude], targetZoom, {
      animate: true,
      duration: 0.5
    });
  }
  
  // Highlight this priest's locations
  highlightPriest(priest);

  // Update URL hash
  updateUrlHash(priest.ReligiousID, false);
}

// Highlight location and its connections
function highlightLocation(location) {

  // Reset all markers
  resetAllMarkers();
  
  // Highlight this location's marker
  parishMarkers.eachLayer(marker => {
    if (marker.locationData && marker.locationData.LocationID === location.LocationID) {
      // Create highlighted marker
      const markerSize = CONFIG.parishMarkerSize * 1.5;
      const icon = L.divIcon({
        className: 'parish-marker',
        html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize/2, markerSize/2]
      });
      marker.setIcon(icon);
    }
  });
  
  // Highlight associated religious
  if (location.ReligiousIdArray && location.ReligiousIdArray.length > 0) {
    location.ReligiousIdArray.forEach(religiousId => {
      priestMarkers.eachLayer(marker => {
        if (marker.priestData && marker.priestData.ReligiousID === religiousId) {
          // Create highlighted marker
          const markerSize = CONFIG.priestMarkerSize * 1.5;
          const icon = L.divIcon({
            className: 'priest-marker pulse',
            html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerSize/2, markerSize/2]
          });
          marker.setIcon(icon);
        }
      });
    });
    
    // Highlight connection lines
    connectionLines.eachLayer(line => {
      if (line.fromLocation === location.LocationID || line.toLocation === location.LocationID) {
        line.setStyle({
          color: 'yellow',
          weight: CONFIG.lineWeight * 1.5,
          opacity: 1.0
        });
      }
    });
  }
}

// Highlight priest's locations
function highlightPriest(priest) {
  // Reset all markers
  resetAllMarkers();
  
  // Highlight priest's marker
  priestMarkers.eachLayer(marker => {
    if (marker.priestData && marker.priestData.ReligiousID === priest.ReligiousID) {
      // Create highlighted marker
      const markerSize = CONFIG.priestMarkerSize * 1.5;
      const icon = L.divIcon({
        className: 'priest-marker pulse',
        html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize/2, markerSize/2]
      });
      marker.setIcon(icon);
    }
  });
  
  // Highlight priest's locations
  parishMarkers.eachLayer(marker => {
    if (marker.locationData && marker.locationData.ReligiousIdArray && 
        marker.locationData.ReligiousIdArray.includes(priest.ReligiousID)) {
      // Create highlighted marker
      const markerSize = CONFIG.parishMarkerSize * 1.5;
      const icon = L.divIcon({
        className: 'parish-marker',
        html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: #00cc00;"></div>`,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize/2, markerSize/2]
      });
      marker.setIcon(icon);
    }
  });
  
  // Highlight connection lines
  connectionLines.eachLayer(line => {
    if (line.religiousId === priest.ReligiousID) {
      line.setStyle({
        color: '#00cc00',
        weight: CONFIG.lineWeight * 1.5,
        opacity: 1.0
      });
    }
  });
}

// Get funding info for an entity
function getFundingInfo(entityId) {
  return window.fundingMap.get(entityId) || null;
}

// Create HTML for the calendar popup
function createCalendarHtml(entityId, isLocation = true) {
  const entity = isLocation ? window.locationMap.get(entityId) : window.religiousMap.get(entityId);
  const entityName = isLocation ? entity.Name : `${entity.Type} ${entity.Name}`;
  
  // Filter events for this entity
  const entityEvents = window.events.filter(event => {
    if (isLocation) {
      return event.LocationID === entityId;
    } else {
      return event.ReligiousID === entityId;
    }
  });
  
  // Get current month and year
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  // Create calendar HTML
  let html = `
  <div class="calendar-popup" id="calendarPopup">
    <div class="calendar-top">
      <div class="calendar-header">
        <div class="calendar-title">${entityName} - $$calendar-title$$</div>
        <button class="calendar-close" id="calendarClose">×</button>
      </div>
      <div class="calendar-nav">
        <button id="prevMonth">&#8249;</button>
        <div class="calendar-month-year" id="calendarMonthYear"></div>
        <button id="nextMonth">&#8250;</button>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <div class="calendar-bottom">
      <div class="calendar-events" id="calendarEvents"></div>
    </div>
  </div>
  `;
  
  return html;
}

function showEventsForDay(entityId, year, month, day, isLocation = true) {
  const eventsEl = document.getElementById('calendarEvents');
  if (!eventsEl) {
    console.error("Calendar events display element not found!");
    return;
  }
  
  eventsEl.innerHTML = '';

  let contextTimezone = 'UTC';
  const entityLocation = isLocation ? window.locationMap.get(entityId) : window.locations.find(l => l.ReligiousIdArray?.includes(entityId));
  if (entityLocation?.Timezone) {
    contextTimezone = entityLocation.Timezone;
  }

  const targetDayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  const dayDate = createZonedDateTime(targetDayStr, '12:00:00', contextTimezone);
  
  if (dayDate) {
    const dayHeading = document.createElement('h3');
    dayHeading.textContent = formatZonedDate(dayDate.date, contextTimezone, { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    eventsEl.appendChild(dayHeading);
  }

  const dayEvents = getEventsForDay(entityId, year, month, day, isLocation);

  if (dayEvents.length === 0) {
    const noEventsEl = document.createElement('p');
    noEventsEl.textContent = '$$no-events$$';
    eventsEl.appendChild(noEventsEl);
  } else {
    dayEvents.forEach(event => {
      const eventEl = document.createElement('div');
      eventEl.className = 'calendar-event';

      const titleEl = document.createElement('div');
      titleEl.className = 'calendar-event-title';
      titleEl.textContent = event.EventType || 'Event';
      eventEl.appendChild(titleEl);

      if (event.StartDate) {
        const timeEl = document.createElement('div');
        timeEl.className = 'calendar-event-time';
        let timeString = formatZonedTime(event.StartDate, event.Timezone);

        if (event.EndDate && event.EndDate.getTime() !== event.StartDate.getTime()) {
          const durationMs = event.EndDate.getTime() - event.StartDate.getTime();
          if (durationMs > 1000) {
            timeString += ` - ${formatZonedTime(event.EndDate, event.Timezone)}`;
          }
        }
        timeString += ` (${formatZonedTime(event.StartDate, event.Timezone, { timeZoneName: 'short' })})`;

        timeEl.textContent = `Time: ${timeString}`;
        eventEl.appendChild(timeEl);
      }

      if (isLocation && event.PriestID) {
        const priest = window.religiousMap.get(event.PriestID);
        if (priest) {
          const priestEl = document.createElement('div');
          priestEl.className = 'calendar-event-priest';
          priestEl.textContent = `With: ${priest.Type || 'Priest'} ${priest.Name || ''}`;
          eventEl.appendChild(priestEl);
        }
      } else if (!isLocation && event.LocationID) {
        const location = window.locationMap.get(event.LocationID);
        if (location) {
          const locationEl = document.createElement('div');
          locationEl.className = 'calendar-event-location';
          locationEl.textContent = `At: ${location.Name || 'Unknown Location'}`;
          eventEl.appendChild(locationEl);
        }
      }

      if (event.Notes) {
        const notesEl = document.createElement('div');
        notesEl.className = 'calendar-event-notes';
        notesEl.style.fontStyle = 'italic';
        notesEl.textContent = event.Notes;
        eventEl.appendChild(notesEl);
      }

      eventsEl.appendChild(eventEl);
    });
  }
}

// Show location calendar
function showLocationCalendar(location) {
  const result = showCalendar(location, true);
  // Setup calendar after it's displayed
  if (document.getElementById('calendarPopup').style.display === 'flex') {
    rerenderCalendarPopup(location.LocationID, true);
  }
  // Update URL
  updateUrlHash(location.LocationID, true);
  return result;
}

// Show priest calendar
function showPriestCalendar(priest) {
  const result = showCalendar(priest, false);
  // Setup calendar after it's displayed
  if (document.getElementById('calendarPopup').style.display === 'flex') {
    rerenderCalendarPopup(priest.ReligiousID, false);
  }
    // Update URL
    updateUrlHash(priest.ReligiousID, true);
  return result;
}

function showCalendar(entity, isLocation = true) {
  const entityId = isLocation ? entity.LocationID : entity.ReligiousID;
  
  // Add calendar popup to the DOM if it doesn't exist
  if (!document.getElementById('calendarPopup')) {
    const calendarHtml = createCalendarHtml(entityId, isLocation);
    document.body.insertAdjacentHTML('beforeend', calendarHtml);
    
    // Set up event listeners
    document.getElementById('calendarClose').addEventListener('click', () => {
      document.getElementById('calendarPopup').style.display = 'none';
    });
    
    // Previous and next month navigation
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar(entityId, currentMonth, currentYear, isLocation);
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar(entityId, currentMonth, currentYear, isLocation);
    });
  }
  
  // Show popup
  const popup = document.getElementById('calendarPopup');
  popup.style.display = 'flex';
  popup.style.minHeight = '100%';
  
  // Generate calendar for current month
  const now = new Date();
  generateCalendar(entityId, now.getMonth(), now.getFullYear(), isLocation);
  
  // Show upcoming events
  showUpcomingEvents(entityId, isLocation);
}

// Generate calendar
function generateCalendar(entityId, month, year, isLocation = true) {
  // Update month/year display
  const monthYearEl = document.getElementById('calendarMonthYear');
  const grid = document.getElementById('calendarGrid');
  
  // Clear previous content
  if (grid) {
    grid.innerHTML = '';
  }
  
  // Get calendar HTML
  const calendarHTML = getHtmlForCalendar(month, year, entityId, isLocation);
  
  // Update display
  if (monthYearEl) {
    const headerContainer = calendarHTML.querySelector('div > div'); // Get the header container
    if (headerContainer) {
      monthYearEl.innerHTML = headerContainer.querySelector('.calendar-month-year').innerHTML;
    }
  }
  
  if (grid) {
    const gridContent = calendarHTML.querySelector('.calendar-grid');
    if (gridContent) {
      grid.innerHTML = gridContent.innerHTML;
      grid.dataset.month = month;
      grid.dataset.year = year;
    }
    
    // Also add the export buttons to the calendar bottom section
    const calendarBottom = document.querySelector('.calendar-bottom');
    if (calendarBottom) {
      // Remove existing export buttons if any
      const existingButtons = calendarBottom.querySelector('.calendar-export-buttons');
      if (existingButtons) {
        existingButtons.remove();
      }
      
      // Add new export buttons
      const exportButtons = calendarHTML.querySelector('.calendar-export-buttons');
      if (exportButtons) {
        calendarBottom.appendChild(exportButtons.cloneNode(true));
      }
    }
  }
}

// Reset all markers to their default style
function resetAllMarkers() {
  // Reset parish markers
  parishMarkers.eachLayer(marker => {
    const markerSize = CONFIG.parishMarkerSize;
    const icon = L.divIcon({
      className: 'parish-marker',
      html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
      iconSize: [markerSize, markerSize],
      iconAnchor: [markerSize/2, markerSize/2]
    });
    marker.setIcon(icon);
  });
  
  // Reset priest markers
  priestMarkers.eachLayer(marker => {
    const markerSize = CONFIG.priestMarkerSize;
    const icon = L.divIcon({
      className: 'priest-marker pulse',
      html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
      iconSize: [markerSize, markerSize],
      iconAnchor: [markerSize/2, markerSize/2]
    });
    marker.setIcon(icon);
  });
  
  // Reset connection lines
  connectionLines.eachLayer(line => {
    line.setStyle({
      color: CONFIG.lineColor,
      weight: CONFIG.lineWeight,
      opacity: CONFIG.lineOpacity
    });
  });
}

function levenshteinDistance(a, b) {
  if (a.length === 0) return b.length;
  if (b.length === 0) return a.length;

  const matrix = Array(a.length + 1).fill().map(() => Array(b.length + 1).fill(0));

  for (let i = 0; i <= a.length; i++) {
    matrix[i][0] = i;
  }
  for (let j = 0; j <= b.length; j++) {
    matrix[0][j] = j;
  }

  for (let i = 1; i <= a.length; i++) {
    for (let j = 1; j <= b.length; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,      // deletion
        matrix[i][j - 1] + 1,      // insertion
        matrix[i - 1][j - 1] + cost // substitution
      );
    }
  }

  return matrix[a.length][b.length];
}

// Completely rewritten search functionality
function getSearchResults(searchTerm) {
  if (!searchTerm || searchTerm.length < 2) {
    return [];
  }
  
  searchTerm = searchTerm.toLowerCase().trim();
  const exactMatches = [];
  const fuzzyMatches = [];
  
  // Search locations for exact substring matches first
  window.locations.forEach(location => {
    const name = (location.Name || '').toLowerCase();
    const type = (location.LocationType || '').toLowerCase();
    const notes = (location.Notes || '').toLowerCase();
    
    let score = Infinity;
    let isExactMatch = false;
    
    // Check for exact substring matches (prioritize name field)
    if (name.includes(searchTerm)) {
      score = name.indexOf(searchTerm); // Earlier in name = better score
      isExactMatch = true;
    } else if (type.includes(searchTerm)) {
      score = 1000 + type.indexOf(searchTerm); // Lower priority than name
      isExactMatch = true;
    } else if (notes.includes(searchTerm)) {
      score = 2000 + notes.indexOf(searchTerm); // Lowest priority
      isExactMatch = true;
    }
    
    if (isExactMatch) {
      exactMatches.push({
        type: 'location',
        data: location,
        score: score
      });
    } else {
      // Only add fuzzy matches if no exact matches were found yet
      const nameDistance = levenshteinDistance(searchTerm, name);
      if (nameDistance <= Math.max(2, searchTerm.length / 2)) {
        fuzzyMatches.push({
          type: 'location',
          data: location,
          score: 10000 + nameDistance // Much lower priority than exact matches
        });
      }
    }
  });
  
  // Search religious people for exact substring matches
  window.religious.forEach(person => {
    const name = (person.Name || '').toLowerCase();
    const type = (person.Type || '').toLowerCase();
    const notes = (person.Notes || '').toLowerCase();
    
    let score = Infinity;
    let isExactMatch = false;
    
    // Check for exact substring matches (prioritize name field)
    if (name.includes(searchTerm)) {
      score = name.indexOf(searchTerm);
      isExactMatch = true;
    } else if (type.includes(searchTerm)) {
      score = 1000 + type.indexOf(searchTerm);
      isExactMatch = true;
    } else if (notes.includes(searchTerm)) {
      score = 2000 + notes.indexOf(searchTerm);
      isExactMatch = true;
    }
    
    if (isExactMatch) {
      exactMatches.push({
        type: 'religious',
        data: person,
        score: score
      });
    } else {
      // Only add fuzzy matches if no exact matches were found yet
      const nameDistance = levenshteinDistance(searchTerm, name);
      if (nameDistance <= Math.max(2, searchTerm.length / 2)) {
        fuzzyMatches.push({
          type: 'religious',
          data: person,
          score: 10000 + nameDistance
        });
      }
    }
  });
  
  // Sort exact matches by score
  exactMatches.sort((a, b) => a.score - b.score);
  
  // If we have exact matches, return only those (up to 10)
  if (exactMatches.length > 0) {
    return exactMatches.slice(0, 10);
  }
  
  // Otherwise, return fuzzy matches (up to 10)
  fuzzyMatches.sort((a, b) => a.score - b.score);
  return fuzzyMatches.slice(0, 10);
}

// Updated search result display - no "match in" text
function handleSearch(event) {
  const searchTerm = event.target.value.toLowerCase();
  const searchResultsContainer = document.getElementById('searchResults');
  const outboundLinks = document.querySelector('.links');
  
  // Reset search results
  searchResultsContainer.innerHTML = '';
  
  if (searchTerm.length < 2) {
    searchResultsContainer.style.display = 'none';
    outboundLinks.style.display = 'flex';
    resetAllMarkers();
    return;
  }
  
  // Hide outbound links when showing search results
  outboundLinks.style.display = 'none';
  
  // Get search results (max 10, exact matches prioritized)
  const searchResults = getSearchResults(searchTerm);
  
  // Display search results
  if (searchResults.length > 0) {
    searchResults.forEach(result => {
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      
      let label = '';
      if (result.type === 'religious') {
        const person = result.data;
        const translatedType = getTranslatedReligiousType(person.Type);
        label = `${translatedType} ${person.Name || ''}`;
      } else {
        label = result.data.Name || 'Location';
      }
      
      // Simple display without "match in" text
      resultItem.innerHTML = `<strong>${label}</strong>`;
      
      // Add location type or religious association as subtitle
      if (result.type === 'location' && result.data.LocationType) {
        resultItem.innerHTML += `<br><small>${result.data.LocationType}</small>`;
      } else if (result.type === 'religious' && result.data.AssociatesWith) {
        resultItem.innerHTML += `<br><small>${result.data.AssociatesWith}</small>`;
      }
      
      resultItem.tabIndex = 0;
      
      resultItem.addEventListener('click', () => {
        if (result.type === 'religious') {
          showPriestInfo(result.data);
        } else {
          showLocationInfo(result.data);
        }
        
        // Clear search
        document.getElementById('searchInput').value = '';
        searchResultsContainer.style.display = 'none';
        outboundLinks.style.display = 'flex';
      });
      
      searchResultsContainer.appendChild(resultItem);
    });
    
    searchResultsContainer.style.display = 'flex';
  } else {
    searchResultsContainer.style.display = 'none';
    outboundLinks.style.display = 'flex';
  }
}

// Try to get user's location
function getUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      // Success
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // Center map on user's location
        map.setView([lat, lng], 8);
        
        // Add a marker for user's location
        addUserLocationMarker(lat, lng);
      },
      // Error
      (error) => {
        console.warn(`Geolocation error: ${error.message}`);
        // Use approximate location
        getApproximateLocation();
      },
      // Options
      {
        timeout: 5000,  // Wait just 5 seconds for the geolocation
        maximumAge: 0   // Don't use a cached position
      }
    );
  } else {
    console.warn("Geolocation not supported by this browser");
    // Use approximate location
    getApproximateLocation();
  }
}

// Add a marker for the user's location
function addUserLocationMarker(lat, lng) {
  // Remove existing marker if any
  if (userLocationMarker) {
    map.removeLayer(userLocationMarker);
  }
  
  // Create a blue user location marker
  const userIcon = L.divIcon({
    className: 'user-marker',
    html: `<div style="width:12px; height:12px; background-color: blue; border-radius: 50%; border: 2px solid white;"></div>`,
    iconSize: [12, 12],
    iconAnchor: [6, 6]
  });
  
  userLocationMarker = L.marker([lat, lng], { icon: userIcon })
    .addTo(map)
    .bindPopup("$$your-location$$");
  }

// Get approximate location based on timezone and language
function getApproximateLocation() {
  // Get timezone offset
  const timezoneOffsetMinutes = new Date().getTimezoneOffset();
  const timezoneOffsetHours = -timezoneOffsetMinutes / 60;
  
  // Approximate longitude based on timezone
  const approximateLongitude = timezoneOffsetHours * 15;
  
  // Approximate latitude based on language
  const approximateLatitude = estimateLatitude(approximateLongitude);
        
  // Center map and add marker
  map.setView([approximateLatitude, approximateLongitude], 5);
  addUserLocationMarker(approximateLatitude, approximateLongitude);
}

// Estimate latitude based on language and longitude
function estimateLatitude(longitude) {
  // Language-based latitude map
  const languageLatitudeMap = {
    "de": 51.0, // Germany
    "en": 51.0, // UK
    "fr": 46.0, // France
    "es": 40.0, // Spain
    "it": 42.0, // Italy
    "pl": 52.0, // Poland
    "ro": 46.0, // Romania
    "ru": 55.0, // Russia
    "tr": 39.0, // Turkey
    "el": 38.0, // Greece
    "ar": 25.0, // Arabian Peninsula
    "tl": 14.0, // Philippines
    "zh": 35.0, // China
    "ko": 37.5, // Korea
    "ja": 36.0, // Japan
    "pt": -15.0 // Brazil
  };
  
  // Longitude ranges for adjusting latitude
  const longitudeRanges = {
    "en": [
      { min: -170, max: -30, lat: 40.0 },    // North America
      { min: -10, max: 2, lat: 51.0 },       // UK
      { min: 65, max: 90, lat: 20.0 },       // South Asia
      { min: 110, max: 155, lat: -25.0 }     // Australia/NZ
    ],
    "es": [
      { min: -120, max: -30, lat: 15.0 },    // Latin America
      { min: -10, max: 5, lat: 40.0 }        // Spain
    ],
    "pt": [
      { min: -75, max: -30, lat: -15.0 },    // Brazil
      { min: -10, max: 0, lat: 39.0 }        // Portugal
    ]
  };
  
  // If we have longitude range data for this language, check it
  if (longitudeRanges[CONFIG.currentLanguage]) {
    for (const range of longitudeRanges[CONFIG.currentLanguage]) {
      if (longitude >= range.min && longitude <= range.max) {
        return range.lat;
      }
    }
  }
  
  // Otherwise use the general language map
  if (languageLatitudeMap[CONFIG.currentLanguage]) {
    return languageLatitudeMap[CONFIG.currentLanguage];
  }
  
  // Regional fallback based on longitude
  if (longitude > 10 && longitude < 40) {
    return 50.0; // Eastern Europe
  } else if (longitude >= 40 && longitude < 60) {
    return 55.0; // Western Russia
  } else if (longitude >= 60 && longitude < 90) {
    return 45.0; // Central Asia
  } else if (longitude >= 90 && longitude < 120) {
    return 35.0; // East Asia
  } else if (longitude >= 120 && longitude < 150) {
    return 35.0; // Far East Asia
  } else if (longitude > -10 && longitude <= 10) {
    return 48.0; // Western Europe
  } else if (longitude > -60 && longitude <= -10) {
    return 45.0; // Atlantic/Western Europe
  } else if (longitude > -120 && longitude <= -60) {
    return 35.0; // Americas
  }
  
  // Default fallback
  return 20.0;
}
</script>
</body>
</html>
