<!DOCTYPE html>
<html lang="$$LANG$$">
<head>
  <title>$$TITLE$$</title>
  <meta name="description" content="$$DESCRIPTION$$">
  <link rel="alternate" hreflang="en" href="$$ROOT_HREF$$/en/resistance.html">
  <link rel="alternate" hreflang="de" href="$$ROOT_HREF$$/de/resistance.html">
  <link rel="alternate" hreflang="fr" href="$$ROOT_HREF$$/fr/resistance.html">
  <link rel="alternate" hreflang="es" href="$$ROOT_HREF$$/es/resistance.html">
  <link rel="alternate" hreflang="it" href="$$ROOT_HREF$$/it/resistance.html">
  <link rel="alternate" hreflang="pt" href="$$ROOT_HREF$$/pt/resistance.html">
  <link rel="alternate" hreflang="x-default" href="$$ROOT_HREF$$/en/resistance.html">
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#161616" media="(prefers-color-scheme: dark)">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-RegularItalic.woff2" as="font" type="font/woff2">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-Regular.woff2" as="font" type="font/woff2">
  <link crossorigin="anonymous" rel="preload" href="/static/font/ssfp/SourceSerifPro-BASIC-Semibold.woff2" as="font" type="font/woff2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <style>
    :root {
      --background-color: #f5f5f5;
      --text-color: #333;
      --panel-bg: rgba(255, 255, 255, 0.95);
      --panel-text: #333;
      --search-bg: white;
      --search-text: #333;
      --search-placeholder: #999;
      --search-results-bg: white;
      --search-results-hover: #f0f0f0;
      --link-color: #8b0000;
      --focus-col: rgb(61, 99, 170);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #121212;
        --text-color: #f5f5f5;
        --panel-bg: rgba(33, 33, 33, 0.95);
        --panel-text: #f5f5f5;
        --search-bg: #333;
        --search-text: #f5f5f5;
        --search-placeholder: #777;
        --search-results-bg: #333;
        --search-results-hover: #444;
        --link-color: #ff6b6b;
      }
    }
    
    * {
        margin: 0px;
        padding: 0px;
    }

    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      background-color: var(--background-color);
      font-family: 'Source Serif Pro', serif;
      color: var(--text-color);
    }
    
    #map {
      flex-grow: 1;
      width: 100%;
      z-index: 1;
    }
    
    .search-container {
      position: absolute;
      top: 80px;
      left: 10px;
      z-index: 1000;
      width: 300px;
      max-width: 90vw;
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .search-container {
        top: 10px;
        width: calc(100% - 20px);
      }
    }

    #priestInfo {
      display: flex;
      flex-direction: column;
      margin-top: 10px;
    }

    .search-input {
      font-family: 'UnifrakturMaguntia';
      font-weight: bold;
      padding: 10px;
      font-style: italic;
      border: none;
      background: var(--search-bg);
      color: var(--search-text);
      font-size: 1.5rem;
      outline: none;
      border: 3px solid var(--search-bg);
      pointer-events: all;
      width: 100%;
      box-sizing: border-box;
    }
    
    .search-input:focus {
      border: 3px solid var(--focus-col);
    }

    .search-input::placeholder {
      color: var(--search-placeholder);
    }
    
    .search-results {
      display: none;
      font-family: 'UnifrakturMaguntia';
      font-weight: bold;
      font-style: italic;
      overflow-y: scroll;
      background: var(--search-results-bg);
      border-radius: 0 0 5px 5px;
      z-index: 11;
      pointer-events: all;
      max-height: 200px;
      overflow-y: scroll;
    }
    
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 3px solid transparent;
      font-size: 1.2rem;
    }
    
    .search-result-item:focus {
      border: 3px solid var(--focus-col);
      background-color: var(--search-results-hover);
    }

    .search-result-item:hover {
      background-color: var(--search-results-hover);
    }

    .info-panel {
      margin-bottom: 10px;
      box-shadow: 2.5px 2.5px 5px black;
      pointer-events: all;
      position: absolute;
      background: white;
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      background: var(--panel-bg);
      color: var(--panel-text);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      font-family: 'Source Serif Pro', serif;
      font-style: italic;
      font-size: 1.2rem;
      top: 10px;
      right: 10px;
      width: 300px;
      max-width: 90vw;
    }
    
    .info-panel h2 {
      margin-top: 0;
      font-size: 2rem;
      font-weight: bold;
    }
    
    .info-row {
      margin-bottom: 4px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }
    
    .notes-section, .mass-times-section {
      padding-top: 8px;
    }

    .notes-section strong, .mass-times-section strong {
      display: inline;
      padding-right: 5px;
    }

    .notes-section p, .mass-times-section p {
      display: inline;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .mass-times-section {
      color: #8b0000;
      font-weight: 500;
    }

    @media (prefers-color-scheme: dark) {
      .notes-section, .mass-times-section {
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      
      .mass-times-section {
        color: #ff6b6b;
      }
    }

    #priestName {
      font-family: 'UnifrakturMaguntia', serif;
      font-size: 2rem;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      background: #cc0000;
      font-size: 1.2rem;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    
    .info-link {
      background: #004970;
      color: white;
      font-weight: bold;
      text-decoration: underline;
    }
    
    .info-link.maps {
      background: #700000;
      color: white;
      padding: 10px;
      font-weight: bold;
      font-style: normal;
      font-family: sans-serif;
      margin-top: 1rem;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    
    .info-link.maps:hover {
      text-decoration: underline;
    }

    .parishes-section h3 {
      margin-top: 8px;
      font-size: 1.3rem;
    }

    .parishes-list {
      list-style-type: none;
      padding-left: 0;
      margin-top: 5px;
    }

    .parish-item {
      margin-bottom: 8px;
      line-height: 1.4;
    }

    @media (prefers-color-scheme: dark) {
      .parishes-section {
        border-top: 1px solid rgba(255,255,255,0.1);
      }
    }

    .priest-link {
      color: var(--link-color);
      text-decoration: underline;
      cursor: pointer;
      margin-top: 5px;
      display: inline-block;
    }
    
    .priest-link:hover {
      text-decoration: none;
    }
    
    .parish-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .parish-item strong {
      text-decoration: underline;
    }
    
    .parish-item:hover {
      background-color: rgba(128, 128, 128, 0.1);
      border-radius: 3px;
      padding-left: 5px;
    }

    .links {
      position: absolute;
      bottom: 10px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 2;
    }
    
    .links > div {
      display: flex;
      flex-direction: row;
    }

    .outbound-link, .outbound-link:visited, .outbound-link:focus, .outbound-link:hover {
      color: white;
      font-size: 1rem;
      background-color: black;
      margin-right: 10px;
      padding: 5px;
      text-decoration: none;
      pointer-events: all;
    }

    @media (max-width: 800px) {
      .title {
        display: none;
      }
      
      .links {
        width: 100%;
        display: flex;
        flex-grow: 1;
      }
      
      .links > div {
        flex-direction: row;
        display: flex;
        flex-grow: 0;
      }
      
      .links > div > a {
        margin-top: 5px;
        flex-grow: 1;
        display: flex;
      }

      .info-panel {
        max-height: 60vh;
        font-size: 0.9rem;
      }
      
      #priestName {
        font-size: 1.4rem;
      }
      
      .search-input {
        font-size: 1.2rem;
      }
      
      .search-results, .search-result-item {
        font-size: 1.2rem;
      }
      
      .outbound-link, .outbound-link:visited, .outbound-link:focus, .outbound-link:hover {
        font-size: 1rem;
      }
      
      #priestInfo {
        font-size: 1rem;
      }
    }

    #header {
      position: relative;
      z-index: 2;
      background-color: var(--background-color);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .title {
      font-family: 'UnifrakturMaguntia', serif;
      font-size: 2rem;
      color: var(--text-color);
      text-align: center;
      padding: 10px 0;
      background: var(--text-color);
      mix-blend-mode: difference;
      color: var(--background-color);
    }

    #sidebar {
      display: flex;
      justify-content: center;
      flex-direction: column;
    }

    #sidebar .sidebar-links {
      display: flex;
      flex-flow: row wrap;
      justify-content: center;
      padding: 0 10px 10px;
    }

    #sidebar .sidebar-links > a {
      font-variant-caps: small-caps;
      padding: 5px 10px;
      margin: 0 5px;
      color: var(--text-color);
      text-decoration: none;
      border-bottom: 2px solid transparent;
      font-family: 'Source Serif Pro', serif;
      transition: border-color 0.3s;
      cursor: pointer;
    }

    #sidebar .sidebar-links > a:hover {
      border-color: var(--text-color);
    }
    
    .language-selector {
      margin-left: 10px;
    }

    #language-select {
      border: none;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      font-family: 'Source Serif Pro', serif;
      font-variant-caps: small-caps;
      padding: 5px;
    }

    /* Map-specific styles */
    .leaflet-popup-content {
      font-family: 'Source Serif Pro', serif;
      font-size: 1rem;
    }
    
    .priest-marker {
      background-color: #cc0000;
      border-radius: 50%;
      border: 2px solid white;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    .parish-marker {
      background-color: #003399;
      border-radius: 50%;
      border: 2px solid white;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    /* For the pulsing effect */
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(204, 0, 0, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(204, 0, 0, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(204, 0, 0, 0);
      }
    }

    /* For dark mode maps */
    .dark-map .leaflet-tile {
      filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }
    
    .dark-map .leaflet-container {
      background: #303030;
    }
      
    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 400;
      font-style: normal;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-Regular.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }

    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 400;
      font-style: italic;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-RegularItalic.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }

    @font-face {
      font-family: 'Source Serif Pro';
      font-weight: 600;
      font-style: normal;
      src: url('/static/font/ssfp/SourceSerifPro-BASIC-Semibold.woff2') format('woff2');
      font-display: swap;
      unicode-range: U+0020-007E, U+00A0-00FF, U+2010, U+2013-2014, U+2018-2019, U+201C-201D, U+2212;
    }
    
    @font-face {
      font-family: 'UnifrakturMaguntia';
      font-style: normal;
      font-weight: 400;
      src: url('https://fonts.gstatic.com/s/unifrakturmaguntia/v16/WWXPlieVYwiGNomYU-ciRLRvEmK7oaHRHi-2fDU.woff2') format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      font-display: swap;
    }
  </style>
</head>
<body>
  <header id="header">
    <nav id="sidebar">
      <h1 class="title">$$RESISTANCE_TITLE$$</h1>
      <div class="sidebar-links">
        <a href="/$$LANG$$">$$NAV_HOME$$</a>
        <a href="/$$LANG$$/topics">$$NAV_ARTICLES$$</a>
        <a href="/$$LANG$$/tools">$$NAV_TOOLS$$</a>
        <a href="/$$LANG$$/contact">$$NAV_CONTACT$$</a>
        <!-- Language selector -->
        <div class="language-selector">
          <select id="language-select">
            <option value="en">English</option>
            <option value="de">Deutsch</option>
            <option value="fr">Français</option>
            <option value="it">Italiano</option>
            <option value="es">Español</option>
            <option value="pl">Polski</option>
            <option value="ro">Română</option>
            <option value="ru">Русский</option>
            <option value="tr">Türkçe</option>
            <option value="el">Ελληνικά</option>
            <option value="ar">العربية</option>
            <option value="tl">Filipino</option>
            <option value="zh">中文</option>
            <option value="ko">한국어</option>
            <option value="ja">日本語</option>
            <option value="pt">Português</option>
          </select>
        </div>
      </div>
    </nav>
  </header>

  <div class="search-container">
    <div style="display: flex; flex-direction: column;">
      <input type="text" class="search-input" placeholder="$$SEARCH_PLACEHOLDER$$" id="searchInput">
      <div class="search-results" id="searchResults"></div>
    </div>
  </div>

  <div class="info-panel" id="infoPanel">
    <button class="close-btn" id="closeBtn">×</button>
    <h2 id="priestName"></h2>
    <div id="priestInfo"></div>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <div class="links">
    <div style="padding-top:10px;z-index:5;">
      <a class="outbound-link" href="https://github.com/fschutt/dubiacc/issues">$$REPORT_ERROR$$</a>
      <a class="outbound-link" href="https://github.com/fschutt/dubiacc/issues">$$REQUEST_MASS$$</a>
      <a style="color:white;" class="outbound-link" href="https://dubia.cc">$$BACK_TO_SITE$$</a>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  
  <!-- PapaParse for CSV processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  
  <script>
    // Configuration
    const CONFIG = {
      // Default center of the map (will be overridden by geolocation if available)
      defaultLat: 48.8566,
      defaultLng: 2.3522,
      defaultZoom: 4,
      
      // Styling
      priestMarkerColor: '#cc0000',
      parishMarkerColor: '#003399',
      lineColor: '#8b0000',
      lineWeight: 2,
      lineOpacity: 0.7,
      
      // Marker sizes
      priestMarkerSize: 10,
      parishMarkerSize: 7,
      
      // Google Sheet ID
      sheetId: "16wO1gTdilEcdqsWfJ0mZn-hgYD2MRJ1SCKSAHzcDj18",
    };
    
    // Current language
    let currentLanguage = "$$LANG$$";
    
    // Data storage
    let locations = [];
    let religious = [];
    let events = [];
    let parishes = [];
    
    // Maps for quick lookup
    let locationMap = new Map();
    let religiousMap = new Map();
    
    // Map and layers
    let map;
    let priestMarkers = L.layerGroup();
    let parishMarkers = L.layerGroup();
    let connectionLines = L.layerGroup();
    
    // Default data (fallback)
    const defaultLocationsData = `LocationID,LocationType,Name,ReligiousIdMulti,Location,Website,GoogleMaps,ContactEmail,ContactPhone,Notes
carmelites-hf-ireland,Convent,Carmelites of the Holy Face of Jesus,mother-irene,51.79025633971586 -9.112158704807591,https://carmelitesholyface.com/,https://maps.app.goo.gl/WaokWwYAmujka5Sr7,,,
hjm-seminary,Seminary,Hearts of Jesus and Mary Seminary,fr-chazal,10.342421706935285 123.83294807185935,https://www.facebook.com/mariancorpsofst.piusx,https://maps.app.goo.gl/o8xmm2b5eQgNXDpy6,mariancorpsinformation@gmail.com,639991680637,
discalced-carm-ph,Mission,Our Lady of Mt. Carmel Oratory,fr-chazal,14.185634883816563 121.23247682974647,https://discalcedcarmelites.org.ph/,https://maps.app.goo.gl/tXxyMGo6smjHdLW1A,,,"https://www.facebook.com/ScapularConfraternityPH/"
carmel-stjosef-ger,Convent,Karmel St. Josef,,48.1881613609616 12.668123403146767,https://archive.is/FOkbD,https://maps.app.goo.gl/6uYEqhqvvmJskU2q9,,4986719289190,"mittwochs und donnerstags von 10.45 Uhr – 11.15 Uhr"
mosteiro-santa-cruz,Convent,Mosteiro da Santa Cruz,bp-aquino,-22.188609036471846 -42.54923387378506,https://www.mosteirodasantacruz.org/,https://maps.app.goo.gl/fctDJNpysKvZGV7r9,mostsantacruz@gmail.com,552225401136,`;

    const defaultReligiousData = `ReligiousID,Type,Name,Born Year,Associates With,Beliefs,Location/Area,Contact/Website,Ordained in Rite,Ordained By,Consecrated in Rite,Consecrated By,Bishop Line,Notes
bp-williamson,Bishop,Richard Williamson,1940,SSPX (originally),Resistance,England,,Old Rite,Archbishop Lefebvre,Old Rite,Archbishop Lefebvre,Lefebvre,"Consecrated in 1988 by Archbishop Lefebvre; leads \"SSPX Resistance\""
bp-zendejas,Bishop,Gerardo Zendejas,1961,Resistance,Non-sede,USA,https://thebluepaper.org/,Old Rite,Archbishop Lefebvre,Old Rite,Bp. R. Williamson,Lefebvre,Consecrated bishop on May 11 2017 by Bp. Williamson
bp-faure,Bishop,Jean-Michel Faure,1941,Resistance,Non-sede,France,,Old Rite,Archbishop Lefebvre,Old Rite,Bp. R. Williamson,Lefebvre,Consecrated in 2015 by Bp. Williamson in Brazil
bp-aquino,Bishop,Tomas de Aquino,1954,Resistance,Non-sede,Brazil,,Old Rite,,Old Rite,Bp. R. Williamson,Lefebvre,Consecrated in 2016 by Bp. Williamson
mother-irene,Mother,Mother Irene,1983,Carmelites of the Holy Face,Non-sede,Ireland,,,,,,,
fr-chazal,Father,François Chazal,1968,Marian Corps,Non-sede,Philippines,,,,,,,`;

    const defaultEventsData = `EventID,LocationID,ReligiousID,EventType,StartDate,EndDate,Notes
mass-1,carmelites-hf-ireland,mother-irene,Mass,2023-11-26T07:30:00,2023-11-26T08:30:00,Sunday Mass
mass-2,hjm-seminary,fr-chazal,Mass,2023-11-26T10:00:00,2023-11-26T11:30:00,Sunday High Mass`;

    // Initialize map when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);

    // Initialize the application
    function init() {
      // Create map
      map = L.map('map').setView([CONFIG.defaultLat, CONFIG.defaultLng], CONFIG.defaultZoom);
      
      // Add OSM tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Add layer groups to map
      connectionLines.addTo(map);
      parishMarkers.addTo(map);
      priestMarkers.addTo(map);
      
      // Set up event listeners
      setupEventListeners();
      
      // Load data (first from fallback, then from Google Sheets)
      loadData();
      
      // Try to get user's location
      getUserLocation();
      
      // Set current language in dropdown
      document.getElementById('language-select').value = currentLanguage;
    }

    // Set up event listeners
    function setupEventListeners() {
      // Search input
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      
      searchInput.addEventListener('input', handleSearch);
      
      searchInput.addEventListener('focus', () => {
        if (searchResults.children.length > 0) {
          searchResults.style.display = 'block';
        }
      });
      
      // Close button
      document.getElementById('closeBtn').addEventListener('click', () => {
        document.getElementById('infoPanel').style.display = 'none';
      });
      
      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.style.display = 'none';
        }
      });
      
      // Language selector
      document.getElementById('language-select').addEventListener('change', function() {
        const lang = this.value;
        window.location.href = `/$$LANG$$/resistance.html`.replace('$$LANG$$', lang);
      });
      
      // Handle light/dark mode
      const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDarkMode) {
        map.getContainer().classList.add('dark-map');
      }
      
      // Listen for theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (e.matches) {
          map.getContainer().classList.add('dark-map');
        } else {
          map.getContainer().classList.remove('dark-map');
        }
      });
    }

    // Load data from fallback and Google Sheets
    function loadData() {
      // First load default data
      console.log("Loading default data...");
      parseLocationsData(defaultLocationsData);
      parseReligiousData(defaultReligiousData);
      parseEventsData(defaultEventsData);
      
      // Then try to fetch from Google Sheets
      console.log("Fetching data from Google Sheets...");
      fetchSheetData();
    }

    // Parse locations CSV data
    function parseLocationsData(csvData) {
      Papa.parse(csvData, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          // Process locations
          locations = results.data.map(location => {
            // Clean location data
            const [lat, lng] = location.Location ? location.Location.split(" ") : [0, 0];
            
            return {
              ...location,
              Latitude: parseFloat(lat),
              Longitude: parseFloat(lng),
              // Convert ReligiousIdMulti to array
              ReligiousIdArray: location.ReligiousIdMulti ? location.ReligiousIdMulti.split(" ") : []
            };
          });
          
          // Update location map
          locationMap.clear();
          locations.forEach(location => {
            locationMap.set(location.LocationID, location);
          });
          
          // Update markers
          updateMapMarkers();
        }
      });
    }

    // Parse religious CSV data
    function parseReligiousData(csvData) {
      Papa.parse(csvData, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          // Process religious data
          religious = results.data;
          
          // Update religious map
          religiousMap.clear();
          religious.forEach(person => {
            religiousMap.set(person.ReligiousID, person);
          });
          
          // Update markers
          updateMapMarkers();
        }
      });
    }

    // Parse events CSV data
    function parseEventsData(csvData) {
      Papa.parse(csvData, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          // Process events data
          events = results.data;
          
          // Update markers
          updateMapMarkers();
        }
      });
    }

    // Fetch data from Google Sheets
    function fetchSheetData() {
      const sheetId = CONFIG.sheetId;
      const sheets = ["locations", "religious", "events"];
      
      sheets.forEach(sheet => {
        const encodedSheetName = encodeURIComponent(sheet);
        const googleSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
        const corsProxyUrl = `https://corsproxy.io/?${encodeURIComponent(googleSheetUrl)}`;
        
        fetch(corsProxyUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to fetch ${sheet} data: ${response.status}`);
            }
            return response.text();
          })
          .then(csvText => {
            console.log(`Successfully fetched ${sheet} data`);
            
            // Parse CSV based on sheet type
            if (sheet === "locations") {
              parseLocationsData(csvText);
            } else if (sheet === "religious") {
              parseReligiousData(csvText);
            } else if (sheet === "events") {
              parseEventsData(csvText);
            }
          })
          .catch(error => {
            console.error(`Error loading ${sheet} data:`, error);
            console.log(`Using fallback data for ${sheet}`);
          });
      });
    }

    // Update map markers
    function updateMapMarkers() {
      // Clear existing markers and lines
      priestMarkers.clearLayers();
      parishMarkers.clearLayers();
      connectionLines.clearLayers();
      
      // Process locations
      locations.forEach(location => {
        // Create parish marker
        createParishMarker(location);
        
        // Create connection lines between religious and their locations
        createConnectionLines(location);
      });
      
      // Process religious who don't have an assigned location
      religious.forEach(person => {
        const hasLocation = locations.some(location => 
          location.ReligiousIdArray.includes(person.ReligiousID)
        );
        
        if (!hasLocation && person.Location) {
          // Extract coordinates from Location field if available
          const geoMatch = person['Location/Area']?.match(/(-?\d+\.\d+)[,\s]+(-?\d+\.\d+)/);
          if (geoMatch) {
            const lat = parseFloat(geoMatch[1]);
            const lng = parseFloat(geoMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
              createPriestMarker(person, lat, lng);
            }
          } else {
            // Use location approximation based on country/area
            const coords = approximateLocationFromName(person['Location/Area']);
            if (coords) {
              createPriestMarker(person, coords.lat, coords.lng);
            }
          }
        }
      });
    }

    // Create parish marker
    function createParishMarker(location) {
      if (!location.Latitude || !location.Longitude || 
          isNaN(location.Latitude) || isNaN(location.Longitude)) {
        console.warn(`Invalid coordinates for location: ${location.Name}`);
        return;
      }
      
      // Create marker
      const markerSize = CONFIG.parishMarkerSize;
      const icon = L.divIcon({
        className: 'parish-marker',
        html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize/2, markerSize/2]
      });
      
      const marker = L.marker([location.Latitude, location.Longitude], { icon })
        .addTo(parishMarkers);
      
      // Store location data with marker
      marker.locationData = location;
      
      // Add popup with basic info
      marker.bindPopup(`<strong>${location.Name}</strong><br>${location.LocationType}`);
      
      // Add click handler
      marker.on('click', function() {
        showLocationInfo(location);
      });
      
      return marker;
    }

    // Create priest marker
    function createPriestMarker(priest, lat, lng) {
      // Create marker
      const markerSize = CONFIG.priestMarkerSize;
      const icon = L.divIcon({
        className: 'priest-marker pulse',
        html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
        iconSize: [markerSize, markerSize],
        iconAnchor: [markerSize/2, markerSize/2]
      });
      
      const marker = L.marker([lat, lng], { icon })
        .addTo(priestMarkers);
      
      // Store priest data with marker
      marker.priestData = priest;
      
      // Add popup with basic info
      marker.bindPopup(`<strong>${priest.Type} ${priest.Name}</strong>`);
      
      // Add click handler
      marker.on('click', function() {
        showPriestInfo(priest);
      });
      
      return marker;
    }

    // Create connection lines between religious and their locations
    function createConnectionLines(location) {
      if (!location.ReligiousIdArray || !location.Latitude || !location.Longitude) {
        return;
      }
      
      // For each religious person associated with this location
      location.ReligiousIdArray.forEach(religiousId => {
        const person = religiousMap.get(religiousId);
        if (!person) return;
        
        // Find all other locations for this religious person
        locations.forEach(otherLocation => {
          if (otherLocation.LocationID === location.LocationID) return; // Skip self
          
          if (otherLocation.ReligiousIdArray.includes(religiousId)) {
            // Create a curved line between locations
            const latlngs = [
              [location.Latitude, location.Longitude],
              [otherLocation.Latitude, otherLocation.Longitude]
            ];
            
            const line = L.polyline(latlngs, {
              color: CONFIG.lineColor,
              weight: CONFIG.lineWeight,
              opacity: CONFIG.lineOpacity
            }).addTo(connectionLines);
            
            // Store data with the line
            line.religiousId = religiousId;
            line.fromLocation = location.LocationID;
            line.toLocation = otherLocation.LocationID;
          }
        });
        
        // Create priest marker at this location
        createPriestMarker(person, location.Latitude, location.Longitude);
      });
    }

    // Approximate location from country or region name
    function approximateLocationFromName(locationName) {
      if (!locationName) return null;
      
      const locationMap = {
        'England': { lat: 51.5074, lng: -0.1278 },
        'UK': { lat: 51.5074, lng: -0.1278 },
        'USA': { lat: 39.8283, lng: -98.5795 },
        'France': { lat: 46.2276, lng: 2.2137 },
        'Germany': { lat: 51.1657, lng: 10.4515 },
        'Italy': { lat: 41.8719, lng: 12.5674 },
        'Spain': { lat: 40.4637, lng: -3.7492 },
        'Poland': { lat: 51.9194, lng: 19.1451 },
        'Ireland': { lat: 53.1424, lng: -7.6921 },
        'Brazil': { lat: -14.2350, lng: -51.9253 },
        'Argentina': { lat: -38.4161, lng: -63.6167 },
        'Mexico': { lat: 23.6345, lng: -102.5528 },
        'Canada': { lat: 56.1304, lng: -106.3468 },
        'Australia': { lat: -25.2744, lng: 133.7751 },
        'New Zealand': { lat: -40.9006, lng: 174.8860 },
        'Philippines': { lat: 12.8797, lng: 121.7740 },
        'Austria': { lat: 47.5162, lng: 14.5501 },
        'Switzerland': { lat: 46.8182, lng: 8.2275 },
        'Belgium': { lat: 50.5039, lng: 4.4699 },
        'Netherlands': { lat: 52.1326, lng: 5.2913 },
        'Portugal': { lat: 39.3999, lng: -8.2245 },
        'Europe': { lat: 48.8566, lng: 9.3522 }
      };
      
      // Check for direct match
      for (const [key, coords] of Object.entries(locationMap)) {
        if (locationName.includes(key)) {
          return coords;
        }
      }
      
      // Add small random offset to default location to prevent markers from stacking
      return { 
        lat: CONFIG.defaultLat + (Math.random() * 2 - 1), 
        lng: CONFIG.defaultLng + (Math.random() * 2 - 1) 
      };
    }

    // Show location info in the panel
    function showLocationInfo(location) {
      const infoPanel = document.getElementById('infoPanel');
      const priestName = document.getElementById('priestName');
      const priestInfo = document.getElementById('priestInfo');
      
      // Set location name
      priestName.textContent = location.Name;
      
      // Clear previous info
      priestInfo.innerHTML = '';
      
      // Location type
      const typeParagraph = document.createElement('p');
      typeParagraph.className = 'info-paragraph';
      typeParagraph.textContent = `${location.LocationType}`;
      priestInfo.appendChild(typeParagraph);
      
      // Associated religious
      if (location.ReligiousIdArray && location.ReligiousIdArray.length > 0) {
        const religiousParagraph = document.createElement('p');
        religiousParagraph.className = 'info-paragraph';
        religiousParagraph.textContent = "$$SERVED_BY$$: ";
        
        // Add links for each religious person
        location.ReligiousIdArray.forEach((id, index) => {
          const person = religiousMap.get(id);
          if (person) {
            const priestLink = document.createElement('a');
            priestLink.className = 'priest-link';
            priestLink.textContent = `${person.Type} ${person.Name}`;
            priestLink.href = '#';
            priestLink.addEventListener('click', (e) => {
              e.preventDefault();
              showPriestInfo(person);
            });
            
            religiousParagraph.appendChild(priestLink);
            
            // Add comma if not the last person
            if (index < location.ReligiousIdArray.length - 1) {
              religiousParagraph.appendChild(document.createTextNode(', '));
            }
          }
        });
        
        priestInfo.appendChild(religiousParagraph);
      }
      
      // Notes
      if (location.Notes) {
        const notesSection = document.createElement('div');
        notesSection.className = 'notes-section';
        
        const notesTitle = document.createElement('strong');
        notesTitle.textContent = "$$NOTES$$";
        notesSection.appendChild(notesTitle);
        
        const notesContent = document.createElement('p');
        notesContent.textContent = location.Notes;
        notesSection.appendChild(notesContent);
        
        priestInfo.appendChild(notesSection);
      }
      
      // Contact information
      if (location.ContactEmail || location.ContactPhone) {
        const contactParagraph = document.createElement('p');
        contactParagraph.className = 'info-paragraph';
        
        if (location.ContactEmail) {
          contactParagraph.innerHTML += `Email: <a href="mailto:${location.ContactEmail}">${location.ContactEmail}</a><br>`;
        }
        
        if (location.ContactPhone) {
          contactParagraph.innerHTML += `Phone: ${location.ContactPhone}<br>`;
        }
        
        priestInfo.appendChild(contactParagraph);
      }
      
      // Website link
      if (location.Website) {
        const websiteParagraph = document.createElement('p');
        websiteParagraph.className = 'info-paragraph';
        
        // Format website URL for display
        let displayUrl = location.Website.replace(/^https?:\/\//, '');
        displayUrl = displayUrl.split('/')[0]; // Just show the domain
        
        websiteParagraph.innerHTML = `$$WEBSITE$$: <a href="${location.Website}" target="_blank" class="info-link">${displayUrl}</a>`;
        priestInfo.appendChild(websiteParagraph);
      }
      
      // Upcoming events at this location
      const locationEvents = events.filter(event => event.LocationID === location.LocationID);
      if (locationEvents.length > 0) {
        const eventsSection = document.createElement('div');
        eventsSection.className = 'mass-times-section';
        
        const eventsTitle = document.createElement('strong');
        eventsTitle.textContent = "$$MASS_TIMES$$";
        eventsSection.appendChild(eventsTitle);
        
        const eventsList = document.createElement('ul');
        eventsList.className = 'events-list';
        
        // Sort events by date
        locationEvents.sort((a, b) => {
          return new Date(a.StartDate) - new Date(b.StartDate);
        });
        
        locationEvents.forEach(event => {
          const eventItem = document.createElement('li');
          eventItem.className = 'event-item';
          
          // Format date and time
          const startDate = new Date(event.StartDate);
          const formattedDate = startDate.toLocaleDateString(currentLanguage);
          const formattedTime = startDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });
          
          // Get priest name
          const priest = religiousMap.get(event.ReligiousID);
          const priestName = priest ? `${priest.Type} ${priest.Name}` : 'Unknown';
          
          eventItem.innerHTML = `<strong>${event.EventType}</strong>: ${formattedDate} ${formattedTime} - ${priestName}`;
          if (event.Notes) {
            eventItem.innerHTML += `<br><em>${event.Notes}</em>`;
          }
          
          eventsList.appendChild(eventItem);
        });
        
        eventsSection.appendChild(eventsList);
        priestInfo.appendChild(eventsSection);
      }
      
      // Add Google Maps link
      if (location.GoogleMaps) {
        const mapsRow = document.createElement('div');
        mapsRow.className = 'info-row';
        mapsRow.innerHTML = `<a href="${location.GoogleMaps}" target="_blank" class="info-link maps">$$VIEW_ON_MAPS$$</a>`;
        priestInfo.appendChild(mapsRow);
      } else if (location.Latitude && location.Longitude) {
        const mapsRow = document.createElement('div');
        mapsRow.className = 'info-row';
        const mapLink = `https://www.google.com/maps?q=${location.Latitude},${location.Longitude}`;
        mapsRow.innerHTML = `<a href="${mapLink}" target="_blank" class="info-link maps">$$VIEW_ON_MAPS$$</a>`;
        priestInfo.appendChild(mapsRow);
      }
      
      // Show the info panel
      infoPanel.style.display = 'block';
      
      // Fly to location
      map.flyTo([location.Latitude, location.Longitude], 12, {
        animate: true,
        duration: 1.5
      });
      
      // Highlight this location and connected locations
      highlightLocation(location);
    }
    
    // Show priest info in the panel
    function showPriestInfo(priest) {
      const infoPanel = document.getElementById('infoPanel');
      const priestName = document.getElementById('priestName');
      const priestInfo = document.getElementById('priestInfo');
      
      // Set priest name with title
      priestName.textContent = `${priest.Type} ${priest.Name}`;
      
      // Clear previous info
      priestInfo.innerHTML = '';
      
      // Create first paragraph: biographical info
      const bioParagraph = document.createElement('p');
      bioParagraph.className = 'info-paragraph';
      let bioText = '';
      
      // Born year
      if (priest['Born Year']) {
        bioText += `$$BORN$$ ${priest['Born Year']}, `;
      }
      
      // Ordination info
      if (priest['Ordained in Rite'] || priest['Ordained By']) {
        bioText += `$$ORDAINED_PRIEST_IN$$ `;
        if (priest['Ordained in Rite']) {
          bioText += priest['Ordained in Rite'] + ' ';
        }
        if (priest['Ordained By']) {
          bioText += `$$BY$$ ${priest['Ordained By']}, `;
        } else {
          bioText += ', ';
        }
      }
      
      // Consecration info (for bishops)
      if (priest.Type === "Bishop" && (priest['Consecrated in Rite'] || priest['Consecrated By'])) {
        bioText += `$$CONSECRATED_BISHOP_IN$$ `;
        if (priest['Consecrated in Rite']) {
          bioText += priest['Consecrated in Rite'] + ' ';
        }
        if (priest['Consecrated By']) {
          bioText += `$$BY$$ ${priest['Consecrated By']} `;
        }
        
        // Bishop line
        if (priest['Bishop Line']) {
          bioText += `($$BISHOP_LINE$$: ${priest['Bishop Line']})`;
        }
        bioText += '. ';
      } else if (bioText) {
        // End the sentence if it's not empty and not a bishop
        bioText = bioText.replace(/, $/, '. ');
      }
      
      // Location
      if (priest['Location/Area']) {
        bioText += `$$OPERATES_IN$$ ${priest['Location/Area']}`;
      }
      
      // Associates With
      if (priest['Associates With']) {
        if (bioText) bioText += ', ';
        bioText += `$$ASSOCIATES_WITH$$ ${priest['Associates With']}`;
      }
      
      // Beliefs
      if (priest['Beliefs']) {
        if (bioText) bioText += ', ';
        bioText += `${priest['Beliefs']}`;
      }

      // Notes
      if (priest['Notes']) {
        if (bioText) {
          // End the sentence if it's not empty
          bioText += ".";
        }
        
        const notesSection = document.createElement('div');
        notesSection.className = 'notes-section';
        
        const notesTitle = document.createElement('strong');
        notesTitle.textContent = "$$NOTES$$";
        notesSection.appendChild(notesTitle);
        
        const notesContent = document.createElement('p');
        notesContent.textContent = priest['Notes'];
        notesSection.appendChild(notesContent);
        
        bioParagraph.textContent = bioText;
        priestInfo.appendChild(bioParagraph);
        priestInfo.appendChild(notesSection);
      } else {
        // Only add the paragraph if we have bio info
        if (bioText) {
          bioText += '. ';
          bioParagraph.textContent = bioText;
          priestInfo.appendChild(bioParagraph);
        }
      }

      // Contact/Website as a clickable link if present
      if (priest['Contact/Website']) {
        const contactRow = document.createElement('p');
        contactRow.className = 'info-paragraph';
        
        if (priest['Contact/Website'].startsWith('http')) {
          let niceurl = priest['Contact/Website'].replace(/^https?:\/\//, "");
          contactRow.innerHTML = `$$WEBSITE$$: <a href="${priest['Contact/Website']}" target="_blank" class="info-link">${niceurl}</a>`;
        } else {
          contactRow.innerHTML = `$$CONTACT$$: ${priest['Contact/Website']}`;
        }
        
        priestInfo.appendChild(contactRow);
      }

      // Add locations served section
      const priestLocations = locations.filter(location => 
        location.ReligiousIdArray && location.ReligiousIdArray.includes(priest.ReligiousID)
      );
      
      if (priestLocations.length > 0) {
        const locationsSection = document.createElement('div');
        locationsSection.className = 'parishes-section';
        
        // Add section title
        const locationsTitle = document.createElement('h3');
        locationsTitle.textContent = "$$PARISHES_SERVED$$";
        locationsSection.appendChild(locationsTitle);
        
        const locationsList = document.createElement('ul');
        locationsList.className = 'parishes-list';
        
        // Sort locations alphabetically
        priestLocations.sort((a, b) => a.Name.localeCompare(b.Name));
        
        priestLocations.forEach(location => {
          const locationItem = document.createElement('li');
          locationItem.className = 'parish-item';
          
          locationItem.innerHTML = `<strong>${location.Name}:</strong> ${location.LocationType}`;
          
          // Add click handler to highlight this location
          locationItem.style.cursor = 'pointer';
          locationItem.addEventListener('click', () => {
            showLocationInfo(location);
          });
          
          locationsList.appendChild(locationItem);
        });
        
        locationsSection.appendChild(locationsList);
        priestInfo.appendChild(locationsSection);
      }
      
      // Show the info panel
      infoPanel.style.display = 'block';
      
      // Find primary location for this priest
      let primaryLocation = priestLocations[0];
      if (priestLocations.length > 0) {
        // Fly to location
        map.flyTo([primaryLocation.Latitude, primaryLocation.Longitude], 8, {
          animate: true,
          duration: 1.5
        });
      }
      
      // Highlight this priest's locations
      highlightPriest(priest);
    }
    
    // Highlight location and its connections
    function highlightLocation(location) {
      // Reset all markers
      resetAllMarkers();
      
      // Highlight this location's marker
      parishMarkers.eachLayer(marker => {
        if (marker.locationData && marker.locationData.LocationID === location.LocationID) {
          // Create highlighted marker
          const markerSize = CONFIG.parishMarkerSize * 1.5;
          const icon = L.divIcon({
            className: 'parish-marker',
            html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerSize/2, markerSize/2]
          });
          marker.setIcon(icon);
        }
      });
      
      // Highlight associated religious
      if (location.ReligiousIdArray && location.ReligiousIdArray.length > 0) {
        location.ReligiousIdArray.forEach(religiousId => {
          priestMarkers.eachLayer(marker => {
            if (marker.priestData && marker.priestData.ReligiousID === religiousId) {
              // Create highlighted marker
              const markerSize = CONFIG.priestMarkerSize * 1.5;
              const icon = L.divIcon({
                className: 'priest-marker pulse',
                html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
                iconSize: [markerSize, markerSize],
                iconAnchor: [markerSize/2, markerSize/2]
              });
              marker.setIcon(icon);
            }
          });
        });
        
        // Highlight connection lines
        connectionLines.eachLayer(line => {
          if (line.fromLocation === location.LocationID || line.toLocation === location.LocationID) {
            line.setStyle({
              color: 'yellow',
              weight: CONFIG.lineWeight * 1.5,
              opacity: 1.0
            });
          }
        });
      }
    }
    
    // Highlight priest's locations
    function highlightPriest(priest) {
      // Reset all markers
      resetAllMarkers();
      
      // Highlight priest's marker
      priestMarkers.eachLayer(marker => {
        if (marker.priestData && marker.priestData.ReligiousID === priest.ReligiousID) {
          // Create highlighted marker
          const markerSize = CONFIG.priestMarkerSize * 1.5;
          const icon = L.divIcon({
            className: 'priest-marker pulse',
            html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerSize/2, markerSize/2]
          });
          marker.setIcon(icon);
        }
      });
      
      // Highlight priest's locations
      parishMarkers.eachLayer(marker => {
        if (marker.locationData && marker.locationData.ReligiousIdArray && 
            marker.locationData.ReligiousIdArray.includes(priest.ReligiousID)) {
          // Create highlighted marker
          const markerSize = CONFIG.parishMarkerSize * 1.5;
          const icon = L.divIcon({
            className: 'parish-marker',
            html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: #00cc00;"></div>`,
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerSize/2, markerSize/2]
          });
          marker.setIcon(icon);
        }
      });
      
      // Highlight connection lines
      connectionLines.eachLayer(line => {
        if (line.religiousId === priest.ReligiousID) {
          line.setStyle({
            color: '#00cc00',
            weight: CONFIG.lineWeight * 1.5,
            opacity: 1.0
          });
        }
      });
    }
    
    // Reset all markers to their default style
    function resetAllMarkers() {
      // Reset parish markers
      parishMarkers.eachLayer(marker => {
        const markerSize = CONFIG.parishMarkerSize;
        const icon = L.divIcon({
          className: 'parish-marker',
          html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize/2, markerSize/2]
        });
        marker.setIcon(icon);
      });
      
      // Reset priest markers
      priestMarkers.eachLayer(marker => {
        const markerSize = CONFIG.priestMarkerSize;
        const icon = L.divIcon({
          className: 'priest-marker pulse',
          html: `<div style="width:${markerSize}px; height:${markerSize}px;"></div>`,
          iconSize: [markerSize, markerSize],
          iconAnchor: [markerSize/2, markerSize/2]
        });
        marker.setIcon(icon);
      });
      
      // Reset connection lines
      connectionLines.eachLayer(line => {
        line.setStyle({
          color: CONFIG.lineColor,
          weight: CONFIG.lineWeight,
          opacity: CONFIG.lineOpacity
        });
      });
    }

    // Handle search input
    function handleSearch(event) {
      const searchTerm = event.target.value.toLowerCase();
      const searchResultsContainer = document.getElementById('searchResults');
      
      // Reset search results
      searchResultsContainer.innerHTML = '';
      
      if (searchTerm.length < 2) {
        searchResultsContainer.style.display = 'none';
        resetAllMarkers();
        return;
      }
      
      // Filter locations and religious based on search term
      const matchingLocations = locations.filter(location => 
        location.Name.toLowerCase().includes(searchTerm) || 
        location.LocationType.toLowerCase().includes(searchTerm) ||
        (location.Notes && location.Notes.toLowerCase().includes(searchTerm))
      );
      
      const matchingReligious = religious.filter(person => 
        person.Name.toLowerCase().includes(searchTerm) || 
        person.Type.toLowerCase().includes(searchTerm) ||
        (person['Location/Area'] && person['Location/Area'].toLowerCase().includes(searchTerm)) ||
        (person.Notes && person.Notes.toLowerCase().includes(searchTerm))
      );
      
      // Highlight matching markers
      resetAllMarkers();
      
      // Highlight matching locations
      matchingLocations.forEach(location => {
        parishMarkers.eachLayer(marker => {
          if (marker.locationData && marker.locationData.LocationID === location.LocationID) {
            const markerSize = CONFIG.parishMarkerSize * 1.5;
            const icon = L.divIcon({
              className: 'parish-marker',
              html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
              iconSize: [markerSize, markerSize],
              iconAnchor: [markerSize/2, markerSize/2]
            });
            marker.setIcon(icon);
          }
        });
      });
      
      // Highlight matching religious
      matchingReligious.forEach(person => {
        priestMarkers.eachLayer(marker => {
          if (marker.priestData && marker.priestData.ReligiousID === person.ReligiousID) {
            const markerSize = CONFIG.priestMarkerSize * 1.5;
            const icon = L.divIcon({
              className: 'priest-marker pulse',
              html: `<div style="width:${markerSize}px; height:${markerSize}px; background-color: yellow;"></div>`,
              iconSize: [markerSize, markerSize],
              iconAnchor: [markerSize/2, markerSize/2]
            });
            marker.setIcon(icon);
          }
        });
      });
      
      // Create combined results
      const combinedResults = [
        ...matchingReligious.map(person => ({ 
          type: 'religious', 
          data: person, 
          title: `${person.Type} ${person.Name}`
        })),
        ...matchingLocations.map(location => ({ 
          type: 'location', 
          data: location, 
          title: `${location.Name} (${location.LocationType})`
        }))
      ];
      
      // Display search results
      if (combinedResults.length > 0) {
        combinedResults.forEach(result => {
          const resultItem = document.createElement('div');
          resultItem.className = 'search-result-item';
          resultItem.textContent = result.title;
          
          resultItem.addEventListener('click', () => {
            if (result.type === 'religious') {
              showPriestInfo(result.data);
            } else {
              showLocationInfo(result.data);
            }
            
            // Clear search
            document.getElementById('searchInput').value = '';
            searchResultsContainer.style.display = 'none';
          });
          
          searchResultsContainer.appendChild(resultItem);
        });
        
        searchResultsContainer.style.display = 'block';
      } else {
        searchResultsContainer.style.display = 'none';
      }
    }

    // Try to get user's location
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          // Success
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Center map on user's location
            map.setView([lat, lng], 8);
            
            // Add a marker for user's location
            const userIcon = L.divIcon({
              className: 'user-marker',
              html: `<div style="width:12px; height:12px; background-color: blue; border-radius: 50%; border: 2px solid white;"></div>`,
              iconSize: [12, 12],
              iconAnchor: [6, 6]
            });
            
            L.marker([lat, lng], { icon: userIcon })
              .addTo(map)
              .bindPopup("$$YOUR_LOCATION$$");
          },
          // Error
          (error) => {
            console.warn(`Geolocation error: ${error.message}`);
            // Use default location
            centerOnLanguage();
          }
        );
      } else {
        console.warn("Geolocation not supported by this browser");
        // Use default location
        centerOnLanguage();
      }
    }

    // Center map based on language
    function centerOnLanguage() {
      const languageMap = {
        'en': { lat: 51.5074, lng: -0.1278, zoom: 5 },  // London
        'de': { lat: 51.1657, lng: 10.4515, zoom: 5 },  // Germany
        'fr': { lat: 46.2276, lng: 2.2137, zoom: 5 },   // France
        'it': { lat: 41.8719, lng: 12.5674, zoom: 5 },  // Italy
        'es': { lat: 40.4168, lng: -3.7038, zoom: 5 },  // Spain
        'pl': { lat: 51.9194, lng: 19.1451, zoom: 5 },  // Poland
        'pt': { lat: -14.2350, lng: -51.9253, zoom: 4 }, // Brazil
        'ro': { lat: 45.9443, lng: 25.0094, zoom: 5 },  // Romania
        'ru': { lat: 55.7558, lng: 37.6173, zoom: 4 },  // Russia
        'tr': { lat: 38.9637, lng: 35.2433, zoom: 5 },  // Turkey
        'el': { lat: 37.9838, lng: 23.7275, zoom: 5 },  // Greece
        'ar': { lat: 23.8859, lng: 45.0792, zoom: 4 },  // Saudi Arabia
        'tl': { lat: 12.8797, lng: 121.7740, zoom: 5 }, // Philippines
        'zh': { lat: 35.8617, lng: 104.1954, zoom: 4 }, // China
        'ko': { lat: 35.9078, lng: 127.7669, zoom: 6 }, // South Korea
        'ja': { lat: 36.2048, lng: 138.2529, zoom: 5 }  // Japan
      };
      
      const center = languageMap[currentLanguage] || languageMap['en'];
      map.setView([center.lat, center.lng], center.zoom);
    }
  </script>
</body>
</html>
